<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Calificaciones - Grupos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- PDF & Image Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg-color: #ffffff;
            --header-bg-color: #4b5563;
            --sticky-col-bg: #f9fafb;
            --border-color: #e5e7eb;
            --input-border-color: #d1d5db;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --tab-block-bg: #f1f5f9;
            --tab-button-bg: #e2e8f0;
            --tab-button-text: #475569;
            --row-selected-bg: #dbeafe;
        }

        html.dark {
            --bg-color: #1f2937;
            --text-color: #f3f4f6;
            --card-bg-color: #374151;
            --header-bg-color: #111827;
            --sticky-col-bg: #4b5563;
            --border-color: #4b5563;
            --input-border-color: #6b7280;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --tab-block-bg: #4b5563;
            --tab-button-bg: #64748b;
            --tab-button-text: #e2e8f0;
            --row-selected-bg: #1e3a8a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            width: 100%;
            max-width: 95%;
            margin: auto;
            background-color: var(--card-bg-color);
            box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color);
        }
        .table-container {
            max-height: 75vh;
            overflow: auto;
            border-radius: 0.5rem;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            padding: 0.75rem;
            text-align: center;
            font-size: 0.875rem;
            white-space: nowrap;
            background-color: var(--card-bg-color);
        }
        td, thead tr:last-child th {
            border-bottom: 1px solid var(--border-color);
        }
        thead tr:first-child th {
            border-bottom: 1px solid var(--header-bg-color);
        }
        tr:last-child td { border-bottom: none; }

        /* --- STICKY & COLUMN STYLES --- */
        thead th {
            position: sticky; top: 0;
            background-color: var(--header-bg-color);
            color: #ffffff; z-index: 20;
            vertical-align: middle; height: 70px;
        }
        thead tr:nth-child(2) th { top: 70px; }
        .sticky-left { position: sticky; left: 0; box-shadow: 2px 0 5px -2px var(--shadow-color); }
        th.sticky-left { z-index: 22; background-color: var(--header-bg-color); }
        td.sticky-left { z-index: 21; background-color: var(--sticky-col-bg); }

        .sticky-col-no { left: 0; width: 50px; min-width: 50px; }
        .sticky-col-name { left: 50px; width: 220px; min-width: 220px; text-align: left; }
        .sticky-col-actions { left: 270px; width: 100px; min-width: 100px; }
        .sticky-col-summary { left: 370px; width: 120px; min-width: 120px; }
        
        /* Row Selection Highlight */
        tbody tr:hover > td, tbody tr:hover > .sticky-left {
            background-color: var(--sticky-col-bg);
        }
        tr.row-selected > td {
            background-color: var(--row-selected-bg);
        }
        tr.row-selected > td.sticky-left {
            background-color: var(--row-selected-bg);
        }


        /* --- Grade & Input Styles --- */
        .grade-cell { 
            width: 70px; 
            min-width: 70px; 
            cursor: pointer;
            position: relative;
        }
        .grade-input { width: 100%; padding: 0.25rem; border: 1px solid var(--input-border-color); border-radius: 0.25rem; text-align: center; background-color: var(--card-bg-color); color: var(--text-color); }
        .col-def, .col-nivel { width: 80px; min-width: 80px; font-weight: bold; }

        /* Performance Level Colors */
        .nivel-bajo { background-color: #fee2e2; color: #991b1b; }
        .nivel-basico { background-color: #fef9c3; color: #854d0e; }
        .nivel-alto { background-color: #dcfce7; color: #166534; }
        .nivel-superior { background-color: #dbeafe; color: #1e40af; }
        html.dark .nivel-bajo { background-color: #7f1d1d; color: #fecaca; }
        html.dark .nivel-basico { background-color: #713f12; color: #fef08a; }
        html.dark .nivel-alto { background-color: #14532d; color: #bbf7d0; }
        html.dark .nivel-superior { background-color: #1e3a8a; color: #bfdbfe; }
        tr.row-selected .nivel-bajo, tr.row-selected .nivel-basico, tr.row-selected .nivel-alto, tr.row-selected .nivel-superior {
            color: var(--text-color); /* Ensure text is readable when row is selected */
        }


        /* --- Attendance Styles --- */
        .attendance-box {
            cursor: pointer; width: 28px; height: 28px; border: 1px solid var(--input-border-color);
            border-radius: 0.375rem; display: flex; align-items: center; justify-content: center;
            margin: auto; font-size: 1.1rem; font-weight: bold; line-height: 1; transition: all 0.2s ease-in-out;
        }
        .attendance-box.attended { background-color: #dcfce7; color: #16a34a; border-color: #16a34a; }
        .attendance-box.absent { background-color: #fee2e2; color: #ef4444; border-color: #ef4444; }
        .date-header { vertical-align: bottom; padding: 0.25rem; }
        .date-header div { transform: rotate(-90deg); white-space: nowrap; display: block; width: 30px; margin: 0 auto 25px auto; }
        td.attendance-cell { width: 60px; min-width: 60px; }
        .attendance-bulk-btn { font-size: 0.75rem; padding: 2px 4px; border-radius: 4px; margin: 1px 0; display: block; width: 100%; border: 1px solid #fff; }

        /* --- UI Elements --- */
        .controls-container { display: flex; flex-direction: column; align-items: stretch; sm:flex-row; sm:justify-between; sm:items-center; gap: 1rem; margin-bottom: 1.5rem; }
        .search-box { padding: 0.5rem; border: 1px solid var(--input-border-color); border-radius: 0.5rem; background-color: var(--card-bg-color); width: 100%; sm:w-auto; }
        .action-button { background-color: #4b5563; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; text-align: center; }
        .action-button:hover { background-color: #374151; }
        html.dark .action-button { background-color: #1f2937; }
        html.dark .action-button:hover { background-color: #111827; }
        .button-group { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }

        /* Dark Mode Toggle */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Tab Navigation Styles */
        .daily-schedule-container { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1.5rem; }
        .daily-group-block { background-color: var(--tab-block-bg); border-radius: 0.75rem; padding: 0.75rem; box-shadow: 0 1px 3px 0 var(--shadow-color); }
        .daily-group-title { font-weight: 600; text-align: center; margin-bottom: 0.5rem; color: var(--text-color); }
        .group-buttons-wrapper { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
        .tab-button { padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease; cursor: pointer; background-color: var(--tab-button-bg); color: var(--tab-button-text); }
        .tab-button.active { background-color: #3b82f6; color: #ffffff; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--card-bg-color); padding: 2rem; border-radius: 0.75rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-content textarea { width: 100%; min-height: 150px; border: 1px solid var(--input-border-color); border-radius: 0.5rem; padding: 0.5rem; background-color: var(--bg-color); color: var(--text-color); }
        .bulletin-content { border: 1px solid var(--border-color); padding: 1.5rem; }
        
        /* Stats Panel */
        .stats-panel { display: flex; justify-content: space-around; flex-wrap: wrap; background-color: var(--bg-color); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
        .stat-item { text-align: center; }

        /* Action Icons in Table */
        .action-icon { cursor: pointer; margin: 0 0.25rem; font-size: 1rem; transition: color 0.2s; }
        .action-icon:hover { color: #3b82f6; }
        .action-icon.has-obs { color: #f59e0b; } /* Amber color for observation icon */
        .action-icon.has-obs:hover { color: #d97706; }
        
        /* Custom Tooltip */
        #customTooltip {
            pointer-events: none; /* Make sure the tooltip doesn't interfere with mouse events */
            background-color: var(--header-bg-color);
            color: #ffffff;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px var(--shadow-color);
            max-width: 250px;
            word-wrap: break-word;
            z-index: 150;
        }

        /* --- Responsive Design for Mobile & Tablet --- */
        .action-grades-btn { display: none; } /* Oculto por defecto */
        
        @media (max-width: 1024px) { 
            .grade-column { display: none; } /* Oculta columnas de notas en pantallas pequeñas */
            .action-grades-btn { display: inline-block; } /* Muestra el botón de editar notas */
        }

        .bulletin-page {
             background-color: white;
             color: black;
        }

        .bulletin-page * {
             color: black !important;
        }

    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="container rounded-xl p-4 sm:p-8 mt-4">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6">Control de Calificaciones y Asistencia</h1>
        <div id="tabNavigation" class="daily-schedule-container"></div>
        <h2 id="courseTitle" class="text-2xl font-bold text-center mb-2"></h2>
        <div id="courseInfo" class="text-center text-gray-500 dark:text-gray-400 mb-4"></div>

        <!-- Controls -->
        <div class="controls-container">
            <input type="text" id="searchBox" class="search-box" placeholder="Buscar estudiante...">
            <div class="flex items-center justify-between w-full sm:w-auto gap-4">
                <div class="button-group">
                    <button id="bulletinBtn" class="action-button"><i class="fas fa-id-card mr-2"></i>Boletines</button>
                    <button id="exportBtn" class="action-button"><i class="fas fa-file-csv mr-2"></i>Exportar</button>
                    <button id="importBtn" class="action-button"><i class="fas fa-upload mr-2"></i>Importar</button>
                    <input type="file" id="importFile" class="hidden" accept=".txt">
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Stats Panel -->
        <div id="statsPanel" class="stats-panel"></div>
        
        <!-- Table -->
        <div id="attendanceTableContainer" class="table-container"></div>
        
        <!-- Modals -->
        <div id="obsModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Observaciones para <span id="obsStudentName"></span></h3>
                <div id="obsHistory" class="mb-4 p-2 border rounded max-h-48 overflow-y-auto" style="border-color: var(--input-border-color);">
                    <!-- History will be populated by JS -->
                </div>
                <textarea id="obsTextarea" placeholder="Añadir nueva observación..."></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeObsModal" class="action-button">Cerrar</button>
                    <button id="saveObs" class="action-button bg-blue-600">Añadir Observación</button>
                </div>
            </div>
        </div>

        <div id="dateNoteModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Anotación para la fecha: <span id="dateNoteDate"></span></h3>
                <textarea id="dateNoteTextarea" placeholder="Añadir un evento o nota para este día (ej. Examen, Salida pedagógica)..."></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeDateNoteModal" class="action-button">Cerrar</button>
                    <button id="saveDateNote" class="action-button bg-blue-600">Guardar</button>
                </div>
            </div>
        </div>

        <div id="gradeNoteModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Comentario para <span id="gradeNoteTitle"></span></h3>
                <textarea id="gradeNoteTextarea"></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeGradeNoteModal" class="action-button">Cerrar</button>
                    <button id="saveGradeNote" class="action-button bg-blue-600">Guardar</button>
                </div>
            </div>
        </div>

        <div id="deleteConfirmModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Confirmar Borrado</h3>
                <p class="mb-4">Para borrar esta observación, por favor ingresa la clave de seguridad.</p>
                <input type="password" id="deletePasswordInput" class="search-box w-full" placeholder="Clave de seguridad...">
                <div id="deleteErrorMsg" class="text-red-500 text-sm mt-2 hidden">Clave incorrecta.</div>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeDeleteConfirmModal" class="action-button">Cancelar</button>
                    <button id="confirmDeleteBtn" class="action-button bg-red-600">Confirmar Borrado</button>
                </div>
            </div>
        </div>

        <div id="bulletinModal" class="modal-overlay">
            <div class="modal-content">
                <div id="bulletinContent">
                    <!-- Content will be generated by JS -->
                </div>
                 <div class="flex justify-end gap-2 mt-4">
                    <button id="closeBulletinModal" class="action-button">Cerrar</button>
                    <button id="downloadPngBtn" class="action-button bg-green-600"><i class="fas fa-file-image"></i> PNG</button>
                    <button id="downloadPdfBtn" class="action-button bg-red-600"><i class="fas fa-file-pdf"></i> PDF</button>
                </div>
            </div>
        </div>
        
        <div id="exportModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Opciones de Exportación</h3>
                <div class="flex flex-col gap-4">
                    <button id="exportCurrentBtn" class="action-button w-full">Exportar Curso Actual</button>
                    <button id="exportAllBtn" class="action-button w-full">Exportar Todos los Cursos</button>
                    <div>
                        <h4 class="font-semibold mb-2 text-left">Selección Personalizada:</h4>
                        <div id="courseSelectionCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-48 overflow-y-auto p-2 border rounded" style="border-color: var(--input-border-color);">
                            <!-- Checkboxes will be inserted here by JS -->
                        </div>
                        <button id="exportSelectedBtn" class="action-button w-full mt-4">Exportar Selección</button>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                     <button id="closeExportModal" class="action-button">Cerrar</button>
                </div>
            </div>
        </div>


        <div id="gradesModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Notas para <span id="gradesStudentName"></span></h3>
                <div id="gradesGrid" class="grid grid-cols-3 gap-x-4 gap-y-2"></div>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeGradesModal" class="action-button">Cerrar</button>
                    <button id="saveGrades" class="action-button bg-blue-600">Guardar</button>
                </div>
            </div>
        </div>
        
        <div id="bulletinSelectionModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Generar Boletines en PDF</h3>
                <div class="flex flex-col gap-4">
                    <!-- Option 1: All Courses -->
                    <button id="generateAllCoursesBulletinBtn" class="action-button w-full">Generar PDF de Todos los Cursos</button>
                    
                    <!-- Option 2: Current Course -->
                    <button id="generateCurrentCourseBulletinBtn" class="action-button w-full">Generar PDF del Curso Actual</button>
                    
                    <!-- Option 3: Selected Courses -->
                    <div>
                        <h4 class="font-semibold mb-2 text-left">Selección por Cursos:</h4>
                        <div id="bulletinCourseSelectionCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-48 overflow-y-auto p-2 border rounded" style="border-color: var(--input-border-color);">
                            <!-- Course checkboxes will be inserted here by JS -->
                        </div>
                        <button id="generateSelectedCoursesBtn" class="action-button w-full mt-4">Generar PDF de Cursos Seleccionados</button>
                    </div>

                    <!-- Option 4: Selected Students in Current Course -->
                    <div>
                        <h4 class="font-semibold mb-2 text-left">Selección por Estudiantes (Curso Actual):</h4>
                        <div class="flex justify-between items-center mb-2">
                             <button id="selectAllStudentsBtn" class="text-sm text-blue-500 hover:underline">Seleccionar Todos</button>
                             <button id="deselectAllStudentsBtn" class="text-sm text-blue-500 hover:underline">Deseleccionar Todos</button>
                        </div>
                        <div id="studentSelectionCheckboxes" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-48 overflow-y-auto p-2 border rounded" style="border-color: var(--input-border-color);">
                            <!-- Student checkboxes will be inserted here -->
                        </div>
                        <button id="generateSelectedStudentsBtn" class="action-button w-full mt-4">Generar PDF de Estudiantes Seleccionados</button>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                     <button id="closeBulletinSelectionModal" class="action-button">Cerrar</button>
                </div>
            </div>
        </div>

        <div class="w-full text-center mt-8 text-sm text-gray-500">Diseñado por Juan Miguel Ríos Redondo</div>
    </div>

    <div id="customTooltip" class="hidden absolute p-2 text-sm rounded-md shadow-lg max-w-xs whitespace-normal"></div>

    <script>
        // UI Elements
        const tableContainer = document.getElementById('attendanceTableContainer');
        const courseTitle = document.getElementById('courseTitle');
        const courseInfo = document.getElementById('courseInfo');
        const tabNavigation = document.getElementById('tabNavigation');
        const searchBox = document.getElementById('searchBox');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const statsPanel = document.getElementById('statsPanel');
        const obsModal = document.getElementById('obsModal');
        const dateNoteModal = document.getElementById('dateNoteModal');
        const gradeNoteModal = document.getElementById('gradeNoteModal');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const bulletinModal = document.getElementById('bulletinModal');
        const exportModal = document.getElementById('exportModal');
        const gradesModal = document.getElementById('gradesModal');
        const gradesStudentName = document.getElementById('gradesStudentName');
        const gradesGrid = document.getElementById('gradesGrid');
        const bulletinBtn = document.getElementById('bulletinBtn');
        const bulletinSelectionModal = document.getElementById('bulletinSelectionModal');


        // App State
        const dailySchedule = {'Lunes':['8C','9B'],'Martes':['8A','9C','11A','11B'],'Miércoles':['8B','9A'],'Jueves':['10C','11C','11D'],'Viernes':['8D','9D','7D']};
        const dayNameToNumber = { 'Lunes': 1, 'Martes': 2, 'Miércoles': 3, 'Jueves': 4, 'Viernes': 5 };
        let activeCourse; 
        let gradesData = {};
        const allStudentsData = {
            '7D':["AHUMADA SIERRA THAEL SOFIA","AMARIS SIERRA JULEISY PAOLA","BENITEZ BOSSIO MARIA JOSE","BOLIVAR GOMEZ MARIA JOSE","CABALLERO SILVERA JOHELIS ANA","CARMONA SILVERA LEYNER LEONARDO","CARPINTERO SILVERA THALIA","CONSUEGRA ALVAREZ JHOINER DAVID","ESCORCIA RIVALDO CAMILO ANDRES","GERONIMO BARRAZA HELLEN SOFIA","GOEZ OTERO DANIEL JOSE","GONZALEZ BARRAZA DANNA SOFIA","GUANIPA GUTIERREZ ARANZA","GUTIERREZ OJEDA EMMANUEL","HERNANDEZ DIAZ JESUS DAVID","LLANOS SEGURA YAILETH PATRICIA","MARIN PALMA SANTIAGO","MARMOL HERNANDEZ SEBASTIAN ANDRES","NAVAS CEDEÑO ANGEL ALBERTO","NIETO ROLONG MARY ISABEL","ORTEGA BENITEZ IVIAN ALEJANDRA","ORTEGA MANGA ANGELLYS ISABEL","PATIÑO BORRERO HARRISON DANIEL","PEREZ ALVAREZ MARIA JOSE","PEREZ NATERA VALENTINA SOFIA","PIMIENTA OTERO LAURENS JULIANA","POLO REDONDO MARIA GUADALUPE","PRADA SARMIENTO BRAYAN JOSE","SANTIAGO DACONTE ANDRES FELIPE","SIERRA CASTILLO MAURICIO JOSE","SIERRA GOMEZ LIZETH PAOLA","SMITH SANTIAGO VALERIA","SUAREZ GALLARDO MATEO JUSETH","TORRES FERNANDEZ SANTIAGO ENRIQUE","ZARATE REDONDO YAJAIRA NICOLL"],
            '8A':["ARIZA CONSUEGRA STEISY SOFÍA","BARRAZA HERNANDEZ RONALD ALFREDO","BARRIOS MOLINA LITZY MARIELL","BECERRA CRESPO MANOLO","BELLIDO CASIANO LEIDER JOSE","BERRUEZO ORTEGA SAMANTHA ISABEL","BLANCO REYES ANGEL RAFAEL","BOLIVAR ESCOBAR VALENTINA SARETH","CIRO ROMERO ANGELA SOFIA","DE LA CRUZ SIERRA ALAN DAVID","DITA ESCALANTE GILMAR JOSE","ESCALANTE OSPINO ANDERSON CAMILO","ESCOBAR ALGARIN LILIANA","GOMEZ VILLA ANA VALERIA","GUTIERREZ PAEZ ANA MILENA","JIMÉNEZ QUINTANA FREDDY DAVID","JIMENEZ RUA NASLI DANIELA","LLANOS REDONDO ADRIANA MICHELL","LLANOS REYES ANDRES FELIPE","MARQUEZ MARIN VALERIN VALENTina","MARQUEZ VILORIA EMILY SOFÍA","MARTINEZ ORTEGA JESUS MANUEL","MOLINA GUTIERREZ JULIE PAOLA","ORDOÑEZ GARCIA LEONARDO ENRIQUE","PACHECO AVILA MARIA ANGEL","PEREZ ARAUJO ANDRÉS CAMILO","REDONDO PATIÑO DELEVIS ENRIQUE","RODRIGUEZ SANJUAN SALOME","SANTIAGO JULIO ASLY PAOLA","SIERRA GOMEZ LUISA FERNANDA","SILVERA GOMEZ GABRIEL","SILVERA ORTEGA MAYLER JESHUA","TEJERA ORTEGA LUIS MARIO","VANEGAS DE LA CRUZ DANIELA ANDREA","VEGA ORTIZ EYEELIN LORENA","VELASQUEZ GARCIA MANUEL ALEJANDRO"],
            '8B':["ACOSTA NATERA JAVITH DE JESUS","AREVALO ARCON JOSE DAVID","BARRETO ROLONG MARIANA SOFIA","BARRIOS PUENTES BLAYNER ESTEBAN","BULA PEREZ MARIA LUISA","BUSTOS BARRIOS HONEY SOPHIA","CASTRO CASTRO DASHARY MICHELL","CASTRO HARO JEAN LUCAS","CONTRERAS SANJUAN IVANNA MICHELL","CORREDOR BARBOSA SAMUEL ARTURO","COTES ESCALANTE YESID ANDRES","GARCIA VARELA SHADAY VALENTINA","GONZALEZ SILVERA LILIBETH ISABEL","HEREDIA LOPEZ EYLIN PAOLA","HERNANDEZ DE LA CRUZ MIGUEL ANGEL","HERNANDEZ LLANOS GUADALUPE MARIA","HERNANDEZ LLANOS JESE DAVID","HERRERA POLO LINA MILAGROS","JAIME ROA ANYELO JAVIER","LINARES ESTEVEZ MAYTE ALEJANDRA","LUQUE GONZALEZ YANKELIS ESTEFANIA","MONSALVO QUINTERO ADRIAN ANDRES","MONTERROSA CABALLERO LAURA VANESA","NORIEGA REDONDO WENDY PAOLA","POLO JIMENEZ NORELLA MARÍA","RADA GUTIERREZ AISHA MARIETT","REDONDO FRANCO LUIS ANGEL","RINCON PEREZ ANGIELIN ORIANA","SALAZAR ZAMBRANO RICHARD JOSE","SIERRA OROZCO ANGGY PAOLA","SILVERA ESCOBAR DAYAR AMETH","SILVERA JIMENEZ NICOLL DAYANA","SILVERA SANJUAN ADALYANA ISABEL","SOSA BERRIO DEICY JULIETH","SUAREZ DURAN JOSTIN DE JESUS","TOMASES RADA THIAGO ANDRES","URANGO PACHECO DEILER JOSEPH","VILLAMIL HERNANDEZ XIMENA ESTER"],
            '8C':["ACOSTA CAICEDO DAIMAR DE JESUS","ACUÑA VALENCIA LUIS ALEJANDRO","ARAUJO MENDOZA SIRIANA VALENTINA","BANDERA LLANOS SHAILETH VALENTINA","BURGUILLOS CARBONELL JHOSNIEL SAID","CARDENAS CHIQUILLO MICHAELL MANUEL","CASTRO GOMEZ SHERIL NICOLLE","CERVANTES LARA MAURO DE JESUS","DE LA CRUZ PIÑERES SERGIO ANDRES","DE LA CRUZ REDONDO ANTONY RICARDO","DE LA HOZ CABAS YEFFER DE JESUS","ESCORCIA MIRANDA GUADALUPE","FERRER SANTANDER DAMIAN CAMILO","GARCIA PEÑATE MARIA DEL CARMEN","GARCIA ROJAS TIFFANY DAYANA","GOMEZ OTERO JANNIER FARID","GONZALEZ SALCEDO MARIA DE LOS ANGELES","HURTADO ORTIZ ALAN DAVIDSON","LLANOS TAGUER BRANDON DE JESUS","MADERA ORTEGA ANA PAULA","MEZA SIERRA JAMES DE JESUS","MORALES PERCY KEREN SOFIA","OLANO PAZ YARIANGEL CHICHINQUIRA","ORTEGA SIERRA VALENTINA MISHEL","PEREZ GONZALEZ SHAIRA LUCIA","PEREZ NAVAS VALENTINA NICOLLE","POLO GUERRA XAVIER JOSUE","RADA CORRO STEPHANIE SOFIA","RANGEL SIERRA LAUREN SOFIA","RICO ZAPATA DANNA SOFIA","RIVALDO PALMA MILAGRO DE JESUS","RIVALDO PALMA TANIA ISABEL","ROSANIA MINDIOLA DIEGO DAVID","SARMIENTO MARTINEZ MARI ANGEL","SILVA SILVERA SOFIA ISABEL","SILVERA CERVANTES MILTON DE JESUS","TRIGOS OROZCO SHELSY SOFIA"],
            '8D':["ALVAREZ GOMEZ ANA SOFIA", "BARRIOS ORTIZ CARLOS DAVID", "CASTILLO PEREZ LAURA VALENTINA", "DIAZ RODRIGUEZ JUAN ESTEBAN", "FERNANDEZ MORA ISABELLA", "GARCIA LOPEZ MATEO", "HERNANDEZ JIMENEZ SOFIA", "LOPEZ MARTINEZ DANIEL ALEJANDRO", "MARTINEZ NUÑEZ VALERIA", "MENDOZA RAMIREZ SANTIAGO", "MORENO VARGAS GABRIELA", "ORTIZ CASTRO SEBASTIAN", "PEREZ GONZALEZ CAMILA", "RAMIREZ DIAZ ANDRES FELIPE", "RODRIGUEZ SANCHEZ MARIANA", "SANCHEZ TORRES NICOLAS", "TORRES GOMEZ ALEJANDRA", "VARGAS HERNANDEZ DAVID", "GOMEZ CRUZ VALENTINA", "PEÑA ROJAS JUAN JOSE"],
            '9A':["ACOSTA PADILLA OVER ENRIQUE","ACOSTA PALMA CRISTHIAN JASSER","AMADOR PALMA ALVARO JUNIOR","ARCON ALVAREZ SEBASTian","ARTETA CONSUEGRA JANNY LIZ","AVILA MEZA MAUREN JULIETH","BARRAZA SIERRA LUIS FERNANDO","BARRIOS LLANOS GERALDINE ISABEL","BARRIOS SIERRA BRIANA SOFIA","CAMARGO DE LA CRUZ LEINYS MAURETH","CAMARGO MARTINEZ MARIA ALEJANDRA","CANOSA CERVANTES VIVIANA CAROLINA","CORTES PIÑA JHOVANNY ESTEBAN","COSSIO NARVAEZ HEIDY ISABEL","DE LA HOZ VIZCAINO BUENDI BANESA","ESCORCIA BLANCO MELANY SOFIA","ESCORCIA MIRANDA JESUS DAVID","FERNANDEZ ANGULO SHARICK","GALINDO ESCALANTE SHARON MICHAELL","GALLARDO BRADFORD JHOYMAR DE JESUS","LOPEZ MITROBICH MARIMAR","MARRIAGA SANJUAN SOCHY","MURILLO SILVERA YEYCI MISHELL","ORELLANO MOLINA CICLALIS VALENTINA","ORTIZ PEREZ CRISTIAN DAVID","OTERO CARDENAS ADAN ELIAS","OTERO NIETO JAIR DE JESUS","PEÑA MEZA VICTOR ANDRES","POLO CONTRERAS ANDERSON","POLO PALMA SAILLY TATIANA","RADA JIMÉNEZ JESUS ALBERTO","RADA NIEVES DAMARIS SOFIA","REDONDO SALGADO ALEJANDRA SOFIA","RODRIGUEZ ANGULO DANNA NICOLLE","SALAZAR IGLESIAS TALIANA LISETH","SANTIAGO LOPEZ MARIA CAMILA","SARMIENTO CERVANTES VALEREE LUCIA","SARMIENTO DE LA RANS ALAN DAVID","TURBAY GOMEZ LAIONEL DAVID","ZARATA ROA LUIS ALEJANDRO"],
            '9B':["ANGULO BARRAGAN CARLOS DAVID","ARAUJO ESCALANTE YELIANYS","ARTETA ZARATE JHAN CARLOS","BARRAZA CAFIEL VALENTINA ESTHER","BLANCO ESTRADA JENIFER","BLANCO SILVERA YAIKOVIC ALEXANDER","BOLIVAR MARRIAGA YANDERSON DAVID","ESCOBAR ALGARIN JOSE MIGUEL","FERRER SANTANDER LOGAN SMITH","FONTALVO PUELLO CRISTIAN DAVID","GARCIA CAMARGO ANGELY PAOLA","GERONIMO ROJAS EMMANUEL DE JESUS","GIL GUTIERREZ ANA REYSHELL","GOENAGA LEJARDE JULIANNY KAROLAY","GUTIERREZ SIERRA SANTIAGO DAVID","HERNANDEZ LOPEZ MARIA CAMILA","HERNANDEZ MONTAÑO MARIA ALEXANDRA","JIMENEZ CONSUEGRA TANIA CAROLINA","MARIN MORALES GENESIS PAOLA","MARTINEZ DAZA EILYN DAYANA","MEDINA RIQUETT KELLY ROXANA","MOLINA VELASQUEZ LERVYS JAVIER","MORALES OTERO JESUS MANUEL","MOVILLA BOLIVAR EYMIS YOLANIS","NAVARRO GUTIERREZ ALEJANDRO DE JESUS","ORTEGA CUERVO KRISTEL ARIANNE","ORTIZ JIMENEZ ELIATH DAVID","PALMA SILVERA MARISOL","PATINO CONSUEGRA ANDRYS PAOLA","PEREZ ALGARIN LUCIANA","PEREZ BOLIVAR JHONEFFER","REDONDO RODRIGUEZ KARLA CRISTINA","RODRIGUEZ VEGA YESID JAVIER","RUIZ MARENCO JUAN CAMILO","SILVERA JIMENO THALIANA VANESA","TEJERA ORTEGA VALENTina","TESILLO PEREZ CARLOS DANIEL","TORRADO NORENA CRISTIAN","ZAPATA SIERRA LUCYANA MARIA"],
            '9C':["BALLESTAS DE LA CRUZ OWEL ALBERTO","BARANDICA GUTIERREZ IKER DAVID","CAMARGO CABALLERO JHONNY ENRIQUE","CONSUEGRA HERNANDEZ ANGIE PAola","DIAZ DEL TORO SHARILYN PAOLA","ESCORCIA BORNACELLY NATHALIA ISABEL","ESCORCIA DE LA CRUZ LUISA FERNANDA","ESTRADA RUA JHON FREDY","GOENAGA DE AVILA CARLOS MAURICIO","GONZALEZ CONTRERAS YURLANYS MICHELL","GONZALEZ FERRER MAIRELYS DAYANA","GONZALEZ LLANOS ANA MILAGRO","GONZALEZ RICO JAVIER EDUARDO","HURTADO ORTIZ AMY","JIMENEZ BADILLO JUAN MIGUEL","JIMENEZ DE LA CRUZ JUSETH DAVID","LINARES TEJEDA MARCELA","LUBO JIMENEZ ALEJANDRO JOSE","MARTINEZ CASTILLO DANNA CAROLINA","MEDINA SILVERA DILAN DE JESUS","MIRANDA FERNANDEZ ANTONNY DAVID","MOLINA ARRIETA KAIRETH ALEJANDRA","OCHOA ORTEGA JOSE ANDRES","ORTEGA LUNAR DIEGO JESUS","PEREZ GERONIMO EYMER DE JESUS","PRADA SARMIENTO SHARICK ANDREA","REDONDO BERDUGO MARIANA PAOLA","RICAURTE SANTANA MARIA PAULA","RIOS ARCON ARANZA LUCIA","RIOS NAVAS VICTOR MANUEL","ROA DE LA CRUZ PEDRO PABLO","ROMERO JIMENEZ STEVAN FELIPE","SILVERA LINARES ANDRES FELIPE","SILVERA VILORIA SNEYDER DE JESUS","VARGAS CASTRO SAMIR JOSE","VILORIA CABARCAS ESTEFANY PAOLA"],
            '9D':["AMAYA PAZ JEIVER DAVID","ARDILA ORDUZ ALISSON","BLANCO SIERRA ANDY CAMILO","BUSTOS BARRIOS ANGEL DAVID","CABRERA ORTEGA DAVID JESUS","CARBONELL BOSSA MAURICIO ANDRES","CELIN VELASQUEZ MARLIN LORAINE","ESCALANTE ACENDRA ANA VALENTINA","GAMARRA GONZALEZ GABRIEL ALEJANDRO","HERNANDEZ ARJONA JOSUE ALEJANDRO","JIMENEZ DE MOYA SARAY MILENA","LEJARDE PERTUZ ASLHEY DAVIELA","LOPEZ GARCIA ANGEL JESUS","LOPEZ RAMOS OSIEL DAVID","MARTINEZ GARCIA MELANIE CAROLINA","MENDOZA DE LA CRUZ LAURY DANIELA","MERIDIANO CARDENAS DIEGO ANDRES","NITROBICH RIAÑO YEISON YESITH","ORELLANO PALMA ELIANA MARCELa","OROZCO GOMEZ JEISYS PAOLA","ORTEGA GIL ALLISON MITCHEL","OTERO JIMENO SHADYA VANESSA","OTERO MORALES DILAN MATIAS","PADILLA BORRERO AYLIM JOHANA","PALMA BARRAZA XAVI ALONSO","PALMA SILVERA MARILUNA","PINERES TRUYOL VALERY TATIANA","RANGEL MARTINEZ GENESIS PAOLA","REAL BARRIOS JUNIÑO MANUEL","ROBLES MARIN JASSER JESUS","RODRIGUEZ DEL VILLAR JOAN SEBASTIAN","SALAS MALDONADO ALIANYS PATRICIA","SANJUAN PERTUZ JOSSED DAVID","SANTIAGO SOLANO AXEL LEONY","VARGAS ALBIS YERSON DAVID","VARGAS MUÑOZ SHERIT DADIVA","VELILLA ACOSTA CAMILO ANDRES"],
            '10C':["ACOSTA DE LA CRUZ ISACC DAVID","ACUÑA RADA SARESTH CAROLINA","BENEDETTI GARCIA GLEINER DAVID","BORGE FLOREZ MARIA ALEJANDRA","CANTILLO NORIEGA KEIVEN STEVEN","CONSUEGRA GOYENECHE HANYDANIELS ISABELL","CONSUEGRA POLO EDU FERNANDO","CORRO IBAÑEZ DAVID ALEJANDRO","DE LA HOZ ARTETA ANGELINE LUCIA","GOMEZ MARTINEZ NADIA JALILA","GOMEZ OROZCO ANGIE SOFIA","GUTIERREZ OJEDA ANTONE ALEXANDER","LAFAURIE SILVERA JUAN DAVID","LEAL QUINTANILLA JESUS DAVID","MARIANO OROZCO NICOLL ANDREA","MELENDEZ CAMBERO WILIANNIS KARI","MENDOZA ESCALANTE DILAN SACHEL","NAVAS BOLIVAR JAMER DE JESUS","OROZCO ARAUJO MARIA DE LOS ANGELES","ORTEGA GARCIA JULIANA ANDREA","OSPINO DE LA CRUZ JOSE ENrique","OVIEDO MOLINA THAILY SOFIA","PADILLA CONRADO JAIRO ANDRES","PALLARES DE LA RANS JUAN DANIEL","PALMA PEREZ DANNA MEIBELYN","PEREZ DE LA CRUZ LIS DAYANA","RADA TAMAYO JASIR ALFONSO","RANGEL MARTINEZ LIS ALEXANDRA","RODRIGUEZ BLANCO ZAMIRA SOFIA","SALGADO VERDEZA MARIA VALENTINA","SARMIENTO ACUÑA DULCE MARIA","SARMIENTO PALMA MANUEL ALFONSO","SIERRA DE LA CRUZ LAUREEN JAEL","SILVERA SANTIAGO JUAN SEBASTIAN","SUAREZ SIERRA MARIA ANGEL"],
            '11A':["ALBA BOLIVAR GABRIela ISABEL","ARDILA ORDUZ KAREN DAYANNA","BLANCO SILVERA YUGEIDIS DEL CARMEN","BOLIVAR SANTIAGO EDWIN JESUS","CERA SILVERA BRIANDA SOFIA","CUETO REDONDO YULIFER PAOLA","DE LA HOZ LOPEZ ROSA ISABEL","DE MOYA PALLAREZ ADRIAN JOSUE","FLOREZ SOLANO JUAN ANGEL","FRANCO FRANCO VALERY ELENA","GONZALEZ DE LA CRUZ YICEL ANDREA","HERNANDEZ JULIO ISABELA","HERNANDEZ MARRIAGA KARLA SOFIA","HIGUITA ZAPATA VALENTINA MARIA","HOUSSET VALENCIA CRISTOBAL ALBERTO","HOUSSET VALENCIA TALIANA CAROLINA","IBAÑEZ NIETO MAYLAN CRISTINA","JIMENEZ ROA STALYN DE JESÚS","LOPEZ MERCADO YULIMAR","MORALES OTERO ANA MARIA","ORTEGA BOLIVAR MARIETH","OSPINO NIETO WANDA KATERIN","PALMA PACHECO JONATHAN DAVID","RADA POLO STIVE JOHAN","REYES VILLALOBOS SHEILYN","ROLONG SIERRA ANA SARAY","ROMERO RODRIGUEZ LUISA ESTHER","SANTIAGO CUETO KERLYN ANDREA","SANTIAGO DE LA ROSA RITA MERCEDES","SERJE GARCIA MISSELL ISABEL","VASQUEZ CHARRIS YELIS MARGARITA","VELASQUEZ ZAMBRANO DANIEL ALEJANDRO"],
            '11B':["ALBOR SILVERA ALEJANDRA","AMAYA QUINTERO DUVAN JHOSET","BAZA ESCOBAR YORELIS","CERVANTES LARA DEREEK FELIPE","CONSUEGRA DE LA CRUZ SERGIO LUIS","CORRO GONZALEZ ANDRES SEBASTIAN","CORRO HERRERA JULIAN RAFAEL","CUENTAS SIERRA LAUREN MELISA","ESCOBAR ALGARIN FELICIDAD MARIA","GONZALEZ GIL NATALIA MARIA","GONZALEZ HURTADO LAURA MICHEL","GUZMAN NUÑEZ LAUREN CAROLINA","MARQUEZ MIRANDA JOHAN","MAURY SALGADO ALISSON MICHELLE","MEJIA GONZALEZ ISABELLA","MIRANDA DE MOYA EVANGELLY SARIETH","MONTERROSA RODRIGUEZ ANDRES FELIPE","OROZCO VASQUEZ ROSAURA","ORTEGA SIERRA YULIANA PAOLA","PADILLA REDONDO YESSICA MARIA","PEREZ DE LA CRUZ JESUS ALFREDO","PEREZ FRANCO YORIANA LUCIA","QUINTERO COBA EDIER ALEJANDRO","REDONDO TORRES YESICA CAMILA","RODRIGUEZ CARPINTERO CAMILA YSLEN","ROJO CARDONA MISHELL","SANTIAGO NATERA JOHN DAVID","SIERRA FIGUEROA LUCILA ISABEL","VALLEJO CASTILLO ISABELLA SOFIA","VARGAS MOLINA SEBASTIAN ANDRES"],
            '11C':["ALTAMAR CABALLERO PAOLA ANDREA","ARIZA PEREZ DILAN","ARROYO CORREDOR ANDRES FELIPE","BARRETO GUTIERREZ SLAYNETH SOFIA","BONILLA GUTIERREZ SHARON YULiana","CASTIBLANCO IBAÑEZ IAN SANTIAGO","DE LA CRUZ ARRIETA ANGEL DANIEL","DE LA CRUZ CAMARGO SERGIO ANDRES","DE LA CRUZ SARMIENTO MARIA JOSE","DE LA HOZ MUÑOZ LUISA FERNANDA","DE LA HOZ SIERRA JOHAN JESUS","DE LOS REYES TAMAYO YOSETH DAVID","DELGADO HERNANDEZ SOFIA ELENA","ESCALANTE QUIROZ JESUS DAVID","ESCOBAR SALCEDO JUSEPH ENRIQUE","ESCORCIA JIMENEZ ANDRES CAMILO","GALLARDO PANCHA GABRIELA MARIA","GOEZ SERRANO EMMANUEL JOSE","HERNANDEZ CERVANTES PABLO ANDRES","HERNANDEZ MUÑOZ DANA GABRIELA","HERRERA MENDOZA ESTEBAN ENRIQUE","MARQUEZ MIRANDA JAZIR","ORELLANO BOLIVAR KEYDDER DAYAN","PACHECO SIERRA ADRIANA LUCIA","PARRA REDONDO JUAN CAMILO","REDONDO MENDOZA MARIANGEL","RIVERO COBA GLEIDYS PAOLA","SALAZAR LLANOS YAMITH ANDRES","SANCHEZ CELIS DIEGO ISAC","SANTAMARIA BORJA ANDREA DANITZA","SIERRA GARCIA OSCAR ANDRES","VASQUEZ ARZUZA ALAM MATIU","VERGARA BARRIOS KLEIVER MANUEL"],
            '11D':["ARIZA DE LA CRUZ SEBASTIAN DE JESUS","ARIZA SILVERA JORGE MARIO DE JESÚS","BLANCO ESCALANTE SAIDER ISABEL","BOLIVAR VIVANCO NICOL DANIELA","BORGE GOENAGA SHADIA MICHELLE","CABALLERO BARRIOS BREIDER JOSE","CHICO MARTINEZ DAIRON ANDRES","CONSUEGRA SILVERA SARAY MICHELL","ESCALANTE GONZALEZ DANIELA PAOLA","GALLARDO BRADFORD NAYALITH ANDREA","GARZON GALINDO LENIN","GONZALEZ DE LA RANS SHARLET MARIA","GUTIERREZ MENDOZA JOSE LUIS","GUTIERREZ VASQUEZ PAULA PATRICIA","MELENDRES VILLALBA KEIMER ANDRES","MEZA GARCIA CARLOS ANDRES","MORA SILVERA DEYNER ALEXANDER","ORTEGA GONZALEZ LEWIN STICK","PADILLA PARRA MARY ANGEL","PALMA DE LA HOZ LUIS ANGEL","PEDRAZA OLIVEROS MATHIAS KEITEL","PEDROZA GALLARDO SCARLETT SOFIA","PEREZ VEGA NICOL SHARITH","RODRIGUEZ SALAS YORYANIZ ANETH","SANTIAGO SOLANO AXEL LEONY","VARGAS ALBIS YERSON DAVID","VARGAS MUÑOZ SHERIT DADIVA","VELILLA ACOSTA CAMILO ANDRES"]
        };
        let courseConfig = {};
        const capitalizeWords = (str) => !str ? '' : str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        
        function setupCourseConfig() {
            for (const group in allStudentsData) {
                courseConfig[group] = { students: allStudentsData[group].map(capitalizeWords), title: `Grupo: ${group}`, professor: "Puertas Lopez Patricia Isabel", subject: "Artística Plástica y Visual" };
            }
        }

        // --- Utility & Calculation Functions ---
        const getDayForCourse = (course) => { for (const day in dailySchedule) { if (dailySchedule[day].includes(course)) return day; } return null; };
        const getAttendanceDates = (course) => {
            const dayName = getDayForCourse(course);
            if (!dayName) return [];
            const dayNumber = dayNameToNumber[dayName];
            const dates = [], start = new Date('2024-09-22T00:00:00'), end = new Date('2024-11-28T00:00:00');
            let current = new Date(start);
            while (current <= end) {
                if (current.getDay() === dayNumber) dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            return dates;
        };
        const showMessage = (text, type = 'success') => {
            const box = document.createElement('div');
            box.className = 'message-box fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white transition-opacity duration-300 z-50';
            box.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
            box.textContent = text;
            document.body.appendChild(box);
            setTimeout(() => {
                box.style.opacity = '0';
                setTimeout(() => box.remove(), 300);
            }, 3000);
        };
        const getGradeValue = (grades, field) => parseFloat(grades[field]) || 0;
        const calculateAverage = (gradesArray) => { const valid = gradesArray.filter(g => g > 0); return valid.length === 0 ? 0 : valid.reduce((a, b) => a + b, 0) / valid.length; };
        
        const calculateDef = (grades) => {
            const g = grades || {};
            const cAvg = calculateAverage([getGradeValue(g,'cognitivoC1'), getGradeValue(g,'cognitivoC2'), getGradeValue(g,'cognitivoC3')]);
            const pAvg = calculateAverage([getGradeValue(g,'procedimentalP1'), getGradeValue(g,'procedimentalP2'), getGradeValue(g,'procedimentalP3')]);
            const aAvg = calculateAverage([getGradeValue(g,'actitudinalA1'), getGradeValue(g,'actitudinalA2'), getGradeValue(g,'actitudinalA3')]);
            const def = ((cAvg * 0.40) + (pAvg * 0.30) + (aAvg * 0.30));
            return isNaN(def) ? "0.00" : def.toFixed(2);
        };
        const determineNivel = (def) => { const s = parseFloat(def); if (s>=1&&s<=2.99)return"Bajo";if (s>=3&&s<=3.99)return"Básico";if (s>=4&&s<=4.59)return"Alto";if(s>=4.6&&s<=5)return"Superior";return""; };
        const calculateAttendanceSummary = (attendance) => {
            const att = attendance || {};
            let a=0,p=0; 
            for(const d in att) {
                if(att[d]===true) p++;
                else if(att[d]===false) a++;
            } 
            return {attended: p, absent: a}; 
        };

        // --- Table Rendering ---
        const renderTable = () => {
            try {
                const config = courseConfig[activeCourse];
                if (!config || !config.students) {
                    tableContainer.innerHTML = `<div class="p-4 text-center text-red-500">No se pudo cargar la configuración para este curso.</div>`;
                    return;
                }

                const data = gradesData[activeCourse] || {};
                const attendanceDates = getAttendanceDates(activeCourse);
                const searchTerm = searchBox.value.toLowerCase();
                const filteredStudents = config.students.filter(s => s && typeof s === 'string' && s.toLowerCase().includes(searchTerm));

                courseTitle.textContent = `Grupo: ${activeCourse}`;
                courseInfo.innerHTML = `<p>Docente: ${config.professor}</p><p>Asignatura: ${config.subject}</p>`;

                const tableEl = document.createElement('table');
                tableEl.style.minWidth = `${490 + (attendanceDates.length * 60) + 700}px`;

                let tableHTML = `
                    <thead>
                        <tr>
                            <th rowspan="2" class="sticky-left sticky-col-no">No</th>
                            <th rowspan="2" class="sticky-left sticky-col-name">NOMBRE</th>
                            <th rowspan="2" class="sticky-left sticky-col-actions">Acciones</th>
                            <th rowspan="2" class="sticky-left sticky-col-summary">ASIST.</th>
                            <th class="attendance-column" colspan="${attendanceDates.length}">ASISTENCIA POR FECHA</th>
                            <th class="grade-column" colspan="3">COGNITIVO (40%)</th>
                            <th class="grade-column" colspan="3">PROCEDIMENTAL (30%)</th>
                            <th class="grade-column" colspan="3">ACTITUDINAL (30%)</th>
                            <th rowspan="2" class="grade-column col-def">DEF</th>
                            <th rowspan="2" class="grade-column col-nivel">NIVEL</th>
                        </tr>
                        <tr>
                            ${attendanceDates.map(d => {
                                const dateString = d.toISOString().split('T')[0];
                                const note = data.dateNotes?.[dateString] || '';
                                const noteIconClass = note ? 'fas fa-comment-dots text-yellow-300' : 'fas fa-plus-circle text-gray-400';
                                return `<th class="date-header attendance-column">
                                    <div>
                                        ${d.getDate()}/${d.getMonth()+1} 
                                        <i class="${noteIconClass} cursor-pointer hover:text-yellow-500 text-xs ml-1" data-date-note="${dateString}" onclick="showDateNoteModal('${dateString}')"></i>
                                    </div>
                                    <button class="attendance-bulk-btn bg-green-500" onclick="markAllAttendance('${dateString}', true)">✓</button>
                                    <button class="attendance-bulk-btn bg-red-500" onclick="markAllAttendance('${dateString}', false)">✗</button>
                                </th>`;
                            }).join('')}
                            ${['C1', 'C2', 'C3', 'P1', 'P2', 'P3', 'A1', 'A2', 'A3'].map(h => {
                                const noteGroup = h.slice(-1);
                                const note = data.columnNotes?.[noteGroup] || '';
                                const hasNote = note.trim() !== '';
                                const icon = `<i class="fas fa-comment cursor-pointer text-xs ml-1 ${hasNote ? 'text-amber-400' : 'text-gray-400'} hover:text-amber-500" data-col-note="${noteGroup}" onclick="showGradeNoteModal('${noteGroup}')"></i>`;
                                return `<th class="grade-column">${h}${icon}</th>`;
                            }).join('')}
                        </tr>
                    </thead>
                    <tbody>`;
                
                filteredStudents.forEach((student, index) => {
                    const studentData = data[student] || { grades: {}, attendance: {}, observations: [] };
                    const hasObs = studentData.observations && studentData.observations.length > 0;
                    const studentDef = calculateDef(studentData.grades);
                    const nivel = determineNivel(studentDef);
                    const summary = calculateAttendanceSummary(studentData.attendance);
                    const formatGrade = (g) => !isNaN(parseFloat(g)) ? parseFloat(g).toFixed(1) : '';

                    tableHTML += `<tr>
                        <td class="sticky-left sticky-col-no">${index + 1}</td>
                        <td class="sticky-left sticky-col-name">${student}</td>
                        <td class="sticky-left sticky-col-actions">
                            <i class="fas fa-comment action-icon ${hasObs ? 'has-obs' : ''}" data-student-obs="${student}" onclick="showObservationsModal('${student}')"></i>
                            <i class="fas fa-id-card action-icon" onclick="showBulletinModal('${student}')"></i>
                            <i class="fas fa-edit action-icon action-grades-btn" onclick="showGradesModal('${student}')"></i>
                        </td>
                        <td class="sticky-left sticky-col-summary"><span>Asist.: ${summary.attended}</span><br><span>Ausen.: ${summary.absent}</span></td>`;
                    
                    attendanceDates.forEach(date => {
                        const dateString = date.toISOString().split('T')[0];
                        const status = studentData.attendance?.[dateString];
                        let a_class = 'attendance-box', a_content = '';
                        if (status === true) { a_class += ' attended'; a_content = '✓'; }
                        else if (status === false) { a_class += ' absent'; a_content = '✗'; }
                        tableHTML += `<td class="attendance-cell"><div class="${a_class}" data-student="${student}" data-date="${dateString}">${a_content}</div></td>`;
                    });
                    
                    ['cognitivoC1','cognitivoC2','cognitivoC3','procedimentalP1','procedimentalP2','procedimentalP3','actitudinalA1','actitudinalA2','actitudinalA3'].forEach(f => {
                        tableHTML += `<td class="grade-column grade-cell" data-student="${student}" data-field="${f}">${formatGrade(studentData.grades?.[f])}</td>`;
                    });
                    
                    const nivelClass = (nivel && typeof nivel === 'string') ? `nivel-${nivel.toLowerCase()}` : '';
                    tableHTML += `<td class="grade-column col-def ${nivelClass}">${studentDef}</td><td class="grade-column col-nivel ${nivelClass}">${nivel}</td></tr>`;
                });
                tableEl.innerHTML = tableHTML + `</tbody>`;
                tableContainer.innerHTML = '';
                tableContainer.appendChild(tableEl);
                calculateAndDisplayStats();
            } catch(e) {
                console.error(`An error occurred while rendering the table for course "${activeCourse}":`, e);
                tableContainer.innerHTML = `<div class="p-4 text-center text-red-500">Ocurrió un error al mostrar la lista de estudiantes. Por favor, intente limpiar la caché del navegador.</div>`;
            }
        };

        // --- Event Handlers & Data Management ---
        const ensureCourseData = () => {
            if (!gradesData[activeCourse]) gradesData[activeCourse] = {};
            if (!gradesData[activeCourse].dateNotes) gradesData[activeCourse].dateNotes = {};
            if (!gradesData[activeCourse].columnNotes) gradesData[activeCourse].columnNotes = {};
        };
        const ensureStudentData = (student) => {
            if (!gradesData[activeCourse]) gradesData[activeCourse] = { dateNotes: {}, columnNotes: {} };
            if (!gradesData[activeCourse][student]) {
                gradesData[activeCourse][student] = { grades: {}, attendance: {}, observations: [] };
            } else if (!gradesData[activeCourse][student].observations) {
                gradesData[activeCourse][student].observations = [];
            }
        };
        
        const enableEdit = (cell) => {
            if (cell.querySelector('input')) return;
            const { student, field } = cell.dataset;
            ensureStudentData(student);
            const currentVal = gradesData[activeCourse][student].grades?.[field] || '';
            const input = document.createElement('input');
            input.type = 'number';
            input.min = '1';
            input.max = '5';
            input.step = '0.1';
            input.className = 'grade-input';
            input.value = !isNaN(parseFloat(currentVal)) ? parseFloat(currentVal).toFixed(1) : '';
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();

            const saveAndExit = () => {
                const currentInput = cell.querySelector('input');
                if (currentInput) {
                    updateGrade(student, field, currentInput.value, cell);
                }
            }
            
            input.addEventListener('blur', saveAndExit);
            input.addEventListener('keydown', (e) => {
                const navKeys = ['Enter', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Tab'];
                if (!navKeys.includes(e.key)) return;
                e.preventDefault();
                const allGradeCells = Array.from(tableContainer.querySelectorAll('.grade-cell'));
                const currentIndex = allGradeCells.indexOf(cell);
                const inputsPerRow = 9;
                let nextCell = null;
                if (e.key === 'Enter' || e.key === 'ArrowDown') nextCell = allGradeCells[currentIndex + inputsPerRow];
                else if (e.key === 'ArrowUp') nextCell = allGradeCells[currentIndex - inputsPerRow];
                else if (e.key === 'ArrowRight' || e.key === 'Tab') nextCell = allGradeCells[currentIndex + 1];
                else if (e.key === 'ArrowLeft') nextCell = allGradeCells[currentIndex - 1];
                input.blur();
                if (nextCell) setTimeout(() => enableEdit(nextCell), 0);
            });
        };
        
        const updateGrade = (student, field, value, cell) => {
            if(!cell.contains(document.activeElement)) {
                ensureStudentData(student);
                const studentData = gradesData[activeCourse][student];
                if (!studentData.grades) studentData.grades = {};
                let numVal = parseFloat(value);
                
                if (value !== '' && (isNaN(numVal) || numVal < 1 || numVal > 5)) {
                    showMessage('La nota debe estar entre 1 y 5.', 'error');
                    cell.textContent = studentData.grades[field] || '';
                    return;
                }
                studentData.grades[field] = value;
                cell.textContent = value !== '' ? numVal.toFixed(1) : '';
                
                const studentRow = cell.closest('tr');
                if(studentRow) {
                    const newDef = calculateDef(studentData.grades);
                    const newNivel = determineNivel(newDef);
                    const nivelClass = newNivel ? `nivel-${newNivel.toLowerCase()}` : '';
                    const defCell = studentRow.querySelector('.col-def');
                    const nivelCell = studentRow.querySelector('.col-nivel');
                    defCell.textContent = newDef;
                    nivelCell.textContent = newNivel;
                    defCell.className = `col-def ${nivelClass}`;
                    nivelCell.className = `col-nivel ${nivelClass}`;
                }
                saveData(true);
                calculateAndDisplayStats();
            }
        };

        const updateAttendance = (box) => {
            const { student, date } = box.dataset;
            ensureStudentData(student);
            const studentData = gradesData[activeCourse][student];
            if (!studentData.attendance) studentData.attendance = {};
            const currentStatus = studentData.attendance[date];
            let newStatus = (currentStatus === undefined) ? true : (currentStatus === true) ? false : undefined;
            if (newStatus === undefined) delete studentData.attendance[date];
            else studentData.attendance[date] = newStatus;
            box.className = 'attendance-box'; box.textContent = '';
            if (newStatus === true) { box.classList.add('attended'); box.textContent = '✓'; }
            else if (newStatus === false) { box.classList.add('absent'); box.textContent = '✗'; }
            const summary = calculateAttendanceSummary(studentData.attendance);
            const summaryCell = box.closest('tr').querySelector('.sticky-col-summary');
            if (summaryCell) summaryCell.innerHTML = `<span>Asist.: ${summary.attended}</span><br><span>Ausen.: ${summary.absent}</span>`;
            saveData(true);
            calculateAndDisplayStats();
        };

        function markAllAttendance(dateString, status) {
            const config = courseConfig[activeCourse];
            if (!config) return;
            const students = config.students;
            const data = gradesData[activeCourse] || {};
            const allCurrentlyMarked = students.every(student => (data[student]?.attendance?.[dateString] === status));
            const newStatus = allCurrentlyMarked ? undefined : status;
            students.forEach(student => {
                ensureStudentData(student);
                if (!gradesData[activeCourse][student].attendance) gradesData[activeCourse][student].attendance = {};
                if (newStatus === undefined) delete gradesData[activeCourse][student].attendance[dateString];
                else gradesData[activeCourse][student].attendance[dateString] = newStatus;
            });
            saveData();
        }

        const saveData = (isPartial = false) => { try { localStorage.setItem('gradesDataGroups', JSON.stringify(gradesData)); if (!isPartial) renderTable(); } catch (e) { console.error("Error saving data: ", e); } };
        
        const loadData = () => {
            const savedGrades = localStorage.getItem('gradesDataGroups');
            if (savedGrades) {
                try {
                    gradesData = JSON.parse(savedGrades);
                    if (typeof gradesData !== 'object' || gradesData === null || Array.isArray(gradesData)) {
                        gradesData = {};
                        localStorage.removeItem('gradesDataGroups');
                    }
                } catch (e) { 
                    console.error("Error parsing data from localStorage. Data will be reset.", e);
                    gradesData = {};
                    localStorage.removeItem('gradesDataGroups');
                }
            } else {
                gradesData = {};
            }
            setupCourseConfig();
        };
        
        function applyTheme(isDark) {
            if (isDark) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
            darkModeToggle.checked = isDark;
        }
       
        function showObservationsModal(student) {
            ensureStudentData(student);
            document.getElementById('obsStudentName').textContent = student;
            document.getElementById('obsTextarea').value = '';
            
            const historyContainer = document.getElementById('obsHistory');
            historyContainer.innerHTML = '';

            const observations = gradesData[activeCourse][student].observations || [];

            if (observations.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-500">No hay observaciones registradas.</p>';
            } else {
                observations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                observations.forEach(obs => {
                    const obsDate = new Date(obs.timestamp);
                    const formattedDate = obsDate.toLocaleString('es-CO', { dateStyle: 'short', timeStyle: 'short' });
                    const obsElement = document.createElement('div');
                    obsElement.className = 'p-2 border-b';
                    obsElement.style.borderColor = 'var(--border-color)';
                    obsElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <p class="whitespace-normal flex-grow">${obs.text.replace(/\n/g, '<br>')}</p>
                            <i class="fas fa-trash-alt text-red-500 hover:text-red-700 cursor-pointer ml-4 flex-shrink-0" onclick="requestDeleteObservation('${student}', '${obs.timestamp}')"></i>
                        </div>
                        <p class="text-xs text-gray-500 text-right mt-1">${formattedDate}</p>
                    `;
                    historyContainer.appendChild(obsElement);
                });
            }

            obsModal.classList.add('active');
            obsModal.dataset.student = student;
        }

        function requestDeleteObservation(student, timestamp) {
            const deleteErrorMsg = document.getElementById('deleteErrorMsg');
            const deletePasswordInput = document.getElementById('deletePasswordInput');
            
            deletePasswordInput.value = '';
            deleteErrorMsg.classList.add('hidden');
            
            deleteConfirmModal.dataset.student = student;
            deleteConfirmModal.dataset.timestamp = timestamp;
            deleteConfirmModal.classList.add('active');
            setTimeout(() => deletePasswordInput.focus(), 100);
        }

        function deleteObservation(student, timestamp) {
            ensureStudentData(student);
            const studentData = gradesData[activeCourse][student];
            
            if (studentData && studentData.observations) {
                studentData.observations = studentData.observations.filter(obs => obs.timestamp !== timestamp);
                saveData();
                showObservationsModal(student); // Refresh the modal to show the change
                showMessage("Observación borrada con éxito.", "success");
            }
        }
        
        function showDateNoteModal(dateString) {
            ensureCourseData();
            const date = new Date(dateString + 'T00:00:00');
            document.getElementById('dateNoteDate').textContent = date.toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('dateNoteTextarea').value = gradesData[activeCourse].dateNotes?.[dateString] || '';
            dateNoteModal.dataset.date = dateString;
            dateNoteModal.classList.add('active');
        }
        
        function showGradeNoteModal(noteGroup) {
            ensureCourseData();
            const titlePart = noteGroup === '1' ? 'Notas #1 (C1, P1, A1)' : noteGroup === '2' ? 'Notas #2 (C2, P2, A2)' : 'Notas #3 (C3, P3, A3)';
            document.getElementById('gradeNoteTitle').textContent = titlePart;
            document.getElementById('gradeNoteTextarea').value = gradesData[activeCourse].columnNotes?.[noteGroup] || '';
            gradeNoteModal.classList.add('active');
            gradeNoteModal.dataset.noteGroup = noteGroup;
        }

        function showGradesModal(student) {
            ensureStudentData(student);
            const studentData = gradesData[activeCourse][student];
            gradesStudentName.textContent = student;
            gradesGrid.innerHTML = '';
            const fields = ['cognitivoC1','cognitivoC2','cognitivoC3','procedimentalP1','procedimentalP2','procedimentalP3','actitudinalA1','actitudinalA2','actitudinalA3'];
            fields.forEach(field => {
                const value = studentData.grades?.[field] || '';
                const label = field.replace('cognitivo', 'C').replace('procedimental', 'P').replace('actitudinal', 'A').toUpperCase();
                gradesGrid.innerHTML += `<div class="col-span-1 flex items-center"><label class="font-semibold">${label}:</label></div><div class="col-span-2"><input type="number" min="1" max="5" step="0.1" data-field="${field}" value="${value}" class="grade-input"></div>`;
            });
            gradesModal.dataset.student = student;
            gradesModal.classList.add('active');
        }

        function showBulletinModal(student) {
            ensureStudentData(student);
            const studentData = gradesData[activeCourse][student];
            const def = calculateDef(studentData.grades);
            const nivel = determineNivel(def);
            const attendance = calculateAttendanceSummary(studentData.attendance);
            const timestamp = new Date().toLocaleString('es-CO', { dateStyle: 'long', timeStyle: 'short' });

            let obsHTML = 'Sin observaciones.';
            const observations = studentData.observations || [];
            if (observations.length > 0) {
                observations.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                obsHTML = observations.map(obs => {
                    const obsDate = new Date(obs.timestamp);
                    const formattedDate = obsDate.toLocaleString('es-CO', { dateStyle: 'short', timeStyle: 'short' });
                    return `<div class="mb-2"><p class="whitespace-normal">${obs.text.replace(/\n/g, '<br>')}</p><p class="text-xs text-gray-500 text-right mt-1">${formattedDate}</p></div>`;
                }).join('<hr class="my-1">');
            }

            document.getElementById('bulletinContent').innerHTML = `<div class="bulletin-page p-4 bg-white" style="color: black !important;"><h3 class="text-2xl font-bold text-center mb-4">Boletín Informativo</h3><p><strong>Estudiante:</strong> <span id="bulletinStudentName">${student}</span></p><p><strong>Curso:</strong> <span id="bulletinCourseName">${courseConfig[activeCourse].title}</span></p><hr class="my-4"><h4 class="text-lg font-bold mt-4">Calificaciones</h4><div id="bulletinGrades" class="grid grid-cols-2 gap-2 mt-2"><p><strong>Cognitivo C1:</strong> ${studentData.grades?.cognitivoC1||'N/A'}</p><p><strong>Cognitivo C2:</strong> ${studentData.grades?.cognitivoC2||'N/A'}</p><p><strong>Cognitivo C3:</strong> ${studentData.grades?.cognitivoC3||'N/A'}</p><p><strong>Procedimental P1:</strong> ${studentData.grades?.procedimentalP1||'N/A'}</p><p><strong>Procedimental P2:</strong> ${studentData.grades?.procedimentalP2||'N/A'}</p><p><strong>Procedimental P3:</strong> ${studentData.grades?.procedimentalP3||'N/A'}</p><p><strong>Actitudinal A1:</strong> ${studentData.grades?.actitudinalA1||'N/A'}</p><p><strong>Actitudinal A2:</strong> ${studentData.grades?.actitudinalA2||'N/A'}</p><p><strong>Actitudinal A3:</strong> ${studentData.grades?.actitudinalA3||'N/A'}</p><p class="mt-2 font-bold"><strong>DEF: ${def} (${nivel})</strong></p></div><h4 class="text-lg font-bold mt-4">Asistencia</h4><div id="bulletinAttendance" class="mt-2"><p><strong>Asistencias:</strong> ${attendance.attended}</p><p><strong>Ausencias:</strong> ${attendance.absent}</p></div><h4 class="text-lg font-bold mt-4">Observaciones</h4><div id="bulletinObs" class="mt-2">${obsHTML}</div><div class="text-xs text-gray-500 text-center mt-6" style="color: #555 !important;">Generado el: ${timestamp}</div></div>`;
            bulletinModal.classList.add('active');
        }
        
        function exportData(scope, selectedCourses = []) {
            let csvContent = "data:text/csv;charset=utf-8,";
            const coursesToExport = scope === 'all' ? Object.keys(allStudentsData).sort() : scope === 'selected' ? selectedCourses : [activeCourse];
            coursesToExport.forEach(course => {
                 const config = courseConfig[course];
                 const data = gradesData[course] || {};
                 if (scope !== 'current') csvContent += `"${config.title}"\r\n`;
                 const attendanceDates = getAttendanceDates(course).map(d => d.toLocaleDateString('es-CO'));
                 const headers = ["No", "Estudiante", ...attendanceDates, "Obs.", "C1", "C2", "C3", "P1", "P2", "P3", "A1", "A2", "A3", "DEF", "NIVEL"];
                 csvContent += headers.join(",") + "\r\n";
                 config.students.forEach((student, index) => {
                     const studentData = data[student] || {};
                     const obsText = (studentData.observations || [])
                        .map(obs => {
                            const d = new Date(obs.timestamp).toLocaleString('es-CO');
                            return `[${d}]: ${obs.text}`;
                        })
                        .join('; ');

                     const def = calculateDef(studentData.grades);
                     const nivel = determineNivel(def);
                     let row = [index + 1, `"${student}"`, ...getAttendanceDates(course).map(d => { const s=studentData.attendance?.[d.toISOString().split('T')[0]]; return s===true?"P":s===false?"A":""; }), `"${obsText.replace(/"/g, '""')}"`, studentData.grades?.cognitivoC1||"", studentData.grades?.cognitivoC2||"", studentData.grades?.cognitivoC3||"", studentData.grades?.procedimentalP1||"", studentData.grades?.procedimentalP2||"", studentData.grades?.procedimentalP3||"", studentData.grades?.actitudinalA1||"", studentData.grades?.actitudinalA2||"", studentData.grades?.actitudinalA3||"", def, nivel];
                     csvContent += row.join(",") + "\r\n";
                 });
                 if (scope !== 'current') csvContent += "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `calificaciones_${scope}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            exportModal.classList.remove('active');
        }

        async function downloadBulletinAsFile(format) {
            const studentName = document.getElementById('bulletinStudentName').textContent;
            const bulletinContent = document.getElementById('bulletinContent').querySelector('.bulletin-page');
            const canvas = await html2canvas(bulletinContent, { scale: 2, backgroundColor: 'white' });
            const imgData = canvas.toDataURL('image/png');
            const fileName = `boletin_${studentName.replace(/ /g, '_')}.${format}`;
            if (format === 'png') {
                const link = document.createElement('a');
                link.download = fileName;
                link.href = imgData;
                link.click();
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight - 20);
                pdf.save(fileName);
            }
        }

        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const newStudents = e.target.result.split('\n').map(name => capitalizeWords(name.trim())).filter(Boolean);
                if (newStudents.length > 0) {
                    allStudentsData[activeCourse] = newStudents;
                    gradesData[activeCourse] = {};
                    setupCourseConfig();
                    saveData();
                }
            };
            reader.readAsText(file);
            importFile.value = '';
        });

        function calculateAndDisplayStats() {
            const data = gradesData[activeCourse] || {};
            const students = courseConfig[activeCourse]?.students || [];
            if (students.length === 0) {
                statsPanel.innerHTML = "";
                return;
            }
            let totalDef = 0, studentCountWithGrades = 0;
            const nivelCounts = { "Bajo": 0, "Básico": 0, "Alto": 0, "Superior": 0, "N/A": 0 };
            let totalAttended = 0;
            const totalPossibleSessions = students.length * getAttendanceDates(activeCourse).length;
            students.forEach(student => {
                const studentData = data[student] || {};
                const def = parseFloat(calculateDef(studentData.grades));
                if (!isNaN(def) && def > 0) {
                    totalDef += def;
                    studentCountWithGrades++;
                }
                const nivel = determineNivel(def) || "N/A";
                nivelCounts[nivel]++;
                totalAttended += calculateAttendanceSummary(studentData.attendance).attended;
            });
            const avgDef = studentCountWithGrades > 0 ? (totalDef / studentCountWithGrades).toFixed(2) : "0.00";
            const attendancePercent = totalPossibleSessions > 0 ? ((totalAttended / totalPossibleSessions) * 100).toFixed(1) : 0;
            statsPanel.innerHTML = `<div class="stat-item"><p class="font-bold text-lg">${avgDef}</p><p class="text-sm">Promedio Gral.</p></div><div class="stat-item"><p class="font-bold text-lg">${attendancePercent}%</p><p class="text-sm">Asistencia</p></div><div class="stat-item"><p class="font-bold text-lg">${nivelCounts.Superior}</p><p class="text-sm">Superior</p></div><div class="stat-item"><p class="font-bold text-lg">${nivelCounts.Alto}</p><p class="text-sm">Alto</p></div><div class="stat-item"><p class="font-bold text-lg">${nivelCounts.Básico}</p><p class="text-sm">Básico</p></div><div class="stat-item"><p class="font-bold text-lg">${nivelCounts.Bajo}</p><p class="text-sm">Bajo</p></div>`;
        }
        
        async function generateAndExportPdf(courses, studentList = null) {
            showMessage('Generando PDF, por favor espera...', 'success');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const studentsToPrint = [];
            if(studentList) { 
                studentsToPrint.push({ courseName: activeCourse, students: studentList });
            } else { 
                courses.forEach(courseName => studentsToPrint.push({ courseName: courseName, students: courseConfig[courseName]?.students || [] }));
            }
            const timestamp = new Date().toLocaleString('es-CO', { dateStyle: 'long', timeStyle: 'short' });
            let firstPage = true;
            for (const { courseName, students } of studentsToPrint) {
                for (const studentName of students) {
                    if (!firstPage) pdf.addPage();
                    const studentData = gradesData[courseName]?.[studentName] || {};
                    const def = calculateDef(studentData.grades);
                    const nivel = determineNivel(def);
                    const attendance = calculateAttendanceSummary(studentData.attendance);
                    const bulletinHTML = `<div class="bulletin-page p-4 bg-white" style="width:210mm;color:black!important"><h3 class="text-2xl font-bold text-center mb-4">Boletín Informativo</h3><p><strong>Estudiante:</strong> ${studentName}</p><p><strong>Curso:</strong> ${courseConfig[courseName].title}</p><hr class="my-4"><h4 class="text-lg font-bold mt-4">Calificaciones</h4><div class="grid grid-cols-2 gap-2 mt-2"><p><strong>Cognitivo C1:</strong> ${studentData.grades?.cognitivoC1||'N/A'}</p><p><strong>Cognitivo C2:</strong> ${studentData.grades?.cognitivoC2||'N/A'}</p><p><strong>Cognitivo C3:</strong> ${studentData.grades?.cognitivoC3||'N/A'}</p><p><strong>Procedimental P1:</strong> ${studentData.grades?.procedimentalP1||'N/A'}</p><p><strong>Procedimental P2:</strong> ${studentData.grades?.procedimentalP2||'N/A'}</p><p><strong>Procedimental P3:</strong> ${studentData.grades?.procedimentalP3||'N/A'}</p><p><strong>Actitudinal A1:</strong> ${studentData.grades?.actitudinalA1||'N/A'}</p><p><strong>Actitudinal A2:</strong> ${studentData.grades?.actitudinalA2||'N/A'}</p><p><strong>Actitudinal A3:</strong> ${studentData.grades?.actitudinalA3||'N/A'}</p><p class="mt-2 font-bold"><strong>DEF: ${def} (${nivel})</strong></p></div><h4 class="text-lg font-bold mt-4">Asistencia</h4><div class="mt-2"><p><strong>Asistencias:</strong> ${attendance.attended}</p><p><strong>Ausencias:</strong> ${attendance.absent}</p></div><h4 class="text-lg font-bold mt-4">Observaciones</h4><p class="mt-2">${studentData.observations||'Sin observaciones.'}</p><div class="text-xs text-gray-500 text-center mt-6" style="color:#555!important">Generado el: ${timestamp}</div></div>`;
                    const tempDiv = document.createElement('div');
                    tempDiv.style.position='absolute'; tempDiv.style.left='-9999px';
                    tempDiv.innerHTML = bulletinHTML;
                    document.body.appendChild(tempDiv);
                    const canvas = await html2canvas(tempDiv.firstChild, { scale: 2, backgroundColor: 'white' });
                    const imgData = canvas.toDataURL('image/png');
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, (imgProps.height * (pdfWidth-20)) / imgProps.width);
                    document.body.removeChild(tempDiv);
                    firstPage = false;
                }
            }
            let fileName = studentList ? `boletines_${activeCourse}_seleccionados.pdf` : courses.length === 1 ? `boletines_${courses[0]}.pdf` : courses.length === Object.keys(allStudentsData).length ? `boletines_todos_los_cursos.pdf` : `boletines_cursos_seleccionados.pdf`;
            pdf.save(fileName);
            bulletinSelectionModal.classList.remove('active');
        }

        // --- App Initialization & Event Listeners ---
        const customTooltip = document.getElementById('customTooltip');
        document.body.addEventListener('mouseover', (event) => {
            const target = event.target;
            let tooltipText = '';

            if (target.matches('[data-student-obs]')) {
                const student = target.dataset.studentObs;
                const studentData = gradesData[activeCourse]?.[student];
                const observations = studentData?.observations || [];
                if (observations.length > 0) {
                    observations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    const latestObs = observations[0];
                    const obsDate = new Date(latestObs.timestamp);
                    const formattedDate = obsDate.toLocaleString('es-CO', { dateStyle: 'short', timeStyle: 'short' });
                    tooltipText = `<strong>Última Obs. (${formattedDate}):</strong><br>${latestObs.text.replace(/\n/g, '<br>')}`;
                } else {
                    tooltipText = 'Añadir observación';
                }
            } else if (target.matches('[data-col-note]')) {
                const noteGroup = target.dataset.colNote;
                tooltipText = gradesData[activeCourse]?.columnNotes?.[noteGroup] || 'Añadir comentario de actividad';
            } else if (target.matches('[data-date-note]')) {
                const dateString = target.dataset.dateNote;
                tooltipText = gradesData[activeCourse]?.dateNotes?.[dateString] || 'Añadir nota para esta fecha';
            }

            if (tooltipText.trim()) {
                customTooltip.innerHTML = tooltipText.replace(/\n/g, '<br>');
                customTooltip.classList.remove('hidden');
            } else {
                customTooltip.classList.add('hidden');
            }
        });
        document.body.addEventListener('mouseout', (event) => {
            if (event.target.matches('[data-student-obs], [data-col-note], [data-date-note]')) {
                customTooltip.classList.add('hidden');
            }
        });
        document.body.addEventListener('mousemove', (event) => {
            if (!customTooltip.classList.contains('hidden')) {
                let x = event.pageX + 15;
                let y = event.pageY + 15;
                if (x + customTooltip.offsetWidth > window.innerWidth) {
                    x = event.pageX - customTooltip.offsetWidth - 15;
                }
                if (y + customTooltip.offsetHeight > window.innerHeight) {
                    y = event.pageY - customTooltip.offsetHeight - 15;
                }
                customTooltip.style.left = `${x}px`;
                customTooltip.style.top = `${y}px`;
            }
        });

        searchBox.addEventListener('input', renderTable);
        tableContainer.addEventListener('click', (event) => {
            const gradeCell = event.target.closest('.grade-cell');
            const attendanceBox = event.target.closest('.attendance-box');
            const clickedRow = event.target.closest('tr');
            if (clickedRow?.parentElement.tagName === 'TBODY') {
                tableContainer.querySelector('tr.row-selected')?.classList.remove('row-selected');
                clickedRow.classList.add('row-selected');
            }
            if (gradeCell) enableEdit(gradeCell);
            if (attendanceBox) updateAttendance(attendanceBox);
        });

        const generateTabs = () => {
            tabNavigation.innerHTML = '';
            for (const day in dailySchedule) {
                const dayBlock = document.createElement('div');
                dayBlock.className = 'daily-group-block';
                dayBlock.innerHTML = `<div class="daily-group-title">${day}</div><div class="group-buttons-wrapper"></div>`;
                const wrapper = dayBlock.querySelector('.group-buttons-wrapper');
                dailySchedule[day].forEach(group => {
                    const button = document.createElement('button');
                    button.id = `tab-${group}`;
                    button.className = 'tab-button';
                    button.textContent = group;
                    button.onclick = () => switchCourse(group);
                    wrapper.appendChild(button);
                });
                tabNavigation.appendChild(dayBlock);
            }
        };

        const switchCourse = (course) => {
            activeCourse = course;
            if (!gradesData[activeCourse]) gradesData[activeCourse] = { dateNotes: {}, columnNotes: {} };
            document.querySelectorAll('.tab-button.active').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${activeCourse}`)?.classList.add('active');
            renderTable();
        };
        
        darkModeToggle.addEventListener('change', () => {
            localStorage.setItem('darkMode', darkModeToggle.checked);
            applyTheme(darkModeToggle.checked);
        });
        
        exportBtn.addEventListener('click', () => {
            const courseSelectionCheckboxes = document.getElementById('courseSelectionCheckboxes');
            courseSelectionCheckboxes.innerHTML = '';
            Object.keys(allStudentsData).sort().forEach(course => {
                courseSelectionCheckboxes.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" value="${course}" class="form-checkbox h-5 w-5 rounded"><span>${course}</span></label>`;
            });
            exportModal.classList.add('active');
        });
        document.getElementById('exportCurrentBtn').addEventListener('click', () => exportData('current'));
        document.getElementById('exportAllBtn').addEventListener('click', () => exportData('all'));
        document.getElementById('exportSelectedBtn').addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('#courseSelectionCheckboxes input:checked')).map(cb => cb.value);
            if (selected.length > 0) exportData('selected', selected);
            else showMessage('Por favor, selecciona al menos un curso.', 'error');
        });

        bulletinBtn.addEventListener('click', () => {
            const studentCheckboxes = document.getElementById('studentSelectionCheckboxes');
            studentCheckboxes.innerHTML = '';
            (courseConfig[activeCourse]?.students || []).forEach(student => {
                studentCheckboxes.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" value="${student}" class="form-checkbox h-5 w-5 rounded"><span>${student}</span></label>`;
            });
            const courseCheckboxes = document.getElementById('bulletinCourseSelectionCheckboxes');
            courseCheckboxes.innerHTML = '';
            Object.keys(allStudentsData).sort().forEach(course => {
                courseCheckboxes.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" value="${course}" class="form-checkbox h-5 w-5 rounded"><span>${course}</span></label>`;
            });
            bulletinSelectionModal.classList.add('active');
        });

        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });
        });
        document.getElementById('closeObsModal').addEventListener('click', () => obsModal.classList.remove('active'));
        document.getElementById('closeDateNoteModal').addEventListener('click', () => dateNoteModal.classList.remove('active'));
        document.getElementById('closeGradeNoteModal').addEventListener('click', () => gradeNoteModal.classList.remove('active'));
        document.getElementById('closeDeleteConfirmModal').addEventListener('click', () => deleteConfirmModal.classList.remove('active'));
        document.getElementById('closeBulletinModal').addEventListener('click', () => bulletinModal.classList.remove('active'));
        document.getElementById('closeExportModal').addEventListener('click', () => exportModal.classList.remove('active'));
        document.getElementById('closeGradesModal').addEventListener('click', () => gradesModal.classList.remove('active'));
        document.getElementById('closeBulletinSelectionModal').addEventListener('click', () => bulletinSelectionModal.classList.remove('active'));
        
        document.getElementById('saveObs').addEventListener('click', () => {
            const student = obsModal.dataset.student;
            const newText = document.getElementById('obsTextarea').value.trim();

            if (newText) {
                ensureStudentData(student);
                const newObs = {
                    text: newText,
                    timestamp: new Date().toISOString()
                };
                gradesData[activeCourse][student].observations.push(newObs);
                saveData();
                showObservationsModal(student); 
            }
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            const passwordInput = document.getElementById('deletePasswordInput');
            const deleteErrorMsg = document.getElementById('deleteErrorMsg');
            const { student, timestamp } = deleteConfirmModal.dataset;

            if (passwordInput.value === '55232122') {
                deleteObservation(student, timestamp);
                deleteConfirmModal.classList.remove('active');
            } else {
                deleteErrorMsg.classList.remove('hidden');
                passwordInput.focus();
            }
        });

        document.getElementById('saveDateNote').addEventListener('click', () => {
            const noteText = document.getElementById('dateNoteTextarea').value.trim();
            if (noteText) gradesData[activeCourse].dateNotes[dateNoteModal.dataset.date] = noteText;
            else delete gradesData[activeCourse].dateNotes[dateNoteModal.dataset.date];
            saveData();
            dateNoteModal.classList.remove('active');
        });
        document.getElementById('saveGradeNote').addEventListener('click', () => {
            const { noteGroup } = gradeNoteModal.dataset;
            const noteText = document.getElementById('gradeNoteTextarea').value;
            ensureCourseData();
            gradesData[activeCourse].columnNotes[noteGroup] = noteText;
            saveData();
            gradeNoteModal.classList.remove('active');
        });
        document.getElementById('saveGrades').addEventListener('click', () => {
            const student = gradesModal.dataset.student;
            ensureStudentData(student);
            gradesGrid.querySelectorAll('input').forEach(input => {
                const { field } = input.dataset;
                const { value } = input;
                let numVal = parseFloat(value);
                 if (value !== '' && (isNaN(numVal) || numVal < 1 || numVal > 5)) {} 
                 else {
                    if (!gradesData[activeCourse][student].grades) gradesData[activeCourse][student].grades = {};
                    gradesData[activeCourse][student].grades[field] = value;
                 }
            });
            saveData();
            gradesModal.classList.remove('active');
            showMessage('Notas guardadas con éxito.', 'success');
        });
        
        document.getElementById('generateAllCoursesBulletinBtn').addEventListener('click', () => generateAndExportPdf(Object.keys(allStudentsData)));
        document.getElementById('generateCurrentCourseBulletinBtn').addEventListener('click', () => generateAndExportPdf([activeCourse]));
        document.getElementById('generateSelectedCoursesBtn').addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('#bulletinCourseSelectionCheckboxes input:checked')).map(cb => cb.value);
            if (selected.length > 0) generateAndExportPdf(selected);
            else showMessage('Por favor, selecciona al menos un curso.', 'error');
        });
        document.getElementById('generateSelectedStudentsBtn').addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('#studentSelectionCheckboxes input:checked')).map(cb => cb.value);
            if (selected.length > 0) generateAndExportPdf(null, selected);
            else showMessage('Por favor, selecciona al menos un estudiante.', 'error');
        });
        document.getElementById('selectAllStudentsBtn').addEventListener('click', () => document.querySelectorAll('#studentSelectionCheckboxes input').forEach(cb => cb.checked = true));
        document.getElementById('deselectAllStudentsBtn').addEventListener('click', () => document.querySelectorAll('#studentSelectionCheckboxes input').forEach(cb => cb.checked = false));
        document.getElementById('downloadPngBtn').addEventListener('click', () => downloadBulletinAsFile('png'));
        document.getElementById('downloadPdfBtn').addEventListener('click', () => downloadBulletinAsFile('pdf'));

        window.onload = () => {
            try {
                applyTheme(localStorage.getItem('darkMode') === 'true');
                loadData();
                generateTabs();
                const dayMap = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                const todayIndex = new Date().getDay();
                const todayName = dayMap[todayIndex === 0 || todayIndex === 6 ? 1 : todayIndex];
                const initialCourse = dailySchedule[todayName]?.[0] || Object.values(dailySchedule)[0][0];
                switchCourse(initialCourse);
            } catch (error) {
                console.error("Error during page initialization:", error);
                document.body.innerHTML = `<div style="background:#fff;color:#b71c1c;padding:20px;text-align:center;font-family:sans-serif;height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;"><h1>Ocurrió un error al cargar la aplicación</h1><p>Intenta limpiar la caché y los datos del sitio antes de volver a cargar la página.</p></div>`;
            }
        };
    </script>
</body>
</html>
