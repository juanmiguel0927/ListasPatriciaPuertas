<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Calificaciones - Grupos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- PDF & Image Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg-color: #ffffff;
            --header-bg-color: #4b5563;
            --sticky-col-bg: #f9fafb;
            --border-color: #e5e7eb;
            --input-border-color: #d1d5db;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --tab-block-bg: #f1f5f9;
            --tab-button-bg: #e2e8f0;
            --tab-button-text: #475569;
            --row-selected-bg: #dbeafe;
        }

        html.dark {
            --bg-color: #1f2937;
            --text-color: #f3f4f6;
            --card-bg-color: #374151;
            --header-bg-color: #111827;
            --sticky-col-bg: #4b5563;
            --border-color: #4b5563;
            --input-border-color: #6b7280;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --tab-block-bg: #4b5563;
            --tab-button-bg: #64748b;
            --tab-button-text: #e2e8f0;
            --row-selected-bg: #1e3a8a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            width: 100%;
            max-width: 95%;
            margin: auto;
            background-color: var(--card-bg-color);
            box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color);
        }
        .table-container {
            max-height: 75vh;
            overflow: auto;
            border-radius: 0.5rem;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            padding: 0.75rem;
            text-align: center;
            font-size: 0.875rem;
            white-space: nowrap;
            background-color: var(--card-bg-color);
        }
        td, thead tr:last-child th {
            border-bottom: 1px solid var(--border-color);
        }
        thead tr:first-child th {
            border-bottom: 1px solid var(--header-bg-color);
        }
        tr:last-child td { border-bottom: none; }

        /* --- STICKY & COLUMN STYLES --- */
        thead th {
            position: sticky; top: 0;
            background-color: var(--header-bg-color);
            color: #ffffff; z-index: 20;
            vertical-align: middle; height: 70px;
        }
        thead tr:nth-child(2) th { top: 70px; }
        .sticky-left { position: sticky; left: 0; box-shadow: 2px 0 5px -2px var(--shadow-color); }
        th.sticky-left { z-index: 22; background-color: var(--header-bg-color); }
        td.sticky-left { z-index: 21; background-color: var(--sticky-col-bg); }

        .sticky-col-select { left: 0; width: 50px; min-width: 50px; }
        .sticky-col-no { left: 50px; width: 50px; min-width: 50px; }
        .sticky-col-name { left: 100px; width: 220px; min-width: 220px; text-align: left; }
        .sticky-col-actions { left: 320px; width: 120px; min-width: 120px; }
        .sticky-col-summary { left: 440px; width: 120px; min-width: 120px; }
        
        /* Row Selection Highlight */
        tbody tr:hover > td, tbody tr:hover > .sticky-left {
            background-color: var(--sticky-col-bg);
        }
        tr.row-selected > td {
            background-color: var(--row-selected-bg);
        }
        tr.row-selected > td.sticky-left {
            background-color: var(--row-selected-bg);
        }


        /* --- Grade & Input Styles --- */
        .grade-cell { 
            width: 70px; 
            min-width: 70px; 
            cursor: pointer;
            position: relative;
        }
        .grade-input { width: 100%; padding: 0.25rem; border: 1px solid var(--input-border-color); border-radius: 0.25rem; text-align: center; background-color: var(--card-bg-color); color: var(--text-color); }
        .col-def, .col-nivel { width: 80px; min-width: 80px; font-weight: bold; }

        /* Performance Level Colors */
        .nivel-bajo { background-color: #fee2e2; color: #991b1b; }
        .nivel-basico { background-color: #fef9c3; color: #854d0e; }
        .nivel-alto { background-color: #dcfce7; color: #166534; }
        .nivel-superior { background-color: #dbeafe; color: #1e40af; }
        html.dark .nivel-bajo { background-color: #7f1d1d; color: #fecaca; }
        html.dark .nivel-basico { background-color: #713f12; color: #fef08a; }
        html.dark .nivel-alto { background-color: #14532d; color: #bbf7d0; }
        html.dark .nivel-superior { background-color: #1e3a8a; color: #bfdbfe; }
        tr.row-selected .nivel-bajo, tr.row-selected .nivel-basico, tr.row-selected .nivel-alto, tr.row-selected .nivel-superior {
            color: var(--text-color); /* Ensure text is readable when row is selected */
        }


        /* --- Attendance Styles --- */
        .attendance-box {
            cursor: pointer; width: 28px; height: 28px; border: 1px solid var(--input-border-color);
            border-radius: 0.375rem; display: flex; align-items: center; justify-content: center;
            margin: auto; font-size: 1.1rem; font-weight: bold; line-height: 1; transition: all 0.2s ease-in-out;
        }
        .attendance-box.attended { background-color: #dcfce7; color: #16a34a; border-color: #16a34a; }
        .attendance-box.absent { background-color: #fee2e2; color: #ef4444; border-color: #ef4444; }
        .attendance-box.excused { background-color: #e0e7ff; color: #4338ca; border-color: #4338ca; }
        .attendance-box.late { background-color: #fef3c7; color: #b45309; border-color: #b45309; }
        html.dark .attendance-box.late { background-color: #78350f; color: #fde68a; }
        .date-header { vertical-align: bottom; padding: 0.25rem; }
        .date-header div:first-child { transform: rotate(-90deg); white-space: nowrap; display: block; width: 30px; margin: 0 auto 25px auto; }
        td.attendance-cell { width: 60px; min-width: 60px; }
        .attendance-bulk-btn { font-size: 0.75rem; padding: 2px 4px; border-radius: 4px; margin: 1px 0; display: block; width: 100%; border: 1px solid #fff; }

        /* --- UI Elements --- */
        .controls-container { display: flex; flex-direction: column; align-items: stretch; sm:flex-row; sm:justify-between; sm:items-center; gap: 1rem; margin-bottom: 1.5rem; }
        .search-box { padding: 0.5rem; border: 1px solid var(--input-border-color); border-radius: 0.5rem; background-color: var(--card-bg-color); color: var(--text-color); width: 100%; sm:w-auto; }
        /* Fix for light mode readability in inputs */
        .search-box, input[type="text"], input[type="number"], select, textarea {
            color: var(--text-color);
            background-color: var(--card-bg-color);
        }
        /* Specific fix for placeholders in light mode */
        ::placeholder {
            color: #6b7280;
            opacity: 1;
        }

        .action-button { background-color: #4b5563; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; text-align: center; }
        .action-button:hover { background-color: #374151; }
        html.dark .action-button { background-color: #1f2937; }
        html.dark .action-button:hover { background-color: #111827; }
        .button-group { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }

        /* Dark Mode Toggle */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Tab Navigation Styles */
        .daily-schedule-container { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1.5rem; }
        .daily-group-block { background-color: var(--tab-block-bg); border-radius: 0.75rem; padding: 0.75rem; box-shadow: 0 1px 3px 0 var(--shadow-color); }
        .daily-group-title { font-weight: 600; text-align: center; margin-bottom: 0.5rem; color: var(--text-color); }
        .group-buttons-wrapper { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
        .tab-button { padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease; cursor: pointer; background-color: var(--tab-button-bg); color: var(--tab-button-text); }
        .tab-button.active { background-color: #3b82f6; color: #ffffff; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--card-bg-color); padding: 2rem; border-radius: 0.75rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; color: var(--text-color); }
        .modal-content textarea { width: 100%; min-height: 150px; border: 1px solid var(--input-border-color); border-radius: 0.5rem; padding: 0.5rem; background-color: var(--bg-color); color: var(--text-color); }
        .bulletin-content { border: 1px solid var(--border-color); padding: 1.5rem; }
        #passwordConfirmModal {
            z-index: 110; /* Ensure it appears above other modals */
        }
        
        /* Stats Panel */
        .stats-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; background-color: var(--bg-color); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; align-items: center;}
        .stat-item { text-align: center; }
        #statsChartContainer { max-height: 120px; }

        /* Action Icons in Table */
        .action-icon { cursor: pointer; margin: 0 0.25rem; font-size: 1rem; transition: color 0.2s; }
        .action-icon:hover { color: #3b82f6; }
        .action-icon.has-obs { color: #f59e0b; } /* Amber color for observation icon */
        .action-icon.has-obs:hover { color: #d97706; }
        
        /* Custom Tooltip */
        #customTooltip {
            pointer-events: none; /* Make sure the tooltip doesn't interfere with mouse events */
            background-color: var(--header-bg-color);
            color: #ffffff;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px var(--shadow-color);
            max-width: 250px;
            word-wrap: break-word;
            z-index: 150;
        }
        
        /* Voice Input Modal Styles */
        #voiceGradeModal .modal-content { max-width: 700px; }
        #voiceStatus.listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        #voiceGrid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        #voiceStudentList, #voiceGradeList {
             max-height: 250px; overflow-y: auto; border-radius: 0.375rem;
             border: 1px solid var(--input-border-color); padding: 0.5rem;
        }
        #voiceStudentList div, #voiceGradeList div { 
            padding: 0.5rem; border-radius: 0.25rem; cursor: pointer;
            transition: background-color 0.2s;
        }
        #voiceStudentList div.selected, #voiceGradeList div.selected {
             background-color: var(--row-selected-bg);
        }
        .voice-mode-btn {
            background-color: var(--tab-button-bg);
            color: var(--tab-button-text);
            border: 1px solid var(--input-border-color);
            transition: all 0.2s;
        }
        .voice-mode-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }


        /* --- Responsive Design for Mobile & Tablet --- */
        .action-grades-btn { display: none; } /* Oculto por defecto */
        
        @media (max-width: 1024px) { 
            .grade-column { display: none; } /* Oculta columnas de notas en pantallas peque帽as */
            .action-grades-btn { display: inline-block; } /* Muestra el bot贸n de editar notas */
        }

        .bulletin-page {
            background-color: white;
            color: black;
        }

        .bulletin-page * {
            color: black !important;
        }
        
        /* Print styles */
        @media print {
            body * { visibility: hidden; }
            #studentReportContent, #studentReportContent * { visibility: visible; }
            #studentReportContent { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }

    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="container rounded-xl p-4 sm:p-8 mt-4">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6">Control de Calificaciones y Asistencia</h1>
        
        <div class="flex justify-center items-center mb-4 gap-4">
            <div>
                <label for="periodSelector" class="mr-2 font-semibold">Periodo:</label>
                <select id="periodSelector" class="search-box text-gray-900 dark:text-gray-100"></select>
            </div>
            <button id="todayBtn" class="action-button" title="Ir al d铆a de hoy"><i class="fas fa-calendar-day"></i> Hoy</button>
        </div>
        
        <div class="flex justify-center mb-2">
            <button id="editScheduleBtn" class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-semibold"><i class="fas fa-edit"></i> Editar Horario (D铆as)</button>
        </div>
        <div id="tabNavigation" class="daily-schedule-container"></div>
        <h2 id="courseTitle" class="text-2xl font-bold text-center mb-2"></h2>
        <div id="courseInfo" class="text-center text-gray-500 dark:text-gray-400 mb-4"></div>

        <!-- Controls -->
        <div class="controls-container">
            <input type="text" id="searchBox" class="search-box" placeholder="Buscar estudiante..." spellcheck="true">
            <div class="flex items-center justify-center sm:justify-end w-full sm:w-auto gap-4">
                <div class="button-group">
                    <button id="advancedCleanBtn" class="action-button bg-red-600 hover:bg-red-700"><i class="fas fa-trash-alt mr-2"></i>Borrar Datos</button>
                    <button id="promoteStudentsBtn" class="action-button bg-purple-600 hover:bg-purple-700"><i class="fas fa-user-graduate mr-2"></i>Promover Grupo</button>
                    <button id="rankingBtn" class="action-button"><i class="fas fa-trophy mr-2"></i>Ranking</button>
                    <button id="voiceInputBtn" class="action-button"><i class="fas fa-microphone-alt mr-2"></i>Notas por Voz</button>
                    <button id="bulletinBtn" class="action-button"><i class="fas fa-id-card mr-2"></i>Boletines</button>
                    <button id="exportCsvBtn" class="action-button"><i class="fas fa-file-csv mr-2"></i>Exportar CSV</button>
                    <button id="importStudentsBtn" class="action-button"><i class="fas fa-user-plus mr-2"></i>Importar Estudiantes</button>
                    <button id="dataManagementBtn" class="action-button"><i class="fas fa-database mr-2"></i>Gestionar Datos</button>
                    <input type="file" id="importFile" class="hidden" accept=".txt">
                    <input type="file" id="importJsonFile" class="hidden" accept=".json,application/json">
                </div>
                <div class="flex items-center gap-2">
                    <i id="settingsBtn" class="fas fa-cog text-2xl cursor-pointer text-gray-500 hover:text-blue-500 transition-colors"></i>
                    <label class="toggle-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Stats Panel -->
        <div id="statsPanel" class="stats-panel"></div>
        
        <!-- Table -->
        <div id="attendanceTableContainer" class="table-container"></div>
        
        <!-- Modals -->
        <div id="obsModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Observaciones para <span id="obsStudentName"></span></h3>
                <div id="obsHistory" class="mb-4 p-2 border rounded max-h-48 overflow-y-auto" style="border-color: var(--input-border-color);">
                    <!-- History will be populated by JS -->
                </div>
                 <div class="mb-2">
                    <h4 class="font-semibold text-sm mb-1">Observaciones R谩pidas</h4>
                    <div id="predefinedObs" class="flex flex-wrap gap-1">
                        <!-- Predefined observation buttons will be inserted here -->
                    </div>
                </div>
                <textarea id="obsTextarea" placeholder="A帽adir nueva observaci贸n..." spellcheck="true"></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeObsModal" class="action-button">Cerrar</button>
                    <button id="saveObs" class="action-button bg-blue-600">A帽adir Observaci贸n</button>
                </div>
            </div>
        </div>

        <div id="editObsModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Editar Observaci贸n</h3>
                <textarea id="editObsTextarea" spellcheck="true"></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeEditObsModal" class="action-button">Cancelar</button>
                    <button id="saveEditObs" class="action-button bg-blue-600">Guardar Cambios</button>
                </div>
            </div>
        </div>

        <div id="dateNoteModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Anotaci贸n para la fecha: <span id="dateNoteDate"></span></h3>
                <textarea id="dateNoteTextarea" placeholder="A帽adir un evento o nota para este d铆a (ej. Examen, Salida pedag贸gica)..." spellcheck="true"></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeDateNoteModal" class="action-button">Cerrar</button>
                    <button id="saveDateNote" class="action-button bg-blue-600">Guardar</button>
                </div>
            </div>
        </div>

        <div id="gradeNoteModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Comentario para <span id="gradeNoteTitle"></span></h3>
                <textarea id="gradeNoteTextarea" spellcheck="true"></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeGradeNoteModal" class="action-button">Cerrar</button>
                    <button id="saveGradeNote" class="action-button bg-blue-600">Guardar</button>
                </div>
            </div>
        </div>

        <div id="passwordConfirmModal" class="modal-overlay">
            <div class="modal-content">
                <h3 id="passwordConfirmTitle" class="text-xl font-bold mb-4">Confirmar Acci贸n</h3>
                <p class="mb-4">Para continuar, por favor ingresa la clave de seguridad.</p>
                <input type="password" id="passwordInput" class="search-box w-full" placeholder="Clave de seguridad...">
                <div id="passwordErrorMsg" class="text-red-500 text-sm mt-2 hidden">Clave incorrecta.</div>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closePasswordConfirmModal" class="action-button">Cancelar</button>
                    <button id="confirmPasswordBtn" class="action-button bg-red-600">Confirmar</button>
                </div>
            </div>
        </div>

        <div id="groupGradeModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Calificaci贸n Grupal para <span id="groupGradeComponent"></span></h3>
                <p class="mb-4">Se aplicar谩 la nota a <strong id="groupGradeStudentCount">0</strong> estudiante(s) seleccionado(s).</p>
                <input type="number" id="groupGradeInput" class="search-box w-full" placeholder="Ingresar nota (1.0 - 5.0)" min="1" max="5" step="0.1">
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeGroupGradeModal" class="action-button">Cancelar</button>
                    <button id="saveGroupGrade" class="action-button bg-blue-600">Aplicar Nota</button>
                </div>
            </div>
        </div>

        <div id="advancedDeleteModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4 text-red-600">Limpieza Avanzada de Datos</h3>
                <div class="space-y-6">
                    <!-- Scope Selection -->
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-semibold mb-2 text-gray-900 dark:text-gray-100">1. 驴A qui茅nes aplicar?</h4>
                        <div class="flex flex-col gap-2">
                            <label class="flex items-center text-gray-900 dark:text-gray-100"><input type="radio" name="adv-delete-scope" value="selected" checked class="mr-2"> Estudiantes Seleccionados (Checkbox)</label>
                            <label class="flex items-center text-gray-900 dark:text-gray-100"><input type="radio" name="adv-delete-scope" value="current_course" class="mr-2"> Todo el Curso Actual (<span id="advDeleteCourseName"></span>)</label>
                            <label class="flex items-center text-gray-900 dark:text-gray-100"><input type="radio" name="adv-delete-scope" value="all_courses" class="mr-2"> TODOS los cursos (Reinicio total)</label>
                        </div>
                    </div>

                    <!-- Content Type Selection -->
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <h4 class="font-semibold mb-2 text-gray-900 dark:text-gray-100">2. 驴Qu茅 eliminar?</h4>
                        <div class="flex flex-col gap-2">
                            <label class="flex items-center font-bold text-red-500">
                                <input type="checkbox" id="adv-del-grades" class="mr-2 h-5 w-5"> Calificaciones (Notas)
                            </label>
                            <label class="flex items-center font-bold text-amber-500">
                                <input type="checkbox" id="adv-del-attendance" class="mr-2 h-5 w-5"> Asistencia
                            </label>
                            <label class="flex items-center font-bold text-blue-500">
                                <input type="checkbox" id="adv-del-obs" class="mr-2 h-5 w-5"> Observaciones
                            </label>
                             <label class="flex items-center text-gray-500 dark:text-gray-400">
                                <input type="checkbox" id="adv-del-metadata" class="mr-2 h-5 w-5"> Notas de Encabezado (Fecha/Columna)
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-4 p-2 text-xs bg-yellow-100 text-yellow-800 rounded">
                    <i class="fas fa-exclamation-triangle"></i> Esta acci贸n no se puede deshacer. Se recomienda exportar una copia de seguridad antes.
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button id="closeAdvancedDeleteModal" class="action-button">Cancelar</button>
                    <button id="confirmAdvancedDeleteBtn" class="action-button bg-red-600">Ejecutar Limpieza</button>
                </div>
            </div>
        </div>

        <div id="promoteModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4 text-purple-700 dark:text-purple-400">Promoci贸n de Estudiantes</h3>
                <p class="text-sm mb-4">Transfiere estudiantes o clona la estructura para un nuevo periodo.</p>
                
                <div class="space-y-4">
                    <!-- Scope Selection -->
                    <div class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600">
                        <h4 class="font-bold text-sm mb-2 text-gray-900 dark:text-gray-100">1. Alcance:</h4>
                        <div class="flex gap-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="promote-scope" value="single" checked class="mr-2"> 
                                <span class="font-medium text-gray-900 dark:text-gray-100">Solo este Curso (<span id="promoteCurrentCourseLabel" class="text-gray-900 dark:text-gray-100"></span>)</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="promote-scope" value="all" class="mr-2"> 
                                <span class="font-medium text-gray-900 dark:text-gray-100">Todos los Cursos (Masivo)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Single Course Options -->
                    <div id="promoteSingleOptions" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="font-semibold text-xs block mb-1 text-gray-900 dark:text-gray-100">Origen:</label>
                            <input type="text" id="promoteSourceCourse" class="search-box w-full bg-gray-200 text-gray-900 font-bold border-gray-400" readonly>
                        </div>
                        <div>
                            <label class="font-semibold text-xs block mb-1 text-gray-900 dark:text-gray-100">Destino:</label>
                             <select id="promoteTargetSelect" class="search-box w-full mb-1 text-gray-900 dark:text-white bg-white dark:bg-gray-800 border-gray-400"></select>
                             <input type="text" id="promoteTargetInput" class="search-box w-full hidden text-gray-900 border-gray-400" placeholder="Nuevo Nombre (ej. 10A)">
                             <div class="text-xs text-right mt-1">
                                 <a href="#" id="togglePromoteTarget" class="text-blue-600 dark:text-blue-400 font-semibold hover:underline">Crear nuevo curso</a>
                             </div>
                        </div>
                    </div>

                    <!-- Batch Options (Hidden by default) -->
                    <div id="promoteBatchOptions" class="hidden p-3 bg-blue-50 dark:bg-gray-800 border border-blue-200 rounded">
                        <div class="mb-4">
                            <label class="font-semibold text-sm block mb-1 text-gray-900 dark:text-gray-100">2. Tipo de Acci贸n:</label>
                            <div class="flex flex-col gap-2 pl-2">
                                 <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="promote-batch-type" value="increment" checked class="form-radio text-purple-600">
                                    <span class="ml-2 font-medium text-gray-900 dark:text-gray-100">Avanzar Grado (ej. 7A &rarr; 8A, 11掳 salen del sistema)</span>
                                 </label>
                                 <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="promote-batch-type" value="clone" class="form-radio text-purple-600">
                                    <span class="ml-2 font-medium text-gray-900 dark:text-gray-100">Clonar Mismo Grado (ej. 7A &rarr; 7A-202X)</span>
                                 </label>
                            </div>
                        </div>

                        <div id="promoteSuffixContainer" class="hidden">
                            <label class="font-semibold text-sm block mb-1 text-gray-900 dark:text-gray-100">Sufijo (Opcional):</label>
                            <input type="text" id="promoteBatchSuffix" class="search-box w-full text-gray-900 border-gray-400" placeholder="Ej: -2026">
                        </div>
                    </div>

                    <!-- Student List (Only for Single) -->
                    <div id="promoteStudentListContainer" class="border rounded p-2 max-h-48 overflow-y-auto bg-gray-50 dark:bg-gray-800">
                        <div class="flex justify-between items-center mb-2 px-2">
                             <span class="font-bold text-sm text-gray-900 dark:text-gray-100">Estudiantes a mover:</span>
                             <div class="text-xs space-x-2">
                                 <span class="cursor-pointer text-blue-600 font-semibold" id="promoteSelectAll">Todos</span>
                                 <span class="cursor-pointer text-blue-600 font-semibold" id="promoteDeselectAll">Ninguno</span>
                             </div>
                        </div>
                        <div id="promoteStudentList" class="space-y-1">
                            <!-- Checkboxes generated here -->
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button id="closePromoteModal" class="action-button">Cancelar</button>
                    <button id="confirmPromoteBtn" class="action-button bg-purple-600 text-white font-bold">Promover / Copiar</button>
                </div>
            </div>
        </div>
        
        <div id="settingsModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Configuraci贸n General</h3>
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold mb-2">Informaci贸n del Docente</h4>
                        <div class="grid grid-cols-1 gap-4">
                            <div><label for="professorNameInput">Nombre del Docente:</label><input type="text" id="professorNameInput" class="search-box w-full" spellcheck="true"></div>
                            <div><label for="subjectNameInput">Nombre de la Asignatura:</label><input type="text" id="subjectNameInput" class="search-box w-full" spellcheck="true"></div>
                        </div>
                    </div>
                     <div>
                        <h4 class="font-semibold mb-2">Estructura de Calificaciones</h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div><label for="cognitiveCount"># Cognitivo:</label><input type="number" id="cognitiveCount" class="search-box w-full" min="1" max="5"></div>
                            <div><label for="proceduralCount"># Procedim.:</label><input type="number" id="proceduralCount" class="search-box w-full" min="1" max="5"></div>
                            <div><label for="attitudinalCount"># Actitudinal:</label><input type="number" id="attitudinalCount" class="search-box w-full" min="1" max="5"></div>
                        </div>
                    </div>
                     <div>
                        <h4 class="font-semibold mb-2">Porcentajes de Evaluaci贸n (%)</h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div><label for="cognitivePercentage">Cognitivo:</label><input type="number" id="cognitivePercentage" class="search-box w-full"></div>
                            <div><label for="proceduralPercentage">Procedimental:</label><input type="number" id="proceduralPercentage" class="search-box w-full"></div>
                            <div><label for="attitudinalPercentage">Actitudinal:</label><input type="number" id="attitudinalPercentage" class="search-box w-full"></div>
                        </div>
                    </div>
                     <div>
                        <h4 class="font-semibold mb-2">Gesti贸n de Periodos</h4>
                        <div id="periodsList" class="space-y-2"></div>
                        <div class="flex gap-2 mt-2">
                           <input type="text" id="newPeriodName" class="search-box flex-grow" placeholder="Nombre del nuevo periodo" spellcheck="true">
                           <button id="addPeriodBtn" class="action-button bg-green-600">+</button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button id="closeSettingsModal" class="action-button">Cerrar</button>
                    <button id="saveSettingsBtn" class="action-button bg-blue-600">Guardar Cambios</button>
                </div>
            </div>
        </div>
        
         <div id="courseManagementModal" class="modal-overlay">
            <div class="modal-content">
                 <h3 class="text-xl font-bold mb-4">Gesti贸n del Curso: <span id="courseManagementTitle"></span></h3>
                 <div>
                    <h4 class="font-semibold mb-2">Lista de Estudiantes</h4>
                    <div id="studentManagementList" class="space-y-2 max-h-60 overflow-y-auto border p-2 rounded" style="border-color: var(--input-border-color);"></div>
                    <div class="flex gap-2 mt-2">
                       <input type="text" id="newStudentName" class="search-box flex-grow" placeholder="Nombre del nuevo estudiante" spellcheck="true">
                       <button id="addStudentBtn" class="action-button bg-green-600">+</button>
                    </div>
                </div>
                 <div class="flex justify-end gap-2 mt-6">
                    <button id="closeCourseManagementModal" class="action-button">Cerrar</button>
                </div>
            </div>
        </div>

        <div id="scheduleModal" class="modal-overlay">
            <div class="modal-content max-w-4xl">
                <h3 class="text-xl font-bold mb-4"> Editar Horario Semanal</h3>
                <p class="text-sm text-gray-500 mb-4">Selecciona qu茅 grupos tienen clase en cada d铆a de la semana.</p>
                <div id="scheduleGrid" class="grid grid-cols-1 sm:grid-cols-5 gap-4">
                    <!-- Days generated here -->
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button id="closeScheduleModal" class="action-button">Cancelar</button>
                    <button id="saveScheduleBtn" class="action-button bg-blue-600">Guardar Horario</button>
                </div>
            </div>
        </div>

        <div id="studentReportModal" class="modal-overlay">
            <div class="modal-content max-w-2xl">
                <div id="studentReportContent">
                    <!-- Report content will be generated here -->
                </div>
                <div class="flex justify-end gap-2 mt-4 no-print">
                    <button id="closeStudentReportModal" class="action-button">Cerrar</button>
                    <button id="printStudentReportBtn" class="action-button bg-blue-600"><i class="fas fa-print mr-2"></i>Imprimir</button>
                </div>
            </div>
        </div>

        <div id="bulletinModal" class="modal-overlay">
            <div class="modal-content">
                <div id="bulletinContent">
                    <!-- Content will be generated by JS -->
                </div>
                 <div class="flex justify-end gap-2 mt-4 no-print">
                    <button id="closeBulletinModal" class="action-button">Cerrar</button>
                    <button id="downloadPngBtn" class="action-button bg-green-600"><i class="fas fa-file-image"></i> PNG</button>
                    <button id="downloadPdfBtn" class="action-button bg-red-600"><i class="fas fa-file-pdf"></i> PDF</button>
                </div>
            </div>
        </div>
        
        <div id="exportModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Opciones de Exportaci贸n CSV</h3>
                <div class="flex flex-col gap-4">
                    <button id="exportCurrentBtn" class="action-button w-full">Exportar Curso Actual</button>
                    <button id="exportAllBtn" class="action-button w-full">Exportar Todos los Cursos</button>
                    <div>
                        <h4 class="font-semibold mb-2 text-left">Selecci贸n Personalizada:</h4>
                        <div id="courseSelectionCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-48 overflow-y-auto p-2 border rounded" style="border-color: var(--input-border-color);">
                            <!-- Checkboxes will be inserted here by JS -->
                        </div>
                        <button id="exportSelectedBtn" class="action-button w-full mt-4">Exportar Selecci贸n</button>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                     <button id="closeExportModal" class="action-button">Cerrar</button>
                </div>
            </div>
        </div>

        <div id="dataManagementModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Gestionar Datos (Exportar/Importar)</h3>
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                  <p class="font-bold">Exportar</p>
                  <p>Guarda una copia de seguridad de todos tus datos (notas, estudiantes, configuraci贸n, etc.) en un 煤nico archivo <strong>.json</strong>.</p>
                </div>
                <button id="exportJsonBtn" class="action-button w-full bg-blue-600 mb-6"><i class="fas fa-download mr-2"></i>Exportar Copia de Seguridad</button>
                
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert">
                  <p class="font-bold">Importar</p>
                  <p>Carga un archivo <strong>.json</strong> para restaurar tus datos. <strong class="text-red-600">隆Atenci贸n! Se sobreescribir谩n todos los datos actuales.</strong></p>
                </div>
                <button id="importJsonBtn" class="action-button w-full bg-green-600"><i class="fas fa-upload mr-2"></i>Importar Copia de Seguridad</button>
                
                <div class="flex justify-end mt-6">
                     <button id="closeDataManagementModal" class="action-button">Cerrar</button>
                </div>
            </div>
        </div>

        <div id="gradesModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Notas para <span id="gradesStudentName"></span></h3>
                <div id="gradesGrid" class="grid grid-cols-3 gap-x-4 gap-y-2"></div>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeGradesModal" class="action-button">Cancelar</button>
                    <button id="saveGrades" class="action-button bg-blue-600">Guardar</button>
                </div>
            </div>
        </div>
        
        <div id="bulletinSelectionModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Generar Boletines en PDF</h3>
                <div class="flex flex-col gap-4">
                    <!-- Option 1: All Courses -->
                    <button id="generateAllCoursesBulletinBtn" class="action-button w-full">Generar PDF de Todos los Cursos</button>
                    
                    <!-- Option 2: Current Course -->
                    <button id="generateCurrentCourseBulletinBtn" class="action-button w-full">Generar PDF del Curso Actual</button>
                    
                    <!-- Option 3: Selected Courses -->
                    <div>
                        <h4 class="font-semibold mb-2 text-left">Selecci贸n por Cursos:</h4>
                        <div id="bulletinCourseSelectionCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-48 overflow-y-auto p-2 border rounded" style="border-color: var(--input-border-color);">
                            <!-- Course checkboxes will be inserted here by JS -->
                        </div>
                        <button id="generateSelectedCoursesBtn" class="action-button w-full mt-4">Generar PDF de Cursos Seleccionados</button>
                    </div>

                    <!-- Option 4: Selected Students in Current Course -->
                    <div>
                        <h4 class="font-semibold mb-2 text-left">Selecci贸n por Estudiantes (Curso Actual):</h4>
                        <div class="flex justify-between items-center mb-2">
                             <button id="selectAllStudentsBtn" class="text-sm text-blue-500 hover:underline">Seleccionar Todos</button>
                             <button id="deselectAllStudentsBtn" class="text-sm text-blue-500 hover:underline">Deseleccionar Todos</button>
                        </div>
                        <div id="studentSelectionCheckboxes" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-48 overflow-y-auto p-2 border rounded" style="border-color: var(--input-border-color);">
                            <!-- Student checkboxes will be inserted here -->
                        </div>
                        <button id="generateSelectedStudentsBtn" class="action-button w-full mt-4">Generar PDF de Estudiantes Seleccionados</button>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                     <button id="closeBulletinSelectionModal" class="action-button">Cerrar</button>
                </div>
            </div>
        </div>

        <div id="voiceGradeModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Ingreso de Notas por Voz</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="voiceCourseSelector" class="font-semibold">Seleccionar Curso:</label>
                        <select id="voiceCourseSelector" class="search-box w-full mt-1"></select>
                    </div>
                    <div>
                        <label class="font-semibold">Modo de Calificaci贸n:</label>
                        <div id="voiceModeSelector" class="mt-2 flex rounded-md shadow-sm">
                            <button data-mode="student" class="voice-mode-btn active flex-1 rounded-l-md px-4 py-2 text-sm font-medium">Por Estudiante</button>
                            <button data-mode="component" class="voice-mode-btn flex-1 rounded-r-md px-4 py-2 text-sm font-medium">Por Componente</button>
                        </div>
                    </div>
                </div>
                <div id="voiceGrid">
                    <div>
                        <h4 class="font-semibold mb-2">Estudiantes</h4>
                        <div id="voiceStudentList"></div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Notas</h4>
                        <div id="voiceGradeList"></div>
                    </div>
                </div>
                <div class="text-center my-4">
                    <button id="voiceListenBtn" class="action-button bg-blue-600 rounded-full w-20 h-20 text-3xl flex items-center justify-center mx-auto">
                        <i id="voiceStatus" class="fas fa-microphone-alt"></i>
                    </button>
                    <p id="voiceTranscript" class="mt-2 text-gray-500 h-6">Presiona para iniciar</p>
                </div>
                <div class="flex justify-end mt-6">
                     <button id="closeVoiceGradeModal" class="action-button">Cerrar</button>
                </div>
            </div>
        </div>
        
        <div id="rankingModal" class="modal-overlay">
            <div class="modal-content max-w-4xl">
                <h3 class="text-2xl font-bold mb-4 text-center">Ranking de Desempe帽o - <span id="rankingPeriodName"></span></h3>
                <div id="rankingContent" class="space-y-6 max-h-[60vh] overflow-y-auto p-2">
                    <!-- Ranking content will be generated here -->
                </div>
                <div class="flex justify-end mt-6">
                    <button id="closeRankingModal" class="action-button">Cerrar</button>
                </div>
            </div>
        </div>

        <div class="w-full text-center mt-8 text-sm text-gray-500">Dise帽ado por Juan Miguel R铆os Redondo</div>
    </div>

    <div id="customTooltip" class="hidden absolute p-2 text-sm rounded-md shadow-lg max-w-xs whitespace-normal"></div>

    <script>
        // --- Global Scope Variables ---
        const ui = {};
        let recognition;
        let isRecognitionSessionActive = false;
        let voiceGradingMode = 'student';
        let dailySchedule = {'Lunes':['8C','9B'],'Martes':['8A','9C','11A','11B'],'Mi茅rcoles':['8B','9A'],'Jueves':['10C','11C','11D'],'Viernes':['8D','9D','7D']};
        const dayNameToNumber = { 'Lunes': 1, 'Martes': 2, 'Mi茅rcoles': 3, 'Jueves': 4, 'Viernes': 5 };
        let activeCourse;
        let activePeriod;
        let appSettings;
        let gradesData = {};
        let allStudentsData = {
            '7D':["AHUMADA SIERRA THAEL","AMARIS SIERRA JULEISY","BENITEZ BOSSIO MARIA","BOLIVAR GOMEZ MARIA","CABALLERO SILVERA JOHELIS","CARMONA SILVERA LEYNER","CARPINTERO SILVERA THALIA","CONSUEGRA ALVAREZ JHOINER","ESCORCIA RIVALDO CAMILO","GERONIMO BARRAZA HELLEN","GOEZ OTERO DANIEL","GONZALEZ BARRAZA DANNA","GUANIPA GUTIERREZ ARANZA","GUTIERREZ OJEDA EMMANUEL","HERNANDEZ DIAZ JESUS","LLANOS SEGURA YAILETH","MARIN PALMA SANTIAGO","MARMOL HERNANDEZ SEBASTIAN","NAVAS CEDEO ANGEL","NIETO ROLONG MARY","ORTEGA BENITEZ IVIAN","ORTEGA MANGA ANGELLYS","PATINO BORRERO HARRISON","PEREZ ALVAREZ MARIA","PEREZ NATERA VALENTINA","PIMIENTA OTERO LAURENS","POLO REDONDO MARIA","PRADA SARMIENTO BRAYAN","SANTIAGO DACONTE ANDRES","SIERRA CASTILLO MAURICIO","SIERRA GOMEZ LIZETH","SMITH SANTIAGO VALERIA","SUAREZ GALLARDO MATEO","TORRES FERNANDEZ SANTIAGO","ZARATE REDONDO YAJAIRA"],
            '8A':["ARIZA CONSUEGRA STEISY","BARRAZA HERNANDEZ RONALD","BARRIOS MOLINA LITZY","BECERRA CRESPO MANOLO","BELLIDO CASIANO LEIDER","BERRUEZO ORTEGA SAMANTHA","BLANCO REYES ANGEL","BOLIVAR ESCOBAR VALENTINA","CIRO ROMERO ANGELA","DE LA CRUZ SIERRA ALAN","DITA ESCALANTE GILMAR","ESCALANTE OSPINO ANDERSON","ESCOBAR ALGARIN LILiana","GOMEZ VILLA ANA","GUTIERREZ PAEZ ANA","JIMNEZ QUINTANA FREDDY","JIMENEZ RUA NASLI","LLANOS REDONDO ADRIANA","LLANOS REYES ANDRES","MARQUEZ MARIN VALERIN","MARQUEZ VILORIA EMILY","MARTINEZ ORTEGA JESUS","MOLINA GUTIERREZ JULIE","ORDOEZ GARCIA LEONARDO","PACHECO AVILA MARIA","PEREZ ARAUJO ANDRS","REDONDO PATIO DELEVIS","RODRIGUEZ SANJUAN SALOME","SANTIAGO JULIO ASLY","SIERRA GOMEZ LUISA","SILVERA GOMEZ GABRIEL","SILVERA ORTEGA MAYLER","TEJERA ORTEGA LUIS","VANEGAS DE LA CRUZ DANIELA","VEGA ORTIZ EYEELIN","VELASQUEZ GARCIA MANUEL"],
            '8B':["AREVALO ARCON JOSE","BARRETO ROLONG MARIANA","BARRIOS PUENTES BLAYNER","BULA PEREZ MARIA","BUSTOS BARRIOS HONEY","CASTRO CASTRO DASHARY","CASTRO HARO JEAN","CONTRERAS SANJUAN IVANNA","CORREDOR BARBOSA SAMUEL","COTES ESCALANTE YESID","GARCIA VARELA SHADAY","GONZALEZ SILVERA LILIBETH","HEREDIA LOPEZ EYLIN","HERNANDEZ DE LA CRUZ MIGUEL","HERNANDEZ LLANOS GUADALUPE","HERNANDEZ LLANOS JESE","HERRERA POLO LINA","JAIME ROA ANYELO","LINARES ESTEVEZ MAYTE","LUQUE GONZALEZ YANKELIS","MONSALVO QUINTERO ADRIAN","MONTERROSA CABALLERO LAURA","NORIEGA REDONDO WENDY","POLO JIMENEZ NORELLA","RADA GUTIERREZ AISHA","REDONDO FRANCO LUIS","RINCON PEREZ ANGIELIN","SALAZAR ZAMBRANO RICHARD","SIERRA OROZCO ANGGY","SILVERA ESCOBAR DAYAR","SILVERA JIMENEZ NICOLL","SILVERA SANJUAN ADALYANA","SOSA BERRIO DEICY","SUAREZ DURAN JOSTIN","TOMASES RADA THIAGO","URANGO PACHECO DEILER","VILLAMIL HERNANDEZ XIMENA"],
            '8C':["ACOSTA CAICEDO DAIMAR","ACUA VALENCIA LUIS","ARAUJO MENDOZA SIRIANA","BANDERA LLANOS SHAILETH","BURGUILLOS CARBONELL JHOSNIEL","CARDENAS CHIQUILLO MICHAELL","CASTRO GOMEZ SHERIL","CERVANTES LARA MAURO","DE LA CRUZ PIERES SERGIO","DE LA CRUZ REDONDO ANTONY","DE LA HOZ CABAS YEFFER","ESCORCIA MIRANDA GUADALUPE","FERRER SANTANDER DAMIAN","GARCIA PEATE MARIA","GARCIA ROJAS TIFFANY","GOMEZ OTERO JANNIER","GONZALEZ SALCEDO MARIA","HURTADO ORTIZ ALAN","LLANOS TAGUER BRANDON","MADERA ORTEGA ANA","MEZA SIERRA JAMES","MORALES PERCY KEREN","OLANO PAZ YARIANGEL","ORTEGA SIERRA VALENTINA","PEREZ GONZALEZ SHAIRA","PEREZ NAVAS VALENTINA","POLO GUERRA XAVIER","RADA CORRO STEPHANIE","RANGEL SIERRA LAUREN","RICO ZAPATA DANNA","RIVALDO PALMA MILAGRO","RIVALDO PALMA TA","ROSANIA MINDIOLA DIEGO","SARMIENTO MARTINEZ MARI","SILVA SILVERA SOFIA","SILVERA CERVANTES MILTON","TRIGOS OROZCO SHELSY"],
            '8D':["ACOSTA HERNANDEZ EMILY GISELL","ACUA MARTINEZ JOB DAVID","ANGULO DE LA CRUZ NAHIARA MICHEL","BALVIN ROMERO NORMA GABRIELA","CABALLERO ACEVEDO MARIA ALEJANDRA","CABELLO NATERA STEVE EMANUEL","CONTRERAS SARMIENTO ANGELLYS NICOLLE","COSSIO NARVAEZ ANGELA VICTORIA","ESTRADA LLANOS MOISES ALEXANDER","FRANCO RODRIGUEZ JUAN DAVID","GUZMAN PEATE LUIS ALBERTO","HERNANDEZ PALLARES FERNANDO JUNIOR","HERNANDEZ REDONDO SHAYRA NICOLL","JIMENEZ ACUA MARIANA ISABEL","JIMENEZ SIERRA KAROL SOFIA","LLERENA IMITOLA JADER JOSE","MADARIAGA LOPEZ LUISA FERNANDA","MAESTRE DE LA HOZ MARIELYS MILETH","MENDOZA GOEZ DANIELA ROSA","MOLINA PALLARES MATIAS","MONCADA SIERRA MARIA CAROLINA","MORALES ORTEGA JOSSUET","OROZCO GONZALEZ DULCE MARIA","ORTEGA HERNANDEZ SARAY DE JESUS","PACHECO SILVERA ANGILIS MILETH","PINO MARIANO MARIANA PATRICIA","POLO ORELLANO JUAN SEBASTIAN","POLO VERGARA SHARY SOFA","RANGEL MARTINEZ MELANI PAOLA","RINCON GOMEZ ALEJANDRO DAVID","ROA RADA DANIEL DE JESUS","ROA RADA EDGAR ANDRES","RODRIGUEZ BUSTILLO GABRIELA LUCIA","ROLONG GOEZ JUAN ANDRES","ROMERO PEA NEYMAR","RUDAS VARGAS YAIRIS MARIA","SANTIAGO REYES OMER DE JESUS","SIERRA CASTILLO LUIS JOSE","SIERRA VARELA ANDREA CAMILA"],
            '9A':["ACOSTA PADILLA OVER","ACOSTA PALMA CRISTHIAN","AMADOR PALMA ALVARO","ARCON ALVAREZ SEBASTIAN","ARTETA CONSUEGRA JANNY","AVILA MEZA MAUREN","BARRAZA SIERRA LUIS","BARRIOS LLANOS GERALDINE","BARRIOS SIERRA BRIANA","CAMARGO DE LA CRUZ LEINYS","CAMARGO MARTINEZ MARIA","CANOSA CERVANTES VIVIANA","CORTES PIA JHOVANNY","COSSIO NARVAEZ HEIDY","DE LA HOZ VIZCAINO BUENDI","ESCORCIA BLANCO MELANY","ESCORCIA MIRANDA JESUS","FERNANDEZ ANGULO SHARICK","GALINDO ESCALANTE SHARON","GALLARDO BRADFORD JHOYMAR","LOPEZ MITROBICH MARIMAR","MARRIAGA SANJUAN SOCHY","MURILLO SILVERA YEYCI","ORELLANO MOLINA CICLALIS","ORTIZ PEREZ CRISTIAN","OTERO CARDENAS ADAN","OTERO NIETO JAIR","PEA MEZA VICTOR","POLO CONTRERAS ANDERSON","POLO PALMA SAILLY","RADA JIMNEZ JESUS","RADA NIEVES DAMARIS","REDONDO SALGADO ALEJANDRA","RODRIGUEZ ANGULO DANNA","SALAZAR IGLESIAS TALIANA","SANTIAGO LOPEZ MARIA","SARMIENTO CERVANTES VALEREE","SARMIENTO DE LA RANS ALAN","TURBAY GOMEZ LAIONEL","ZAPATA ROA LUIS"],
            '9B':["ANGULO BARRAGAN CARLOS","ARAUJO ESCALANTE YELIANYS","ARTETA ZARATE JHAN","BARRAZA CAFIEL VALENTINA","BLANCO ESTRADA JENIFER","BLANCO SILVERA YAIKOVIC","BOLIVAR MARRIAGA YANDERSON","ESCOBAR ALGARIN JOSE","FERRER SANTANDER LOGAN","FONTALVO PUELLO CRISTIAN","GARCIA CAMARGO ANGELY","GERONIMO ROJAS EMMANUEL","GIL GUTIERREZ A","GOENAGA LEJARDE JULIANNY","GUTIERREZ SIERRA SANTIAGO","HERNANDEZ LOPEZ MARIA","HERNANDEZ MONTAO MARIA","JIMENEZ CONSUEGRA TANIA","MARIN MORALES GENESIS","MARTINEZ DAZA EILYN","MEDINA RIQUETT KELLY","MOLINA VELASQUEZ LERVYS","MORALES OTERO JESUS","MOVILLA BOLIVAR EYMIS","NAVARRO GUTIERREZ ALEJANDRO","ORTEGA CUERVO KRISTEL","ORTIZ JIMENEZ ELIATH","PALMA SILVERA MARISOL","PATIO CONSUEGRA ANDRYS","PEREZ ALGARIN LUCIANA","PEREZ BOLIVAR JHONEFFER","REDONDO RODRIGUEZ KARLA","RODRIGUEZ VEGA YESID","RUIZ MARENco JUAN","SILVERA JIMENO THALIANA","TEJERA ORTEGA VALENTINA","TESILLO PEREZ CARLOS","TORRADO NOREA CRISTIAN","ZAPATA SIERRA LUCYANA"],
            '9C':["BALLESTAS DE LA CRUZ OWEL","BARANDICA GUTIERREZ IKER","CAMARGO CABALLERO JHONNY","CONSUEGRA HERNANDEZ ANGIE","DIAZ DEL TORO SHARILYN","ESCORCIA BORNACELLY NATHALIA","ESCORcia DE LA CRUZ LUISA","ESTRADA RUA JHON","GOENAGA DE AVILA CARLOS","GONZALEZ CONTRERAS YURLANYS","GONZALEZ FERRER MAIRELYS","GONZALEZ LLANOS ANA","GONZALEZ RICO JAVIER","HURTADO ORTIZ AMY","JIMENEZ BADILLO JUAN","JIMENEZ DE LA CRUZ JUSETH","LINARES TEJEDA MARCELA","LUBO JIMENEZ ALEJANDRO","MARTINEZ CASTILLO DANNA","MEDINA SILVERA DILAN","MIRANDA FERNANDEZ ANTONNY","MOLINA ARRIETA KAIRETH","OCHOA ORTEGA JOSE","ORTEGA LUNAR DIEGO","PEREZ GERONIMO EYMER","PRADA SARMIENTO SHARICK","REDONDO BERDUGO MARIANA","RICAURTE SANTANA MARIA","RIOS ARCON ARANZA","RIOS NAVAS VICTOR","ROA DE LA CRUZ PEDRO","ROMERO JIMENEZ STEVAN","SILVERA LINARES ANDRES","SILVERA VILORIA SNEYDER","VARGAS CASTRO SAMIR","VILORIA CABARCAS ESTEFANY"],
            '9D':["AMAYA PAZ JEIVER","ARDILA ORDUZ ALISSON","BLANCO SIERRA ANDY","BUSTOS BARRIOS ANGEL","CABRERA ORTEGA DAVID","CARBONELL BOSSA MAURICIO","CELIN VELASQUEZ MARLIN","ESCALANTE ACENDRA ANA","GAMARRA GONZALEZ GABRIEL","HERNANDEZ ARJONA JOSUE","JIMENEZ DE MOYA SARAY","LEJARDE PERTUZ ASLHEY","LOPEZ GARCIA ANGEL","LOPEZ RAMOS OSIEL","MARTINEZ GARCIA MELANIE","MENDOZA DE LA CRUZ LAURY","MERIDIANO CARDENAS DIEGO","NITROBICH RIAO YEISON","ORELLANO PALMA ELIANA","OROZCO GOMEZ JEISYS","ORTEGA GIL ALLISON","OTERO JIMENO SHADYA","OTERO MORALES DILAN","PADILLA BORRERO AYLIM","PALMA BARRAZA XAVI","PALMA SILVERA MARILUNA","RANGEL MARTINEZ GENESIS","REAL BARRIOS JUNIO","ROBLES MARIN JASSER","RODRIGUEZ DEL VILLAR JOAN","SALAS MALDONADO ALIANYS","SANJUAN PERTUZ JOSSED","SANTIAGO BARROS SHEILA","SILVERA ORTEGA ALEJANDRO","TORRES DE LA HOZ DUVAN"],
            '10C':["ACOSTA DE LA CRUZ ISACC","ACUA RADA SARESTH","BENEDETTI GARCIA GLEINER","BORGE FLOREZ MARIA","CANTILLO NORIEGA KEIVEN","CONSUEGRA GOYENECHE HANYDANIELS","CONSUEGRA JARAMILLO MARIA","CONSUEGRA POLO EDU","CORRO IBAEZ DAVID","DE LA HOZ ARTETA ANGELINE","GOMEZ MARTINEZ NADIA","GOMEZ OROZCO ANGIE","GUTIERREZ OJEDA ANTONE","LAFAURie SILVERA JUAN","LEAL QUINTANILLA JESUS","MARIANO OROZCO NICOLL","MELENDEZ CAMBERO WILIANNIS","MENDOZA ESCALANTE DILAN","NAVAS BOLIVAR JAMER","OROZCO ARAUJO MARIA","ORTEGA GARCIA JULIANA","OSPINO DE LA CRUZ JOSE","OVIEDO MOLINA THAILY","PADILLA CONRADO JAIRO","PALLARES DE LA RANS JUAN","PALMA PEREZ DANNA","PEREZ DE LA CRUZ LIS","RADA TAMAYO JASIR","RANGEL MARTINEZ LIS","RODRIGUEZ BLANCO ZAMIRA","SALGADO VERDEZA MARIA","SARMIENTO ACUA DULCE","SARMIENTO PALMA MANUEL","SIERRA DE LA CRUZ LAUREEN","SILVERA SANTIAGO JUAN","SUAREZ SIERRA MARIA"],
            '11A':["ALBA BOLIVAR GABRIELA","ARDILA ORDUZ KAREN","BLANCO SILVERA YUGEIDIS","BOLIVAR SANTIAGO EDWIN","CERA SILVERA BRIANDA","CUETO REDONDO YULIFER","DE LA HOZ LOPEZ ROSA","DE MOYA PALLAREZ ADRIAN","FLOREZ SOLANO JUAN","FRANCO FRANCO VALERY","GONZALEZ DE LA CRUZ YICEL","HERNANDEZ JULIO ISABELA","HERNANDEZ MARRIAGA KARLA","HIGUITA ZAPATA VALENTINA","HOUSSET VALENCIA CRISTOBAL","HOUSSET VALENCIA TALIANA","IBAEZ NIETO MAYLAN","JIMENEZ ROA STALYN","LOPEZ MERCADO YULIMAR","MORALES OTERO ANA","ORTEGA BOLIVAR MARIETH","OSPINO NIETO WANDA","PALMA PACHECO JONATHAN","RADA POLO STIVE","REYES VILLALOBOS SHEILYN","ROLONG SIERRA ","ROMERO RODRIGUEZ LUISA","SANTIAGO CUETO KERLYN","SANTIAGO DE LA ROSA RITA","SERJE GARCIA MISSELL","VASQUEZ CHARRIS YELIS","VELASQUEZ ZAMBRANO DANIEL"],
            '11B':["ALBOR SILVERA ALEJANDRA","AMAYA QUINTERO DUVAN","BAZA ESCOBAR YORELIS","CERVANTES LARA DEREEK","CONSUEGRA DE LA CRUZ SERGIO","CORRO GONZALEZ ANDRES","CORRO HERRERA JULIAN","CUENTAS SIERRA LAUREN","ESCOBAR ALGARIN FELICIDAD","GONZALEZ GIL NATALIA","GONZALEZ HURTADO LAURA","GUZMAN NUEZ LAUREN","MARQUEZ MIRANDA JOHAN","MAURY SALGADO ALISSON","MEJIA GONZALEZ ISABELLA","MIRANDA DE MOYA EVANGELLY","MONTERROSA RODRIGUEZ ANDRES","OROZCO VASQUEZ ROSAURA","ORTEGA SIERRA YULIANA","PADILLA REDONDO YESSICA","PEREZ DE LA CRUZ JESUS","PEREZ FRANCO YORIANA","QUINTERO COBA EDIER","REDONDO TORRES YESICA","RODRIGUEZ CARPINTERO CAMILA","ROJO CARDONA MISHELL","SANTIAGO NATERA JOHN","SIERRA FIGUEROA LUCILA","VALLEJO CASTILLO ISABELLA","VARGAS MOLINA SEBASTIAN"],
            '11C':["ALTAMAR CABALLERO PAOLA","ARIZA PEREZ DILAN","ARROYO CORREDOR ANDRES","BARRETO GUTIERREZ SLAYNE韦","BONILLA GUTIERREZ SHARON","CASTIBLANCO IBAEZ IAN","DE LA CRUZ ARRIETA ANGEL","DE LA CRUZ CAMARGO SERGIO","DE LA CRUZ SARMIENTO MARIA","DE LA HOZ MUOZ LUISA","DE LA HOZ SIERRA JOHAN","DE LOS REYES TAMAYO YOSETH","DELGADO HERNANDEZ SOFIA","ESCALANTE QUIROZ JESUS","ESCOBAR SALCEDO JUSEPH","ESCORCIA JIMENEZ ANDRES","GALLARDO PANCHA GABRIELA","GOEZ SERRANO EMMANUEL","HERNANDEZ CERVANTES PABLO","HERNANDEZ MUOZ DANA","HERRERA MENDOZA ESTeban","MARQUEZ MIRANDA JAZIR","ORELLANO BOLIVAR KEIDDER","PACHECO SIERRA ADRIANA","PARRA REDONDO JUAN","REDONDO MENDOZA MARIANGEL","RIVERO COBA GLEIDYS","SALAZAR LLANOS YAMITH","SANCHEZ CELIS DIEGO","SANTAMARIA BORJA ANDREA","SIERRA GARCIA OSCAR","VASQUEZ ARZUZA ALAM","VERGARA BARRIOS KLEIVER"],
            '11D':["ARIZA DE LA CRUZ SEBASTIAN","ARIZA SILVERA JORGE MARIO","BLANCO ESCALANTE SAIDER","BOLIVAR VIVANCO NICOL","BORGE GOENAGA SHADIA","CABALLERO BARRIOS BREIDER","CHICO MARTINEZ DAIRON","CONSUEGRA SILVERA SARAY","ESCALANTE GONZALEZ DANIELA","GALLARDO BRADFORD NAYALITH","GARZON GALINDO LENIN","GONZALEZ DE LA RANS SHARLET","GUTIERREZ MENDOZA JOSE","GUTIERREZ VASQUEZ PAULA","MELENDRES VILLALBA KEIMER","MEZA GARCIA CARLOS","MORA SILVERA DEYNER","ORTEGA GONZALEZ LEWIN","PADILLA PARRA MARY","PALMA DE LA HOZ LUIS","PEDRAZA OLIVEROS MATHIAS","PEDROZA GALLARDO SCARLETT","PEREZ VEGA NICOL","RODRIGUEZ SALAS YORYANIZ","SANTIAGO SOLANO AXEL","VARGAS ALBIS YERSON","VARGAS MUOZ SHERIT","VELILLA ACOSTA CAMILO"]
        };
        let searchTimeout;
        let statsChart;
        
        // --- App Initialization Block ---
        document.addEventListener('DOMContentLoaded', () => {
            const getUIElements = () => {
                const ids = [
                    'attendanceTableContainer', 'courseTitle', 'courseInfo', 'tabNavigation', 
                    'searchBox', 'darkModeToggle', 'exportCsvBtn', 'importStudentsBtn', 
                    'importFile', 'statsPanel', 'obsModal', 'dateNoteModal', 'gradeNoteModal', 
                    'settingsModal', 'courseManagementModal', 
                    'studentReportModal', 'bulletinModal', 'exportModal', 'gradesModal', 
                    'gradesStudentName', 'gradesGrid', 'bulletinBtn', 'bulletinSelectionModal', 
                    'periodSelector', 'settingsBtn', 'todayBtn', 'voiceInputBtn', 'voiceGradeModal', 
                    'rankingBtn', 'rankingModal', 'dataManagementBtn', 'dataManagementModal', 
                    'exportJsonBtn', 'importJsonBtn', 'importJsonFile', 'closeDataManagementModal',
                    'obsStudentName', 'obsHistory', 'predefinedObs', 'obsTextarea', 'saveObs',
                    'dateNoteDate', 'dateNoteTextarea', 'saveDateNote', 'gradeNoteTitle',
                    'gradeNoteTextarea', 'saveGradeNote', 'studentReportContent',
                    'printStudentReportBtn', 'bulletinContent', 'downloadPngBtn', 'downloadPdfBtn',
                    'closeObsModal', 'closeDateNoteModal', 'closeGradeNoteModal', 'closeSettingsModal',
                    'saveSettingsBtn', 'closeCourseManagementModal', 'addStudentBtn', 'newStudentName',
                    'closeBulletinModal', 'closeExportModal', 'exportCurrentBtn', 'exportAllBtn',
                    'exportSelectedBtn', 'closeGradesModal', 'saveGrades', 'closeBulletinSelectionModal',
                    'generateAllCoursesBulletinBtn', 'generateCurrentCourseBulletinBtn',
                    'generateSelectedCoursesBtn', 'selectAllStudentsBtn', 'deselectAllStudentsBtn',
                    'generateSelectedStudentsBtn', 'closeRankingModal', 'closeVoiceGradeModal',
                    'voiceListenBtn', 'voiceCourseSelector', 'voiceModeSelector', 'addPeriodBtn', 'newPeriodName',
                    'voiceStudentList', 'voiceGradeList', 'voiceStatus', 'voiceTranscript', 'closeStudentReportModal',
                    'courseManagementTitle', 'studentManagementList', 
                    'passwordConfirmModal',
                    'passwordConfirmTitle', 'passwordInput', 'passwordErrorMsg', 'closePasswordConfirmModal',
                    'confirmPasswordBtn', 'editObsModal', 'editObsTextarea', 'closeEditObsModal', 'saveEditObs',
            'groupGradeModal', 'groupGradeComponent', 'groupGradeStudentCount', 'groupGradeInput',
            'closeGroupGradeModal', 'saveGroupGrade', 'advancedCleanBtn', 'advancedDeleteModal',
            'closeAdvancedDeleteModal', 'confirmAdvancedDeleteBtn', 'promoteStudentsBtn',
            'promoteModal', 'closePromoteModal', 'confirmPromoteBtn', 'promoteSourceCourse',
            'promoteTargetSelect', 'promoteTargetInput', 'togglePromoteTarget', 'promoteStudentList',
            'promoteSelectAll', 'promoteDeselectAll', 'advDeleteCourseName', 'promoteCurrentCourseLabel',
            'promoteSingleOptions', 'promoteBatchOptions', 'promoteBatchSuffix', 'promoteStudentListContainer',
            'editScheduleBtn', 'scheduleModal', 'closeScheduleModal', 'saveScheduleBtn', 'scheduleGrid',
            'promoteSuffixContainer'
        ];
        ids.forEach(id => { ui[id] = document.getElementById(id); });
    };
    
    const formatStudentName = (str) => !str ? '' : str.trim().toUpperCase();
            
            // --- Utility & Calculation Functions ---
            const getDayForCourse = (course) => { 
                for (const day in dailySchedule) { 
                    if (dailySchedule[day].includes(course)) return day; 
                } 
                return null; 
            };
            const getAttendanceDates = (course) => {
                const dayName = getDayForCourse(course);
                if (!dayName) return [];

                const periodConfig = appSettings.periods.find(p => p.name === activePeriod);
                if (!periodConfig || !periodConfig.start || !periodConfig.end) {
                    console.warn(`Periodo "${activePeriod}" no tiene fechas de inicio/fin definidas.`);
                    return [];
                }
                
                const dayNumber = dayNameToNumber[dayName];
                const dates = [];
                // Add T00:00:00 to avoid timezone issues where the date might shift
                const start = new Date(periodConfig.start + 'T00:00:00');
                const end = new Date(periodConfig.end + 'T00:00:00');
                let current = new Date(start);

                while (current <= end) {
                    if (current.getDay() === dayNumber) dates.push(new Date(current));
                    current.setDate(current.getDate() + 1);
                }
                return dates;
            };
            const showMessage = (text, type = 'success') => {
                const box = document.createElement('div');
                box.className = 'message-box fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white transition-opacity duration-300 z-50';
                box.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
                box.textContent = text;
                document.body.appendChild(box);
                setTimeout(() => {
                    box.style.opacity = '0';
                    setTimeout(() => box.remove(), 300);
                }, 3000);
            };
            const getGradeValue = (grades, field) => parseFloat(grades[field]) || 0;
            const calculateAverage = (gradesArray) => { const valid = gradesArray.filter(g => g > 0); return valid.length === 0 ? 0 : valid.reduce((a, b) => a + b, 0) / valid.length; };
            
            const calculateDef = (grades) => {
                const g = grades || {};
                const p = appSettings.percentages;
                const gs = appSettings.gradeStructure;
                let cognitiveGrades = [];
                for(let i = 1; i <= gs.cognitive; i++) cognitiveGrades.push(getGradeValue(g, `cognitivoC${i}`));
                
                let proceduralGrades = [];
                for(let i = 1; i <= gs.procedural; i++) proceduralGrades.push(getGradeValue(g, `procedimentalP${i}`));

                let attitudinalGrades = [];
                for(let i = 1; i <= gs.attitudinal; i++) attitudinalGrades.push(getGradeValue(g, `actitudinalA${i}`));

                const cAvg = calculateAverage(cognitiveGrades);
                const pAvg = calculateAverage(proceduralGrades);
                const aAvg = calculateAverage(attitudinalGrades);

                const def = ((cAvg * p.cognitive / 100) + (pAvg * p.procedural / 100) + (aAvg * p.attitudinal / 100));
                return isNaN(def) ? "0.00" : def.toFixed(2);
            };
            const determineNivel = (def) => { const s = parseFloat(def); if (s>=1&&s<=2.99)return"Bajo";if (s>=3&&s<=3.99)return"B谩sico";if (s>=4&&s<=4.59)return"Alto";if(s>=4.6&&s<=5)return"Superior";return""; };
            const calculateAttendanceSummary = (attendance) => {
                const att = attendance || {};
                let a=0,p=0,e=0,t=0; 
                for(const d in att) {
                    if(att[d]===true) p++;
                    else if(att[d]===false) a++;
                    else if(att[d]==='excused') e++;
                    else if(att[d]==='late') t++;
                } 
                return {attended: p, absent: a, excused: e, late: t}; 
            };
            
            const debounce = (func, delay) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(func, delay);
            };

            // --- Table Rendering ---
            const renderTable = () => {
                try {
                    if (!activeCourse) return;
                    const config = allStudentsData[activeCourse];
                    if (!config) {
                        ui.attendanceTableContainer.innerHTML = `<div class="p-4 text-center">No hay estudiantes en este curso. Puede a帽adirlos en la configuraci贸n del curso.</div>`;
                        ui.courseTitle.innerHTML = `Grupo: ${activeCourse} <i class="fas fa-edit text-lg text-gray-400 hover:text-blue-500 cursor-pointer ml-2" onclick="window.showCourseManagementModal()"></i>`;
                        ui.courseInfo.innerHTML = `<p>Docente: ${appSettings.professor}</p><p>Asignatura: ${appSettings.subject}</p>`;
                        calculateAndDisplayStats();
                        return;
                    }

                    const data = gradesData[activePeriod]?.[activeCourse] || {};
                    const attendanceDates = getAttendanceDates(activeCourse);
                    const searchTerm = ui.searchBox.value.toLowerCase();
                    const filteredStudents = config.filter(s => s && typeof s === 'string' && s.toLowerCase().includes(searchTerm));
                    const gs = appSettings.gradeStructure;

                    ui.courseTitle.innerHTML = `Grupo: ${activeCourse} <i class="fas fa-edit text-lg text-gray-400 hover:text-blue-500 cursor-pointer ml-2" onclick="window.showCourseManagementModal()"></i>`;
                    ui.courseInfo.innerHTML = `<p>Docente: ${appSettings.professor}</p><p>Asignatura: ${appSettings.subject}</p>`;

                    const tableEl = document.createElement('table');
                    tableEl.style.minWidth = `${510 + (attendanceDates.length * 60) + ((gs.cognitive + gs.procedural + gs.attitudinal) * 70)}px`;
                    
                    let cognitiveHeaders = '';
                    for(let i=1; i<=gs.cognitive; i++) {
                        const hasNote = (data.columnNotes?.[`C${i}`] || data.columnNotes?.[`P${i}`] || data.columnNotes?.[`A${i}`] || '').trim() !== '';
                        cognitiveHeaders += `<th class="grade-column">C${i} <i class="fas fa-users cursor-pointer text-xs ml-1 text-gray-400 hover:text-green-400" onclick="window.showGroupGradeModal('cognitivoC${i}', 'Cognitivo C${i}')"></i> <i class="fas fa-comment cursor-pointer text-xs ml-1 ${ hasNote ? 'text-amber-400' : 'text-gray-400'} hover:text-amber-500" onclick="window.showGradeNoteModal('C${i}')"></i></th>`;
                    }
                    let proceduralHeaders = '';
                    for(let i=1; i<=gs.procedural; i++) {
                        const hasNote = (data.columnNotes?.[`C${i}`] || data.columnNotes?.[`P${i}`] || data.columnNotes?.[`A${i}`] || '').trim() !== '';
                        proceduralHeaders += `<th class="grade-column">P${i} <i class="fas fa-users cursor-pointer text-xs ml-1 text-gray-400 hover:text-green-400" onclick="window.showGroupGradeModal('procedimentalP${i}', 'Procedimental P${i}')"></i> <i class="fas fa-comment cursor-pointer text-xs ml-1 ${ hasNote ? 'text-amber-400' : 'text-gray-400'} hover:text-amber-500" onclick="window.showGradeNoteModal('P${i}')"></i></th>`;
                    }
                    let attitudinalHeaders = '';
                    for(let i=1; i<=gs.attitudinal; i++) {
                        const hasNote = (data.columnNotes?.[`C${i}`] || data.columnNotes?.[`P${i}`] || data.columnNotes?.[`A${i}`] || '').trim() !== '';
                        attitudinalHeaders += `<th class="grade-column">A${i} <i class="fas fa-users cursor-pointer text-xs ml-1 text-gray-400 hover:text-green-400" onclick="window.showGroupGradeModal('actitudinalA${i}', 'Actitudinal A${i}')"></i> <i class="fas fa-comment cursor-pointer text-xs ml-1 ${ hasNote ? 'text-amber-400' : 'text-gray-400'} hover:text-amber-500" onclick="window.showGradeNoteModal('A${i}')"></i></th>`;
                    }

                    let tableHTML = `
                        <thead>
                            <tr>
                                <th rowspan="2" class="sticky-left sticky-col-select"><input type="checkbox" id="selectAllCheckbox"></th>
                                <th rowspan="2" class="sticky-left sticky-col-no">No</th>
                                <th rowspan="2" class="sticky-left sticky-col-name">NOMBRE</th>
                                <th rowspan="2" class="sticky-left sticky-col-actions">Acciones</th>
                                <th rowspan="2" class="sticky-left sticky-col-summary">ASIST.</th>
                                <th class="attendance-column" colspan="${attendanceDates.length}">ASISTENCIA POR FECHA</th>
                                <th class="grade-column" colspan="${gs.cognitive}">COGNITIVO (${appSettings.percentages.cognitive}%)</th>
                                <th class="grade-column" colspan="${gs.procedural}">PROCEDIMENTAL (${appSettings.percentages.procedural}%)</th>
                                <th class="grade-column" colspan="${gs.attitudinal}">ACTITUDINAL (${appSettings.percentages.attitudinal}%)</th>
                                <th rowspan="2" class="grade-column col-def">DEF</th>
                                <th rowspan="2" class="grade-column col-nivel">NIVEL</th>
                            </tr>
                            <tr>
                                ${attendanceDates.map(d => {
                                    const dateString = d.toISOString().split('T')[0];
                                    const note = data.dateNotes?.[dateString] || '';
                                    const noteIconClass = note ? 'fas fa-comment-dots text-yellow-300' : 'fas fa-plus-circle text-gray-400';
                                    return `<th class="date-header attendance-column">
                                        <div>
                                            ${d.getDate()}/${d.getMonth()+1} 
                                            <i class="${noteIconClass} cursor-pointer hover:text-yellow-500 text-xs ml-1" onclick="window.showDateNoteModal('${dateString}')"></i>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <button class="attendance-bulk-btn bg-green-500" onclick="window.markAllAttendance('${dateString}', true)"></button>
                                            <button class="attendance-bulk-btn bg-red-500" onclick="window.markAllAttendance('${dateString}', false)"></button>
                                            <button class="attendance-bulk-btn bg-indigo-500" onclick="window.markAllAttendance('${dateString}', 'excused')">E</button>
                                            <button class="attendance-bulk-btn bg-yellow-500" onclick="window.markAllAttendance('${dateString}', 'late')">T</button>
                                        </div>
                                    </th>`;
                                }).join('')}
                                ${cognitiveHeaders}
                                ${proceduralHeaders}
                                ${attitudinalHeaders}
                            </tr>
                        </thead>
                        <tbody>`;
                    
                    filteredStudents.forEach((student, index) => {
                        const studentData = data[student] || { grades: {}, attendance: {}, observations: [] };
                        const hasObs = studentData.observations && studentData.observations.length > 0;
                        const studentDef = calculateDef(studentData.grades);
                        const nivel = determineNivel(studentDef);
                        const summary = calculateAttendanceSummary(studentData.attendance);
                        const formatGrade = (g) => !isNaN(parseFloat(g)) ? parseFloat(g).toFixed(1) : '';

                        let gradeCellsHTML = '';
                        for(let i=1; i<=gs.cognitive; i++) gradeCellsHTML += `<td class="grade-column grade-cell" data-student="${student}" data-field="cognitivoC${i}">${formatGrade(studentData.grades?.[`cognitivoC${i}`])}</td>`;
                        for(let i=1; i<=gs.procedural; i++) gradeCellsHTML += `<td class="grade-column grade-cell" data-student="${student}" data-field="procedimentalP${i}">${formatGrade(studentData.grades?.[`procedimentalP${i}`])}</td>`;
                        for(let i=1; i<=gs.attitudinal; i++) gradeCellsHTML += `<td class="grade-column grade-cell" data-student="${student}" data-field="actitudinalA${i}">${formatGrade(studentData.grades?.[`actitudinalA${i}`])}</td>`;

                        tableHTML += `<tr>
                            <td class="sticky-left sticky-col-select"><input type="checkbox" class="student-checkbox" value="${student}"></td>
                            <td class="sticky-left sticky-col-no">${index + 1}</td>
                            <td class="sticky-left sticky-col-name">${student}</td>
                            <td class="sticky-left sticky-col-actions">
                                <i class="fas fa-comment action-icon ${hasObs ? 'has-obs' : ''}" data-student-obs="${student}" title="Observaciones" onclick="window.showObservationsModal('${student}')"></i>
                                <i class="fas fa-id-card action-icon" title="Bolet铆n" onclick="window.showBulletinModal('${student}')"></i>
                                <i class="fas fa-chart-line action-icon" title="Informe de Estudiante" onclick="window.showStudentReportModal('${student}')"></i>
                                <i class="fas fa-edit action-icon action-grades-btn" title="Editar Notas" onclick="window.showGradesModal('${student}')"></i>
                            </td>
                            <td class="sticky-left sticky-col-summary">
                                <span>:${summary.attended}</span> <span>:${summary.absent}</span><br>
                                <span>E:${summary.excused}</span> <span>T:${summary.late}</span>
                            </td>`;
                        
                        attendanceDates.forEach(date => {
                            const dateString = date.toISOString().split('T')[0];
                            const status = studentData.attendance?.[dateString];
                            let a_class = 'attendance-box', a_content = '';
                            if (status === true) { a_class += ' attended'; a_content = ''; }
                            else if (status === false) { a_class += ' absent'; a_content = ''; }
                            else if (status === 'excused') { a_class += ' excused'; a_content = 'E'; }
                            else if (status === 'late') { a_class += ' late'; a_content = 'T'; }
                            tableHTML += `<td class="attendance-cell"><div class="${a_class}" data-student="${student}" data-date="${dateString}">${a_content}</div></td>`;
                        });
                        
                        tableHTML += gradeCellsHTML;
                        
                        const nivelClass = (nivel && typeof nivel === 'string') ? `nivel-${nivel.toLowerCase()}` : '';
                        tableHTML += `<td class="grade-column col-def ${nivelClass}">${studentDef}</td><td class="grade-column col-nivel ${nivelClass}">${nivel}</td></tr>`;
                    });
                    tableEl.innerHTML = tableHTML + `</tbody>`;
                    ui.attendanceTableContainer.innerHTML = '';
                    ui.attendanceTableContainer.appendChild(tableEl);

                    // Add event listener for the new "Select All" checkbox
                    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                    if (selectAllCheckbox) {
                        selectAllCheckbox.addEventListener('change', (e) => {
                            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                                checkbox.checked = e.target.checked;
                            });
                        });
                    }

                    calculateAndDisplayStats();
                } catch(e) {
                    console.error(`An error occurred while rendering the table for course "${activeCourse}":`, e);
                    ui.attendanceTableContainer.innerHTML = `<div class="p-4 text-center text-red-500">Ocurri贸 un error al mostrar la lista de estudiantes. Por favor, intente limpiar la cach茅 del navegador.</div>`;
                }
            };

            // --- Event Handlers & Data Management ---
            const ensureCourseData = (period, course) => {
                if (!gradesData[period]) gradesData[period] = {};
                if (!gradesData[period][course]) gradesData[period][course] = {};
                const courseData = gradesData[period][course];
                if (!courseData.dateNotes) courseData.dateNotes = {};
                if (!courseData.columnNotes) courseData.columnNotes = {};
            };

            const ensureStudentData = (period, course, student) => {
                ensureCourseData(period, course);
                if (!gradesData[period][course][student]) {
                    gradesData[period][course][student] = { grades: {}, attendance: {}, observations: [] };
                } else if (!gradesData[period][course][student].observations) {
                    gradesData[period][course][student].observations = [];
                }
            };
            
            const enableEdit = (cell) => {
                if (cell.querySelector('input')) return;
                const { student, field } = cell.dataset;
                ensureStudentData(activePeriod, activeCourse, student);
                const currentVal = gradesData[activePeriod][activeCourse][student].grades?.[field] || '';
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '1';
                input.max = '5';
                input.step = '0.1';
                input.className = 'grade-input';
                input.value = !isNaN(parseFloat(currentVal)) ? parseFloat(currentVal).toFixed(1) : '';
                cell.textContent = '';
                cell.appendChild(input);
                input.focus();

                const saveAndExit = () => {
                    const currentInput = cell.querySelector('input');
                    if (currentInput) {
                        updateGrade(student, field, currentInput.value, cell);
                    }
                }
                
                input.addEventListener('blur', saveAndExit);
                input.addEventListener('keydown', (e) => {
                    const navKeys = ['Enter', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Tab'];
                    if (!navKeys.includes(e.key)) return;
                    e.preventDefault();
                    const allGradeCells = Array.from(ui.attendanceTableContainer.querySelectorAll('.grade-cell'));
                    const currentIndex = allGradeCells.indexOf(cell);
                    const inputsPerRow = appSettings.gradeStructure.cognitive + appSettings.gradeStructure.procedural + appSettings.gradeStructure.attitudinal;
                    let nextCell = null;
                    if (e.key === 'Enter' || e.key === 'ArrowDown') nextCell = allGradeCells[currentIndex + inputsPerRow];
                    else if (e.key === 'ArrowUp') nextCell = allGradeCells[currentIndex - inputsPerRow];
                    else if (e.key === 'ArrowRight' || e.key === 'Tab') nextCell = allGradeCells[currentIndex + 1];
                    else if (e.key === 'ArrowLeft') nextCell = allGradeCells[currentIndex - 1];
                    input.blur();
                    if (nextCell) setTimeout(() => enableEdit(nextCell), 0);
                });
            };
            
            const updateGrade = (student, field, value, cellToUpdate) => {
                const course = ui.voiceGradeModal.classList.contains('active') ? ui.voiceCourseSelector.value : activeCourse;
                ensureStudentData(activePeriod, course, student);
                const studentData = gradesData[activePeriod][course][student];
                if (!studentData.grades) studentData.grades = {};
                let numVal = parseFloat(value);
                
                if (value !== '' && (isNaN(numVal) || numVal < 1 || numVal > 5)) {
                    showMessage('La nota debe estar entre 1 y 5.', 'error');
                    if (cellToUpdate) cellToUpdate.textContent = studentData.grades[field] || '';
                    return false;
                }
                
                studentData.grades[field] = value;
                
                if (cellToUpdate) {
                    cellToUpdate.textContent = value !== '' ? numVal.toFixed(1) : '';
                    
                    const studentRow = cellToUpdate.closest('tr');
                    if(studentRow) {
                        const newDef = calculateDef(studentData.grades);
                        const newNivel = determineNivel(newDef);
                        const nivelClass = newNivel ? `nivel-${newNivel.toLowerCase()}` : '';
                        const defCell = studentRow.querySelector('.col-def');
                        const nivelCell = studentRow.querySelector('.col-nivel');
                        defCell.textContent = newDef;
                        nivelCell.textContent = newNivel;
                        defCell.className = `grade-column col-def ${nivelClass}`;
                        nivelCell.className = `grade-column col-nivel ${nivelClass}`;
                    }
                }
                
                saveAllData(true);
                if (course === activeCourse) {
                    calculateAndDisplayStats();
                }
                return true;
            };

            const updateAttendance = (box) => {
                const { student, date } = box.dataset;
                ensureStudentData(activePeriod, activeCourse, student);
                const studentData = gradesData[activePeriod][activeCourse][student];
                if (!studentData.attendance) studentData.attendance = {};
                const currentStatus = studentData.attendance[date];

                const statusCycle = [true, false, 'excused', 'late', undefined]; // Attended, Absent, Excused, Late, Not Marked
                const currentIndex = statusCycle.indexOf(currentStatus);
                const newStatus = statusCycle[(currentIndex + 1) % statusCycle.length];

                if (newStatus === undefined) delete studentData.attendance[date];
                else studentData.attendance[date] = newStatus;

                box.className = 'attendance-box'; box.textContent = '';
                if (newStatus === true) { box.classList.add('attended'); box.textContent = ''; }
                else if (newStatus === false) { box.classList.add('absent'); box.textContent = ''; }
                else if (newStatus === 'excused') { box.classList.add('excused'); box.textContent = 'E'; }
                else if (newStatus === 'late') { box.classList.add('late'); box.textContent = 'T'; }


                const summary = calculateAttendanceSummary(studentData.attendance);
                const summaryCell = box.closest('tr').querySelector('.sticky-col-summary');
                if (summaryCell) summaryCell.innerHTML = `<span>:${summary.attended}</span> <span>:${summary.absent}</span><br><span>E:${summary.excused}</span> <span>T:${summary.late}</span>`;
                saveAllData(true);
                calculateAndDisplayStats();
            };

            window.markAllAttendance = function(dateString, status) {
                const config = allStudentsData[activeCourse];
                if (!config) return;
                const students = config;
                const data = gradesData[activePeriod]?.[activeCourse] || {};
                const allCurrentlyMarked = students.every(student => (data[student]?.attendance?.[dateString] === status));
                const newStatus = allCurrentlyMarked ? undefined : status;
                students.forEach(student => {
                    ensureStudentData(activePeriod, activeCourse, student);
                    if (!gradesData[activePeriod][activeCourse][student].attendance) gradesData[activePeriod][activeCourse][student].attendance = {};
                    if (newStatus === undefined) delete gradesData[activePeriod][activeCourse][student].attendance[dateString];
                    else gradesData[activePeriod][activeCourse][student].attendance[dateString] = newStatus;
                });
                saveAllData();
            }

            const saveAllData = (isPartial = false) => { 
                try { 
                    localStorage.setItem('gradesData_v3', JSON.stringify(gradesData)); 
                    localStorage.setItem('allStudentsData_v3', JSON.stringify(allStudentsData)); 
                    localStorage.setItem('dailySchedule_v3', JSON.stringify(dailySchedule)); 
                    if(!isPartial) { 
                        renderTable();
                    } else { 
                        // Silently save in the background for partial updates to avoid spamming messages.
                    }
                } catch (e) { console.error("Error saving data: ", e); } 
            };
            
            const loadAllData = () => {
                const savedGrades = localStorage.getItem('gradesData_v3');
                const savedStudents = localStorage.getItem('allStudentsData_v3');
                const savedSchedule = localStorage.getItem('dailySchedule_v3');
                
                gradesData = savedGrades ? JSON.parse(savedGrades) : {};
                allStudentsData = savedStudents ? JSON.parse(savedStudents) : allStudentsData;
                dailySchedule = savedSchedule ? JSON.parse(savedSchedule) : dailySchedule;

                // Simple migration from old structure if necessary
                if (localStorage.getItem('gradesData_v2')) {
                    gradesData = JSON.parse(localStorage.getItem('gradesData_v2'));
                    allStudentsData = JSON.parse(localStorage.getItem('allStudentsData_v2'));
                    dailySchedule = JSON.parse(localStorage.getItem('dailySchedule_v2'));
                    localStorage.removeItem('gradesData_v2');
                    localStorage.removeItem('allStudentsData_v2');
                    localStorage.removeItem('dailySchedule_v2');
                    saveAllData(true);
                    showMessage("Datos migrados a la nueva versi贸n.", "success");
                }
            };
            
            const saveSettings = () => {
                localStorage.setItem('appSettings_v3', JSON.stringify(appSettings));
                showMessage("Configuraci贸n guardada", "success");
            };

            const loadSettings = () => {
                const savedSettings = localStorage.getItem('appSettings_v3');
                const defaultSettings = {
                    professor: "Puertas Lopez Patricia Isabel",
                    subject: "Art铆stica Pl谩stica y Visual",
                    percentages: { cognitive: 40, procedural: 30, attitudinal: 30 },
                    periods: [{ name: "Periodo 3", start: "2025-09-22", end: "2025-11-28" }],
                    activePeriod: "Periodo 3",
                    gradeStructure: { cognitive: 3, procedural: 3, attitudinal: 3 },
                    predefinedObs: ["Excelente participaci贸n", "No entreg贸 la tarea", "Necesita mejorar la atenci贸n", "Comportamiento disruptivo"]
                };

                if (savedSettings) {
                    appSettings = JSON.parse(savedSettings);
                    // Ensure periods is an array of objects for backward compatibility
                    if (appSettings.periods && appSettings.periods.every(p => typeof p === 'string')) {
                        appSettings.periods = appSettings.periods.map(name => ({
                            name: name,
                            start: "2025-09-22", // Default start date
                            end: "2025-11-28"   // Default end date
                        }));
                    }
                } else {
                    appSettings = defaultSettings;
                }

                activePeriod = appSettings.activePeriod;
            };
            
            function applyTheme(isDark) {
                if (isDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                ui.darkModeToggle.checked = isDark;
            }

            // --- Confirmation Modal ---
            function showPasswordConfirm(title, onConfirm) {
                ui.passwordConfirmTitle.textContent = title;
                ui.passwordInput.value = '';
                ui.passwordErrorMsg.classList.add('hidden');
                
                const confirmHandler = () => {
                    if (ui.passwordInput.value === '55232122') {
                        onConfirm();
                        ui.passwordConfirmModal.classList.remove('active');
                    } else {
                        ui.passwordErrorMsg.classList.remove('hidden');
                    }
                };

                ui.confirmPasswordBtn.onclick = confirmHandler;

                ui.passwordInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        confirmHandler();
                    }
                };

                ui.passwordConfirmModal.classList.add('active');
                setTimeout(() => ui.passwordInput.focus(), 100);
            }
            
            window.showObservationsModal = function(student) {
                ensureStudentData(activePeriod, activeCourse, student);
                ui.obsStudentName.textContent = student;
                ui.obsTextarea.value = '';
                
                ui.obsHistory.innerHTML = '';

                ui.predefinedObs.innerHTML = '';
                appSettings.predefinedObs.forEach(obs => {
                    const button = document.createElement('button');
                    button.className = "bg-gray-200 dark:bg-gray-600 text-xs p-1 rounded hover:bg-gray-300";
                    button.textContent = obs;
                    button.onclick = () => {
                        ui.obsTextarea.value += (ui.obsTextarea.value ? '\n' : '') + obs;
                    };
                    ui.predefinedObs.appendChild(button);
                });

                const observations = gradesData[activePeriod][activeCourse][student].observations || [];

                if (observations.length === 0) {
                    ui.obsHistory.innerHTML = '<p class="text-gray-500">No hay observaciones registradas.</p>';
                } else {
                    observations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    observations.forEach(obs => {
                        const obsDate = new Date(obs.timestamp);
                        const formattedDate = obsDate.toLocaleString('es-CO', { dateStyle: 'short', timeStyle: 'short' });
                        const obsElement = document.createElement('div');
                        obsElement.className = 'p-2 border-b';
                        obsElement.style.borderColor = 'var(--border-color)';
                        obsElement.innerHTML = `
                            <div class="flex justify-between items-start">
                                <p class="whitespace-normal flex-grow">${obs.text.replace(/\n/g, '<br>')}</p>
                                <div class="flex-shrink-0 ml-4">
                                    <i class="fas fa-edit text-blue-500 hover:text-blue-700 cursor-pointer mr-2" onclick="window.requestEditObservation('${student}', '${obs.timestamp}')"></i>
                                    <i class="fas fa-trash-alt text-red-500 hover:text-red-700 cursor-pointer" onclick="window.requestDeleteObservation('${student}', '${obs.timestamp}')"></i>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 text-right mt-1">${formattedDate}</p>
                        `;
                        ui.obsHistory.appendChild(obsElement);
                    });
                }

                ui.obsModal.classList.add('active');
                ui.obsModal.dataset.student = student;
            }

            window.requestDeleteObservation = function(student, timestamp) {
                showPasswordConfirm('Confirmar Borrado', () => deleteObservation(student, timestamp));
            }

            window.requestEditObservation = function(student, timestamp) {
                showPasswordConfirm('Confirmar Edici贸n', () => {
                    const studentData = gradesData[activePeriod]?.[activeCourse]?.[student];
                    const observation = studentData?.observations.find(o => o.timestamp === timestamp);
                    if (observation) {
                        ui.editObsTextarea.value = observation.text;
                        ui.editObsModal.dataset.student = student;
                        ui.editObsModal.dataset.timestamp = timestamp;
                        ui.editObsModal.classList.add('active');
                    }
                });
            }

            function deleteObservation(student, timestamp) {
                ensureStudentData(activePeriod, activeCourse, student);
                const studentData = gradesData[activePeriod][activeCourse][student];
                
                if (studentData && studentData.observations) {
                    studentData.observations = studentData.observations.filter(obs => obs.timestamp !== timestamp);
                    saveAllData(true);
                    
                    const icon = document.querySelector(`i[data-student-obs="${student}"]`);
                    if (icon) {
                        if (studentData.observations.length > 0) {
                            icon.classList.add('has-obs');
                        } else {
                            icon.classList.remove('has-obs');
                        }
                    }

                    if (ui.obsModal.classList.contains('active') && ui.obsModal.dataset.student === student) {
                        showObservationsModal(student); 
                    }
                    showMessage("Observaci贸n borrada con 茅xito.", "success");
                }
            }
            
            window.showDateNoteModal = function(dateString) {
                ensureCourseData(activePeriod, activeCourse);
                const date = new Date(dateString + 'T00:00:00');
                ui.dateNoteDate.textContent = date.toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });
                ui.dateNoteTextarea.value = gradesData[activePeriod][activeCourse].dateNotes?.[dateString] || '';
                ui.dateNoteModal.dataset.date = dateString;
                ui.dateNoteModal.classList.add('active');
            }
            
            window.showGradeNoteModal = function(noteGroup) {
                ensureCourseData(activePeriod, activeCourse);
                const titlePart = `Actividad ${noteGroup}`;
                ui.gradeNoteTitle.textContent = titlePart;
                ui.gradeNoteTextarea.value = gradesData[activePeriod][activeCourse].columnNotes?.[noteGroup] || '';
                ui.gradeNoteModal.classList.add('active');
                ui.gradeNoteModal.dataset.noteGroup = noteGroup;
            }

            window.showGradesModal = function(student) {
                ensureStudentData(activePeriod, activeCourse, student);
                const studentData = gradesData[activePeriod][activeCourse][student];
                ui.gradesStudentName.textContent = student;
                ui.gradesGrid.innerHTML = '';
                const fields = [];
                const gs = appSettings.gradeStructure;
                for(let i=1; i<=gs.cognitive; i++) fields.push({key: `cognitivoC${i}`, label: `C${i}`});
                for(let i=1; i<=gs.procedural; i++) fields.push({key: `procedimentalP${i}`, label: `P${i}`});
                for(let i=1; i<=gs.attitudinal; i++) fields.push({key: `actitudinalA${i}`, label: `A${i}`});

                fields.forEach(field => {
                    const value = studentData.grades?.[field.key] || '';
                    ui.gradesGrid.innerHTML += `<div class="col-span-1 flex items-center"><label class="font-semibold">${field.label}:</label></div><div class="col-span-2"><input type="number" min="1" max="5" step="0.1" data-field="${field.key}" value="${value}" class="grade-input"></div>`;
                });
                ui.gradesModal.dataset.student = student;
                ui.gradesModal.classList.add('active');
            }

            window.showStudentReportModal = function(student) {
                ensureStudentData(activePeriod, activeCourse, student);
                const studentData = gradesData[activePeriod]?.[activeCourse]?.[student] || {};
                const def = calculateDef(studentData.grades);
                const nivel = determineNivel(def);
                const attendance = calculateAttendanceSummary(studentData.attendance);

                let reportHTML = `
                    <div class="p-4" id="studentReportContent">
                        <h3 class="text-2xl font-bold text-center mb-4">Informe de Desempe帽o</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><strong>Estudiante:</strong> ${student}</div>
                            <div><strong>Curso:</strong> ${activeCourse}</div>
                            <div><strong>Periodo:</strong> ${activePeriod}</div>
                            <div><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-CO')}</div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-bold mb-2">Resumen General</h4>
                                <p><strong>Nota Definitiva (${activePeriod}):</strong> <span class="font-bold text-xl">${def}</span></p>
                                <p><strong>Nivel de Desempe帽o:</strong> <span class="font-bold">${nivel}</span></p>
                                <hr class="my-2">
                                <h5 class="font-semibold mt-2">Asistencia</h5>
                                <p><strong>Asistencias:</strong> ${attendance.attended}</p>
                                <p><strong>Ausencias:</strong> ${attendance.absent}</p>
                                <p><strong>Excusas:</strong> ${attendance.excused}</p>
                                <p><strong>Tardanzas:</strong> ${attendance.late}</p>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold mb-2">Promedio por Componente</h4>
                                <div class="relative h-48">
                                    <canvas id="studentComponentChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <h4 class="text-lg font-bold mt-6 mb-2">Progreso a Trav茅s de los Periodos</h4>
                        <div class="relative h-64">
                           <canvas id="studentProgressChart"></canvas>
                        </div>

                        <h4 class="text-lg font-bold mt-6 mb-2">Detalle de Calificaciones (${activePeriod})</h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
                `;

                const gs = appSettings.gradeStructure;
                for(let i=1; i<=gs.cognitive; i++) reportHTML += `<div><strong>Cognitivo C${i}:</strong> ${studentData.grades?.[`cognitivoC${i}`]||'N/A'}</div>`;
                for(let i=1; i<=gs.procedural; i++) reportHTML += `<div><strong>Procedimental P${i}:</strong> ${studentData.grades?.[`procedimentalP${i}`]||'N/A'}</div>`;
                for(let i=1; i<=gs.attitudinal; i++) reportHTML += `<div><strong>Actitudinal A${i}:</strong> ${studentData.grades?.[`actitudinalA${i}`]||'N/A'}</div>`;
                
                reportHTML += `</div>`;
                
                const observations = studentData.observations || [];
                if (observations.length > 0) {
                    reportHTML += `<h4 class="text-lg font-bold mt-6 mb-2">Observaciones</h4>`;
                    observations.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    reportHTML += '<ul class="list-disc list-inside space-y-2">';
                    observations.forEach(obs => {
                        const obsDate = new Date(obs.timestamp).toLocaleDateString('es-CO', {day: '2-digit', month: 'short'});
                        reportHTML += `<li><strong>${obsDate}:</strong> ${obs.text}</li>`;
                    });
                    reportHTML += '</ul>';
                }

                reportHTML += '</div>';

                ui.studentReportContent.innerHTML = reportHTML;
                ui.studentReportModal.classList.add('active');

                // Delay chart creation to ensure canvas is visible
                setTimeout(() => {
                    // Component Chart
                    const componentCtx = document.getElementById('studentComponentChart').getContext('2d');
                    const cognitiveGrades = [];
                    for(let i=1; i<=gs.cognitive; i++) cognitiveGrades.push(getGradeValue(studentData.grades, `cognitivoC${i}`));
                    const proceduralGrades = [];
                    for(let i=1; i<=gs.procedural; i++) proceduralGrades.push(getGradeValue(studentData.grades, `procedimentalP${i}`));
                    const attitudinalGrades = [];
                    for(let i=1; i<=gs.attitudinal; i++) attitudinalGrades.push(getGradeValue(studentData.grades, `actitudinalA${i}`));

                    new Chart(componentCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Cognitivo', 'Procedimental', 'Actitudinal'],
                            datasets: [{
                                label: 'Promedio por Componente',
                                data: [calculateAverage(cognitiveGrades), calculateAverage(proceduralGrades), calculateAverage(attitudinalGrades)],
                                backgroundColor: ['#60a5fa', '#34d399', '#facc15'],
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, max: 5 } },
                            plugins: { legend: { display: false } }
                        }
                    });

                    // Progress Chart
                    const progressCtx = document.getElementById('studentProgressChart').getContext('2d');
                    const periodLabels = appSettings.periods.map(p => p.name);
                    const studentGrades = periodLabels.map(periodName => {
                        const studentPeriodData = gradesData[periodName]?.[activeCourse]?.[student] || {};
                        const grade = parseFloat(calculateDef(studentPeriodData.grades));
                        return isNaN(grade) ? 0 : grade;
                    });

                    new Chart(progressCtx, {
                        type: 'line',
                        data: {
                            labels: periodLabels,
                            datasets: [{
                                label: `Nota Definitiva en ${activeCourse}`,
                                data: studentGrades,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, max: 5 } },
                            plugins: { legend: { display: true, position: 'top' } }
                        }
                    });
                }, 100);
            }

            window.showCourseManagementModal = function() {
                const course = activeCourse;
                if (!course) return;

                ui.courseManagementTitle.textContent = course;
                ui.studentManagementList.innerHTML = '';
                const students = allStudentsData[course] || [];

                students.forEach(student => {
                    const studentDiv = document.createElement('div');
                    studentDiv.className = 'flex items-center justify-between p-1 bg-gray-100 dark:bg-gray-600 rounded';
                    studentDiv.innerHTML = `
                        <span>${student}</span>
                        <i class="fas fa-trash-alt text-red-500 hover:text-red-700 cursor-pointer" onclick="window.deleteStudent('${student}')"></i>
                    `;
                    ui.studentManagementList.appendChild(studentDiv);
                });
                
                ui.courseManagementModal.classList.add('active');
            }

            window.deleteStudent = function(student) {
                const course = activeCourse;
                showPasswordConfirm(
                    'Eliminar Estudiante',
                    () => {
                        if (allStudentsData[course]) {
                            allStudentsData[course] = allStudentsData[course].filter(s => s !== student);
                        }
                        if (gradesData[activePeriod] && gradesData[activePeriod][course]) {
                            delete gradesData[activePeriod][course][student];
                        }
                        saveAllData(true);
                        showMessage('Estudiante eliminado.', 'success');
                        showCourseManagementModal();
                        renderTable();
                    }
                );
            }

            window.showBulletinModal = function(student) {
                ensureStudentData(activePeriod, activeCourse, student);
                const studentData = gradesData[activePeriod][activeCourse][student];
                const def = calculateDef(studentData.grades);
                const nivel = determineNivel(def);
                const attendance = calculateAttendanceSummary(studentData.attendance);
                const timestamp = new Date().toLocaleString('es-CO', { dateStyle: 'long', timeStyle: 'short' });

                let obsHTML = 'Sin observaciones.';
                const observations = studentData.observations || [];
                if (observations.length > 0) {
                    observations.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    obsHTML = observations.map(obs => {
                        const obsDate = new Date(obs.timestamp);
                        const formattedDate = obsDate.toLocaleString('es-CO', { dateStyle: 'short', timeStyle: 'short' });
                        return `<div class="mb-2"><p class="whitespace-normal">${obs.text.replace(/\n/g, '<br>')}</p><p class="text-xs text-gray-500 text-right mt-1">${formattedDate}</p></div>`;
                    }).join('<hr class="my-1">');
                }

                let gradesHTML = '';
                const gs = appSettings.gradeStructure;
                for(let i=1; i<=gs.cognitive; i++) gradesHTML += `<p><strong>Cognitivo C${i}:</strong> ${studentData.grades?.[`cognitivoC${i}`]||'N/A'}</p>`;
                for(let i=1; i<=gs.procedural; i++) gradesHTML += `<p><strong>Procedimental P${i}:</strong> ${studentData.grades?.[`procedimentalP${i}`]||'N/A'}</p>`;
                for(let i=1; i<=gs.attitudinal; i++) gradesHTML += `<p><strong>Actitudinal A${i}:</strong> ${studentData.grades?.[`actitudinalA${i}`]||'N/A'}</p>`;

                ui.bulletinContent.innerHTML = `<div class="bulletin-page p-4 bg-white" style="color: black !important;"><h3 class="text-2xl font-bold text-center mb-4">Bolet铆n Informativo - ${activePeriod}</h3><p><strong>Estudiante:</strong> <span id="bulletinStudentName">${student}</span></p><p><strong>Curso:</strong> ${activeCourse}</p><hr class="my-4"><h4 class="text-lg font-bold mt-4">Calificaciones</h4><div id="bulletinGrades" class="grid grid-cols-2 gap-2 mt-2">${gradesHTML}<p class="mt-2 font-bold"><strong>DEF: ${def} (${nivel})</strong></p></div><h4 class="text-lg font-bold mt-4">Asistencia</h4><div id="bulletinAttendance" class="mt-2"><p><strong>Asistencias:</strong> ${attendance.attended}</p><p><strong>Ausencias:</strong> ${attendance.absent}</p><p><strong>Excusas:</strong> ${attendance.excused}</p><p><strong>Tardanzas:</strong> ${attendance.late}</p></div><h4 class="text-lg font-bold mt-4">Observaciones</h4><div id="bulletinObs" class="mt-2">${obsHTML}</div><div class="text-xs text-gray-500 text-center mt-6" style="color: #555 !important;">Generado el: ${timestamp}</div></div>`;
                ui.bulletinModal.classList.add('active');
            }

            window.showGroupGradeModal = function(field, fieldName) {
                const selectedStudents = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
                if (selectedStudents.length === 0) {
                    showMessage('Por favor, selecciona al menos un estudiante.', 'error');
                    return;
                }
                document.getElementById('groupGradeComponent').textContent = fieldName;
                document.getElementById('groupGradeStudentCount').textContent = selectedStudents.length;
                document.getElementById('groupGradeInput').value = '';
                document.getElementById('groupGradeModal').dataset.field = field;
                document.getElementById('groupGradeModal').classList.add('active');
            }
            
            function exportData(scope, selectedCourses = []) {
                let csvContent = "data:text/csv;charset=utf-8,";
                const coursesToExport = scope === 'all' ? Object.keys(allStudentsData).sort() : scope === 'selected' ? selectedCourses : [activeCourse];
                coursesToExport.forEach(course => {
                    const data = gradesData[activePeriod]?.[course] || {};
                    if (scope !== 'current') csvContent += `"${course}" (${activePeriod})\r\n`;
                    const attendanceDates = getAttendanceDates(course).map(d => d.toLocaleDateString('es-CO'));
                    
                    const gs = appSettings.gradeStructure;
                    let gradeHeaders = [];
                    for(let i=1; i<=gs.cognitive; i++) gradeHeaders.push(`C${i}`);
                    for(let i=1; i<=gs.procedural; i++) gradeHeaders.push(`P${i}`);
                    for(let i=1; i<=gs.attitudinal; i++) gradeHeaders.push(`A${i}`);

                    const headers = ["No", "Estudiante", ...attendanceDates, "Obs.", ...gradeHeaders, "DEF", "NIVEL"];
                    csvContent += headers.join(",") + "\r\n";

                    allStudentsData[course].forEach((student, index) => {
                        const studentData = data[student] || {};
                        const obsText = (studentData.observations || [])
                            .map(obs => {
                                const d = new Date(obs.timestamp).toLocaleString('es-CO');
                                return `[${d}]: ${obs.text}`;
                            })
                            .join('; ');

                        const def = calculateDef(studentData.grades);
                        const nivel = determineNivel(def);

                        let gradeValues = [];
                        for(let i=1; i<=gs.cognitive; i++) gradeValues.push(studentData.grades?.[`cognitivoC${i}`]||"");
                        for(let i=1; i<=gs.procedural; i++) gradeValues.push(studentData.grades?.[`procedimentalP${i}`]||"");
                        for(let i=1; i<=gs.attitudinal; i++) gradeValues.push(studentData.grades?.[`actitudinalA${i}`]||"");

                        let row = [index + 1, `"${student}"`, ...getAttendanceDates(course).map(d => { const s=studentData.attendance?.[d.toISOString().split('T')[0]]; return s===true?"P":s===false?"A":s==='excused'?'E':s==='late'?'T':""; }), `"${obsText.replace(/"/g, '""')}"`, ...gradeValues, def, nivel];
                        csvContent += row.join(",") + "\r\n";
                    });
                    if (scope !== 'current') csvContent += "\r\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `calificaciones_${scope}_${activePeriod}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                ui.exportModal.classList.remove('active');
            }

            async function downloadBulletinAsFile(format) {
                const studentName = document.getElementById('bulletinStudentName').textContent;
                const bulletinContent = ui.bulletinContent.querySelector('.bulletin-page');
                const canvas = await html2canvas(bulletinContent, { scale: 2, backgroundColor: 'white' });
                const imgData = canvas.toDataURL('image/png');
                const fileName = `boletin_${studentName.replace(/ /g, '_')}.${format}`;
                if (format === 'png') {
                    const link = document.createElement('a');
                    link.download = fileName;
                    link.href = imgData;
                    link.click();
                } else if (format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight - 20);
                    pdf.save(fileName);
                }
            }
            
            const exportAllDataToJson = () => {
                const dataToExport = {
                    version: '3.0', // to handle future migrations
                    exportDate: new Date().toISOString(),
                    appSettings,
                    dailySchedule,
                    allStudentsData,
                    gradesData
                };

                const dataStr = JSON.stringify(dataToExport, null, 2); // pretty print
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const date = new Date();
                const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                link.setAttribute('href', url);
                link.setAttribute('download', `copia_seguridad_calificaciones_${dateString}.json`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                ui.dataManagementModal.classList.remove('active');
                showMessage('Copia de seguridad exportada con 茅xito.', 'success');
            };

            const importAllDataFromJson = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        // Basic validation
                        if (!importedData.appSettings || !importedData.allStudentsData || !importedData.gradesData) {
                            throw new Error('El archivo no parece ser una copia de seguridad v谩lida.');
                        }
                        
                        // Restore data
                        appSettings = importedData.appSettings;
                        dailySchedule = importedData.dailySchedule || {'Lunes':[],'Martes':[],'Mi茅rcoles':[],'Jueves':[],'Viernes':[]}; // provide default if missing
                        allStudentsData = importedData.allStudentsData;
                        gradesData = importedData.gradesData;
                        
                        // Persist and reload UI
                        saveSettings();
                        saveAllData(true); // save without re-rendering yet
                        
                        showMessage('Datos importados con 茅xito. Recargando...', 'success');
                        
                        // Reload the entire UI based on new data
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);

                    } catch (error) {
                        console.error("Error al importar JSON:", error);
                        showMessage(`Error al importar: ${error.message}`, 'error');
                    } finally {
                        // Reset file input
                        ui.importJsonFile.value = '';
                        ui.dataManagementModal.classList.remove('active');
                    }
                };
                reader.readAsText(file);
            };
            
            function calculateAndDisplayStats() {
                if (!activeCourse) return;
                const data = gradesData[activePeriod]?.[activeCourse] || {};
                const students = allStudentsData[activeCourse] || [];

                ui.statsPanel.innerHTML = ''; // Clear previous stats

                if (students.length === 0) return;
                
                let totalDef = 0, studentCountWithGrades = 0;
                const nivelCounts = { "Bajo": 0, "B谩sico": 0, "Alto": 0, "Superior": 0, "N/A": 0 };
                let totalAttended = 0, totalPossibleSessions = 0;

                const attendanceDatesCount = getAttendanceDates(activeCourse).length;
                totalPossibleSessions = students.length * attendanceDatesCount;

                students.forEach(student => {
                    const studentData = data[student] || {};
                    const def = parseFloat(calculateDef(studentData.grades));
                    if (!isNaN(def) && def > 0) {
                        totalDef += def;
                        studentCountWithGrades++;
                    }
                    const nivel = determineNivel(def) || "N/A";
                    nivelCounts[nivel]++;
                    totalAttended += calculateAttendanceSummary(studentData.attendance).attended;
                });
                
                const avgDef = studentCountWithGrades > 0 ? (totalDef / studentCountWithGrades).toFixed(2) : "0.00";
                const attendancePercent = totalPossibleSessions > 0 ? ((totalAttended / totalPossibleSessions) * 100).toFixed(1) : 0;
                
                ui.statsPanel.innerHTML = `
                    <div class="stat-item"><p class="font-bold text-lg">${avgDef}</p><p class="text-sm">Promedio Gral.</p></div>
                    <div class="stat-item"><p class="font-bold text-lg">${attendancePercent}%</p><p class="text-sm">Asistencia</p></div>
                    <div id="statsChartContainer" class="stat-item" style="grid-column: 1 / -1; min-height: 120px;">
                        <canvas id="nivelChart"></canvas>
                    </div>
                `;
                
                const ctx = document.getElementById('nivelChart').getContext('2d');
                if(statsChart) statsChart.destroy();
                statsChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Superior', 'Alto', 'B谩sico', 'Bajo', 'N/A'],
                        datasets: [{
                            label: 'Niveles de Desempe帽o',
                            data: [nivelCounts.Superior, nivelCounts.Alto, nivelCounts.B谩sico, nivelCounts.Bajo, nivelCounts['N/A']],
                            backgroundColor: ['#dbeafe', '#dcfce7', '#fef9c3', '#fee2e2', '#e5e7eb'],
                            borderColor: ['#1e40af', '#166534', '#854d0e', '#991b1b', '#6b7280'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { boxWidth: 20 } }
                        }
                    }
                });
            }

            async function generateAndExportPdf(courses, studentList = null) {
                showMessage('Generando PDF, por favor espera...', 'success');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const studentsToPrint = [];
                if(studentList) { 
                    studentsToPrint.push({ courseName: activeCourse, students: studentList });
                } else { 
                    courses.forEach(courseName => studentsToPrint.push({ courseName: courseName, students: allStudentsData[courseName] || [] }));
                }
                const timestamp = new Date().toLocaleString('es-CO', { dateStyle: 'long', timeStyle: 'short' });
                let firstPage = true;
                for (const { courseName, students } of studentsToPrint) {
                    for (const studentName of students) {
                        if (!firstPage) pdf.addPage();
                        const studentData = gradesData[activePeriod]?.[courseName]?.[studentName] || {};
                        const def = calculateDef(studentData.grades);
                        const nivel = determineNivel(def);
                        const attendance = calculateAttendanceSummary(studentData.attendance);
                        let gradesPDFHTML = '';
                        const gs = appSettings.gradeStructure;
                        for(let i=1; i<=gs.cognitive; i++) gradesPDFHTML += `<p><strong>Cognitivo C${i}:</strong> ${studentData.grades?.[`cognitivoC${i}`]||'N/A'}</p>`;
                        for(let i=1; i<=gs.procedural; i++) gradesPDFHTML += `<p><strong>Procedimental P${i}:</strong> ${studentData.grades?.[`procedimentalP${i}`]||'N/A'}</p>`;
                        for(let i=1; i<=gs.attitudinal; i++) gradesPDFHTML += `<p><strong>Actitudinal A${i}:</strong> ${studentData.grades?.[`actitudinalA${i}`]||'N/A'}</p>`;
                        
                        const bulletinHTML = `<div class="bulletin-page p-4 bg-white" style="width:210mm;color:black!important"><h3 class="text-2xl font-bold text-center mb-4">Bolet铆n Informativo</h3><p><strong>Estudiante:</strong> ${studentName}</p><p><strong>Curso:</strong> ${courseName}</p><hr class="my-4"><h4 class="text-lg font-bold mt-4">Calificaciones</h4><div class="grid grid-cols-2 gap-2 mt-2">${gradesPDFHTML}<p class="mt-2 font-bold"><strong>DEF: ${def} (${nivel})</strong></p></div><h4 class="text-lg font-bold mt-4">Asistencia</h4><div class="mt-2"><p><strong>Asistencias:</strong> ${attendance.attended}</p><p><strong>Ausencias:</strong> ${attendance.absent}</p><p><strong>Excusas:</strong> ${attendance.excused}</p></div><h4 class="text-lg font-bold mt-4">Observaciones</h4><p class="mt-2">${(studentData.observations || []).map(o => `[${new Date(o.timestamp).toLocaleString()}] ${o.text}`).join('<br>')||'Sin observaciones.'}</p><div class="text-xs text-gray-500 text-center mt-6" style="color:#555!important">Generado el: ${timestamp}</div></div>`;
                        const tempDiv = document.createElement('div');
                        tempDiv.style.position='absolute'; tempDiv.style.left='-9999px';
                        tempDiv.innerHTML = bulletinHTML;
                        document.body.appendChild(tempDiv);
                        const canvas = await html2canvas(tempDiv.firstChild, { scale: 2, backgroundColor: 'white' });
                        const imgData = canvas.toDataURL('image/png');
                        const imgProps = pdf.getImageProperties(imgData);
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                        pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, (imgProps.height * (pdfWidth-20)) / imgProps.width);
                        document.body.removeChild(tempDiv);
                        firstPage = false;
                    }
                }
                let fileName = studentList ? `boletines_${activeCourse}_seleccionados.pdf` : courses.length === 1 ? `boletines_${courses[0]}.pdf` : courses.length === Object.keys(allStudentsData).length ? `boletines_todos_los_cursos.pdf` : `boletines_cursos_seleccionados.pdf`;
                pdf.save(fileName);
                ui.bulletinSelectionModal.classList.remove('active');
            }

            // --- Voice Input ---
            function setupSpeechRecognition() {
                 const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                 if (!SpeechRecognition) {
                     ui.voiceInputBtn.style.display = 'none';
                     console.warn("Speech Recognition not supported in this browser.");
                     return;
                 }
                
                 recognition = new SpeechRecognition();
                 recognition.lang = 'es-CO';
                 recognition.continuous = true;
                 recognition.interimResults = true;

                 recognition.onstart = () => {
                     ui.voiceStatus.classList.add('listening');
                     ui.voiceStatus.classList.remove('fa-microphone-alt');
                     ui.voiceStatus.classList.add('fa-stop');
                     ui.voiceTranscript.textContent = 'Escuchando...';
                 };

                 recognition.onend = () => {
                     if (isRecognitionSessionActive) {
                         recognition.start(); // If the session should be active, restart it.
                     } else {
                         ui.voiceStatus.classList.remove('listening');
                         ui.voiceStatus.classList.add('fa-microphone-alt');
                         ui.voiceStatus.classList.remove('fa-stop');
                         ui.voiceTranscript.textContent = 'Presiona para iniciar';
                     }
                 };

                 recognition.onerror = (event) => {
                     console.error('Speech recognition error', event.error);
                     if (event.error === 'no-speech') {
                         // This is normal, just ignore it and let onend handle restart.
                     } else {
                          ui.voiceTranscript.textContent = `Error: ${event.error}`;
                     }
                 };

                 recognition.onresult = (event) => {
                     let finalTranscript = '';
                     for (let i = event.resultIndex; i < event.results.length; ++i) {
                         if (event.results[i].isFinal) {
                             finalTranscript += event.results[i][0].transcript;
                         }
                     }
                    
                     if (finalTranscript) {
                         ui.voiceTranscript.textContent = `"${finalTranscript}"`;
                         handleVoiceResult(finalTranscript);
                     }
                 };
            }
            
            function parseVoiceGrade(text) {
                 let gradeText = text.toLowerCase().trim()
                     .replace(/coma/g, '.')
                     .replace(/punto/g, '.')
                     .replace(/uno/g, '1')
                     .replace(/dos/g, '2')
                     .replace(/tres/g, '3')
                     .replace(/cuatro/g, '4')
                     .replace(/cinco/g, '5')
                     .replace(/seis/g, '6')
                     .replace(/siete/g, '7')
                     .replace(/ocho/g, '8')
                     .replace(/nueve/g, '9')
                     .replace(/cero/g, '0')
                     .replace(/\s/g, ''); 
                
                 let grade = parseFloat(gradeText);
                 if (isNaN(grade) || grade < 1 || grade > 5) {
                     return null;
                 }
                 return grade.toFixed(1);
            }

            function stopRecognitionSession() {
                 isRecognitionSessionActive = false;
                 if(recognition) recognition.stop();
                 showMessage("Sesi贸n de dictado finalizada.", "success");
            }

            function handleVoiceResult(transcript) {
                const grade = parseVoiceGrade(transcript);
                if (grade === null) {
                    showMessage(`No se reconoci贸 una nota v谩lida en "${transcript}"`, "error");
                    return;
                }

                const selectedStudentsInTable = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);

                if (selectedStudentsInTable.length > 0) {
                    const currentGradeEl = ui.voiceGradeList.querySelector('.selected');
                    if(currentGradeEl) {
                        const field = currentGradeEl.dataset.field;
                        selectedStudentsInTable.forEach(studentName => {
                            updateGrade(studentName, field, grade, null); // cellToUpdate is null as we'll re-render
                        });
                        showMessage(`Nota ${grade} aplicada a ${selectedStudentsInTable.length} estudiantes.`, "success");
                        renderTable();
                    }
                } else {
                    const currentStudentEl = ui.voiceStudentList.querySelector('.selected');
                    const currentGradeEl = ui.voiceGradeList.querySelector('.selected');
                    
                    if (currentStudentEl && currentGradeEl) {
                        const student = currentStudentEl.dataset.student;
                        const field = currentGradeEl.dataset.field;
                        
                        if (updateGrade(student, field, grade, null)) {
                            const selectElement = (elementToSelect, listContainer) => {
                                listContainer.querySelector('.selected')?.classList.remove('selected');
                                elementToSelect.classList.add('selected');
                                elementToSelect.scrollIntoView({ block: 'center', behavior: 'smooth' });
                            };

                            if (voiceGradingMode === 'student') {
                                let nextEl = currentGradeEl.nextElementSibling;
                                if (nextEl) {
                                    selectElement(nextEl, ui.voiceGradeList);
                                } else {
                                    nextEl = currentStudentEl.nextElementSibling;
                                    if (nextEl) {
                                        selectElement(nextEl, ui.voiceStudentList);
                                        selectElement(ui.voiceGradeList.firstElementChild, ui.voiceGradeList);
                                    } else {
                                        stopRecognitionSession();
                                    }
                                }
                            } else { // mode is 'component'
                                let nextEl = currentStudentEl.nextElementSibling;
                                if (nextEl) {
                                    selectElement(nextEl, ui.voiceStudentList);
                                } else {
                                    nextEl = currentGradeEl.nextElementSibling;
                                    if (nextEl) {
                                        selectElement(nextEl, ui.voiceGradeList);
                                        selectElement(ui.voiceStudentList.firstElementChild, ui.voiceStudentList);
                                    } else {
                                        stopRecognitionSession();
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            function populateVoiceModal() {
                 const courseForModal = ui.voiceCourseSelector.value;
                 const students = allStudentsData[courseForModal] || [];
                 ui.voiceStudentList.innerHTML = '';
                 students.forEach(student => {
                     const div = document.createElement('div');
                     div.textContent = student;
                     div.dataset.student = student;
                     div.onclick = () => {
                         ui.voiceStudentList.querySelector('.selected')?.classList.remove('selected');
                         div.classList.add('selected');
                     };
                     ui.voiceStudentList.appendChild(div);
                 });
                 if (ui.voiceStudentList.firstChild) {
                     ui.voiceStudentList.firstChild.classList.add('selected');
                 }
                
                 const gs = appSettings.gradeStructure;
                 const fields = [];
                 for(let i=1; i<=gs.cognitive; i++) fields.push({key: `cognitivoC${i}`, label: `Cognitivo C${i}`});
                 for(let i=1; i<=gs.procedural; i++) fields.push({key: `procedimentalP${i}`, label: `Procedimental P${i}`});
                 for(let i=1; i<=gs.attitudinal; i++) fields.push({key: `actitudinalA${i}`, label: `Actitudinal A${i}`});

                 ui.voiceGradeList.innerHTML = '';
                 fields.forEach(field => {
                     const div = document.createElement('div');
                     div.textContent = field.label;
                     div.dataset.field = field.key;
                      div.onclick = () => {
                         ui.voiceGradeList.querySelector('.selected')?.classList.remove('selected');
                         div.classList.add('selected');
                      };
                     ui.voiceGradeList.appendChild(div);
                 });
                 if (ui.voiceGradeList.firstChild) {
                     ui.voiceGradeList.firstChild.classList.add('selected');
                 }
            }
            
            function showVoiceGradeModal() {
                 ui.voiceCourseSelector.innerHTML = '';
                 Object.keys(allStudentsData).sort().forEach(course => {
                     const option = document.createElement('option');
                     option.value = course;
                     option.textContent = course;
                     if(course === activeCourse) option.selected = true;
                     ui.voiceCourseSelector.appendChild(option);
                 });

                 populateVoiceModal();
                 ui.voiceGradeModal.classList.add('active');
            }

            // --- Ranking ---
            function calculateRankings() {
                const coursePerformances = [];

                for (const courseName in allStudentsData) {
                    const students = allStudentsData[courseName] || [];
                    if (students.length === 0) continue;

                    const studentRanks = students.map(studentName => {
                        const studentData = gradesData[activePeriod]?.[courseName]?.[studentName] || {};
                        const def = parseFloat(calculateDef(studentData.grades));
                        return { name: studentName, def: isNaN(def) ? 0 : def };
                    }).sort((a, b) => b.def - a.def);

                    const validStudents = studentRanks.filter(s => s.def > 0);
                    const totalDef = validStudents.reduce((sum, student) => sum + student.def, 0);
                    const courseAverage = validStudents.length > 0 ? (totalDef / validStudents.length) : 0;

                    coursePerformances.push({
                        courseName,
                        average: isNaN(courseAverage) ? 0 : courseAverage,
                        students: studentRanks
                    });
                }

                coursePerformances.sort((a, b) => b.average - a.average);
                return coursePerformances;
            }

            function showRankingModal() {
                const rankingData = calculateRankings();
                const rankingContent = document.getElementById('rankingContent');
                document.getElementById('rankingPeriodName').textContent = activePeriod;
                rankingContent.innerHTML = '';

                if (rankingData.length === 0) {
                    rankingContent.innerHTML = '<p class="text-center text-gray-500">No hay datos suficientes para generar un ranking.</p>';
                    ui.rankingModal.classList.add('active');
                    return;
                }

                const chartContainerHTML = `
                    <div class="mb-8">
                        <h4 class="text-xl font-bold mb-3 text-center">Comparativa General de Cursos</h4>
                        <div class="relative h-64">
                            <canvas id="courseComparisonChart"></canvas>
                        </div>
                    </div>
                `;
                rankingContent.innerHTML = chartContainerHTML;
                
                const courseRankingHTML = `
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h4 class="text-xl font-bold mb-3 text-center">Ranking de Cursos</h4>
                        <ol class="list-decimal list-inside space-y-2">
                            ${rankingData.map(course => `
                                <li class="text-lg">
                                    <span class="font-semibold">${course.courseName}</span> - Promedio: <span class="font-bold text-blue-600 dark:text-blue-400">${course.average.toFixed(2)}</span>
                                </li>
                            `).join('')}
                        </ol>
                    </div>
                `;
                rankingContent.innerHTML += courseRankingHTML;

                ui.rankingModal.classList.add('active');

                // Delay chart creation
                setTimeout(() => {
                    const courseLabels = rankingData.map(c => c.courseName);
                    const courseAverages = rankingData.map(c => c.average.toFixed(2));
                    const comparisonCtx = document.getElementById('courseComparisonChart').getContext('2d');
                    new Chart(comparisonCtx, {
                        type: 'bar',
                        data: {
                            labels: courseLabels,
                            datasets: [{
                                label: `Promedio General del Curso (${activePeriod})`,
                                data: courseAverages,
                                backgroundColor: '#34d399',
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, max: 5 } },
                            plugins: { legend: { display: false } }
                        }
                    });
                }, 100);
                
                rankingData.forEach(course => {
                    const getMedal = (index) => {
                        if (index === 0) return '';
                        if (index === 1) return '';
                        if (index === 2) return '';
                        if (index < 5) return '猸'; 
                        return `${index + 1}.`;
                    };
                    
                    const studentListHTML = course.students.map((student, index) => `
                        <tr class="${index < 5 ? 'bg-yellow-100 dark:bg-yellow-800/30' : ''}">
                            <td class="p-2 w-12 text-center font-bold">${getMedal(index)}</td>
                            <td class="p-2">${student.name}</td>
                            <td class="p-2 w-24 text-center font-semibold">${student.def.toFixed(2)}</td>
                        </tr>
                    `).join('');

                    const courseHTML = `
                        <div class="border dark:border-gray-600 rounded-lg p-4 mt-6">
                            <h5 class="text-lg font-bold mb-2">Puestos en ${course.courseName}</h5>
                            <div class="max-h-60 overflow-y-auto">
                                <table class="w-full text-sm">
                                   <thead class="sticky top-0 bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                      <th class="p-2 w-12">Puesto</th>
                                      <th class="p-2 text-left">Estudiante</th>
                                      <th class="p-2 w-24">DEF</th>
                                    </tr>
                                   </thead>
                                   <tbody>${studentListHTML}</tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    rankingContent.innerHTML += courseHTML;
                });
            }


            // --- Advanced Delete Functionality ---
            const handleAdvancedDelete = () => {
                const scope = document.querySelector('input[name="adv-delete-scope"]:checked').value;
                const delGrades = document.getElementById('adv-del-grades').checked;
                const delAttendance = document.getElementById('adv-del-attendance').checked;
                const delObs = document.getElementById('adv-del-obs').checked;
                const delMetadata = document.getElementById('adv-del-metadata').checked;

                if (!delGrades && !delAttendance && !delObs && !delMetadata) {
                    showMessage('Selecciona al menos un tipo de dato para borrar.', 'error');
                    return;
                }

                showPasswordConfirm('Confirmar Limpieza Avanzada', () => {
                    let targetCourses = [];
                    if (scope === 'all_courses') {
                        targetCourses = Object.keys(allStudentsData);
                    } else {
                        targetCourses = [activeCourse];
                    }

                    targetCourses.forEach(course => {
                        const courseData = gradesData[activePeriod]?.[course];
                        if (!courseData) return;

                        // Handle Metadata (Course level)
                        if (delMetadata) {
                            if (courseData.dateNotes) courseData.dateNotes = {};
                            if (courseData.columnNotes) courseData.columnNotes = {};
                        }

                        // Determine students to process
                        let studentsToProcess = [];
                        if (scope === 'selected' && course === activeCourse) {
                            studentsToProcess = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
                            if (studentsToProcess.length === 0) {
                                showMessage('No hay estudiantes seleccionados.', 'error');
                                return;
                            }
                        } else {
                            studentsToProcess = allStudentsData[course] || [];
                        }

                        studentsToProcess.forEach(student => {
                            const studentData = courseData[student];
                            if (!studentData) return;

                            if (delGrades) studentData.grades = {};
                            if (delAttendance) studentData.attendance = {};
                            if (delObs) studentData.observations = [];
                        });
                    });

                    saveAllData(true);
                    ui.advancedDeleteModal.classList.remove('active');
                    renderTable();
                    showMessage('Limpieza de datos completada.', 'success');
                });
            };

            // --- Promote Students Functionality ---
            const populatePromoteModal = () => {
                ui.promoteSourceCourse.value = activeCourse;
                ui.promoteCurrentCourseLabel.textContent = activeCourse;
                
                // Reset to Single Mode default
                document.querySelector('input[name="promote-scope"][value="single"]').checked = true;
                togglePromoteScope('single');

                // Populate target selector for Single Mode
                ui.promoteTargetSelect.innerHTML = '<option value="" disabled selected>Seleccionar curso existente...</option>';
                Object.keys(allStudentsData).sort().forEach(course => {
                    if (course !== activeCourse) {
                        const option = document.createElement('option');
                        option.value = course;
                        option.textContent = course;
                        ui.promoteTargetSelect.appendChild(option);
                    }
                });

                // Populate student list for Single Mode
                ui.promoteStudentList.innerHTML = '';
                const students = allStudentsData[activeCourse] || [];
                students.forEach(student => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    div.innerHTML = `
                        <input type="checkbox" class="promote-student-check mr-2 h-4 w-4" value="${student}" checked>
                        <span class="text-gray-900 dark:text-gray-100">${student}</span>
                    `;
                    ui.promoteStudentList.appendChild(div);
                });

                ui.promoteTargetInput.classList.add('hidden');
                ui.promoteTargetSelect.classList.remove('hidden');
                ui.promoteModal.classList.add('active');
            };

            const togglePromoteScope = (scope) => {
                if (scope === 'single') {
                    ui.promoteSingleOptions.classList.remove('hidden');
                    ui.promoteBatchOptions.classList.add('hidden');
                    ui.promoteStudentListContainer.classList.remove('hidden');
                } else {
                    ui.promoteSingleOptions.classList.add('hidden');
                    ui.promoteBatchOptions.classList.remove('hidden');
                    ui.promoteStudentListContainer.classList.add('hidden');
                }
            };

            const executePromotion = () => {
                const scope = document.querySelector('input[name="promote-scope"]:checked').value;

                if (scope === 'single') {
                    // Logic for Single Course Promotion
                    const isNewCourse = !ui.promoteTargetInput.classList.contains('hidden');
                    let targetCourse = isNewCourse ? ui.promoteTargetInput.value.trim().toUpperCase() : ui.promoteTargetSelect.value;

                    if (!targetCourse) {
                        showMessage('Debe seleccionar o escribir un curso de destino.', 'error');
                        return;
                    }

                    if (targetCourse === activeCourse) {
                        showMessage('El curso de destino no puede ser el mismo que el origen.', 'error');
                        return;
                    }

                    const selectedStudents = Array.from(document.querySelectorAll('.promote-student-check:checked')).map(cb => cb.value);

                    if (selectedStudents.length === 0) {
                        showMessage('Seleccione al menos un estudiante para promover.', 'error');
                        return;
                    }

                    showPasswordConfirm(`Confirmar Promoci贸n a ${targetCourse}`, () => {
                        if (!allStudentsData[targetCourse]) {
                            allStudentsData[targetCourse] = [];
                        }

                        let addedCount = 0;
                        selectedStudents.forEach(student => {
                            if (!allStudentsData[targetCourse].includes(student)) {
                                allStudentsData[targetCourse].push(student);
                                addedCount++;
                            }
                        });

                        if (addedCount > 0) {
                            allStudentsData[targetCourse].sort((a, b) => a.localeCompare(b));
                            saveAllData(true);
                            showMessage(`${addedCount} estudiantes a帽adidos a ${targetCourse}.`, 'success');
                            ui.promoteModal.classList.remove('active');
                            // Refresh schedule modal if open or next time it opens
                            setupPeriodSelector(); // not strictly needed but good practice
                        } else {
                            showMessage('Los estudiantes seleccionados ya existen en el curso destino.', 'warning');
                        }
                    });

                } else {
                    // Logic for Batch Promotion (All Courses)
                    const batchType = document.querySelector('input[name="promote-batch-type"]:checked').value;
                    const suffix = ui.promoteBatchSuffix.value.trim();
                    
                    showPasswordConfirm(`Confirmar Acci贸n Masiva`, () => {
                        if (batchType === 'increment') {
                            // "Smart" Promotion: 8A -> 9A, 11 -> Delete
                            const newStudentsData = {};
                            let promotedCount = 0;
                            let graduatedCount = 0;
                            
                            Object.keys(allStudentsData).forEach(course => {
                                const match = course.match(/^(\d+)(.*)$/);
                                if (match) {
                                    const currentGrade = parseInt(match[1]);
                                    const suffixPart = match[2];
                                    
                                    if (currentGrade >= 11) {
                                        // Graduate/Delete from system (Grades 11 or higher)
                                        graduatedCount += allStudentsData[course].length;
                                    } else {
                                        const nextGrade = currentGrade + 1;
                                        const nextCourse = `${nextGrade}${suffixPart}`;
                                        
                                        // Ensure array exists
                                        if (!newStudentsData[nextCourse]) newStudentsData[nextCourse] = [];
                                        
                                        // Merge if somehow duplicate courses exist (e.g. merging two old 8th grades into one 9th?)
                                        // For standard case, it just copies.
                                        newStudentsData[nextCourse] = [...newStudentsData[nextCourse], ...allStudentsData[course]];
                                        promotedCount++;
                                    }
                                } else {
                                    // Non-numeric courses (e.g. 'Jardin'), keep as is for safety
                                    newStudentsData[course] = [...allStudentsData[course]];
                                }
                            });
                            
                            // Apply changes: Replace old data with new data
                            allStudentsData = newStudentsData;
                            gradesData = {}; // Clear all grades for the new year
                            dailySchedule = {'Lunes':[],'Martes':[],'Mi茅rcoles':[],'Jueves':[],'Viernes':[]}; // Clear schedule as course names changed
                            
                            saveAllData(true);
                            showMessage(`Promoci贸n completada. ${graduatedCount} estudiantes de grado 11 eliminados.`, 'success');
                            ui.promoteModal.classList.remove('active');
                            setTimeout(() => window.location.reload(), 1500);

                        } else {
                            // "Clone" Logic (Suffix based)
                            let coursesProcessed = 0;
                            const currentCourses = Object.keys(allStudentsData);
                            
                            currentCourses.forEach(courseName => {
                                const newCourseName = suffix ? `${courseName}${suffix}` : courseName;
                                
                                if (!allStudentsData[newCourseName]) {
                                    allStudentsData[newCourseName] = [];
                                }

                                allStudentsData[courseName].forEach(student => {
                                    if (!allStudentsData[newCourseName].includes(student)) {
                                        allStudentsData[newCourseName].push(student);
                                    }
                                });
                                coursesProcessed++;
                            });

                            saveAllData(true);
                            showMessage(`Clonaci贸n completada. ${coursesProcessed} cursos procesados.`, 'success');
                            ui.promoteModal.classList.remove('active');
                            setTimeout(() => window.location.reload(), 1000);
                        }
                    });
                }
            };


            // --- Schedule Management ---
            const openScheduleModal = () => {
                ui.scheduleGrid.innerHTML = '';
                const allCourses = Object.keys(allStudentsData).sort();
                
                // Days definition
                const days = ['Lunes', 'Martes', 'Mi茅rcoles', 'Jueves', 'Viernes'];
                
                days.forEach(day => {
                    const dayCol = document.createElement('div');
                    dayCol.className = 'bg-gray-100 dark:bg-gray-700 p-3 rounded-lg';
                    
                    const dayTitle = document.createElement('h4');
                    dayTitle.className = 'font-bold text-center mb-2 border-b pb-1 border-gray-300 dark:border-gray-500';
                    dayTitle.textContent = day;
                    dayCol.appendChild(dayTitle);

                    const coursesList = document.createElement('div');
                    coursesList.className = 'flex flex-col gap-1 max-h-60 overflow-y-auto';
                    
                    const currentScheduleForDay = dailySchedule[day] || [];

                    allCourses.forEach(course => {
                        const label = document.createElement('label');
                        label.className = 'flex items-center text-sm cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 p-1 rounded';
                        const isChecked = currentScheduleForDay.includes(course);
                        label.innerHTML = `
                            <input type="checkbox" class="schedule-check mr-2 h-4 w-4" 
                                   data-day="${day}" value="${course}" ${isChecked ? 'checked' : ''}>
                            <span class="${isChecked ? 'font-bold text-blue-600 dark:text-blue-400' : ''}">${course}</span>
                        `;
                        coursesList.appendChild(label);
                    });
                    
                    dayCol.appendChild(coursesList);
                    ui.scheduleGrid.appendChild(dayCol);
                });
                
                ui.scheduleModal.classList.add('active');
            };

            const saveSchedule = () => {
                const newSchedule = {'Lunes':[],'Martes':[],'Mi茅rcoles':[],'Jueves':[],'Viernes':[]};
                
                const checkboxes = document.querySelectorAll('.schedule-check:checked');
                checkboxes.forEach(cb => {
                    const day = cb.dataset.day;
                    const course = cb.value;
                    if (newSchedule[day]) {
                        newSchedule[day].push(course);
                    }
                });
                
                // Sort courses in each day for consistency
                for(const day in newSchedule) {
                    newSchedule[day].sort();
                }

                dailySchedule = newSchedule;
                saveAllData(true); // Saves schedule to localStorage
                generateTabs(); // Re-render the tabs
                ui.scheduleModal.classList.remove('active');
                showMessage('Horario actualizado con 茅xito.', 'success');
            };

            // --- App Initialization & Main Event Listeners ---
            function setupPeriodSelector() {
                ui.periodSelector.innerHTML = '';
                appSettings.periods.forEach(period => {
                    const option = document.createElement('option');
                    option.value = period.name;
                    option.textContent = period.name;
                    if (period.name === activePeriod) {
                        option.selected = true;
                    }
                    ui.periodSelector.appendChild(option);
                });
            }
            
            function renderPeriodsList() {
                const periodsList = document.getElementById('periodsList');
                periodsList.innerHTML = '';
                appSettings.periods.forEach(period => {
                    const div = document.createElement('div');
                    div.className = 'grid grid-cols-1 md:grid-cols-4 gap-2 items-center';
                    div.innerHTML = `
                        <input type="text" value="${period.name}" data-old-name="${period.name}" class="search-box md:col-span-2 period-name-input" placeholder="Nombre">
                        <input type="date" value="${period.start}" class="search-box period-start-input">
                        <input type="date" value="${period.end}" class="search-box period-end-input">
                    `;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-red-500 hover:text-red-700 text-xl ml-2';
                    deleteBtn.innerHTML = '&times;';
                    if (appSettings.periods.length <= 1) deleteBtn.classList.add('hidden');
                    deleteBtn.onclick = () => deletePeriod(period.name);
                    
                    div.appendChild(deleteBtn);
                    periodsList.appendChild(div);
                });
            }
            
            const generateTabs = () => {
                ui.tabNavigation.innerHTML = '';
                for (const day in dailySchedule) {
                    const dayBlock = document.createElement('div');
                    dayBlock.className = 'daily-group-block';
                    dayBlock.innerHTML = `<div class="daily-group-title">${day}</div><div class="group-buttons-wrapper"></div>`;
                    const wrapper = dayBlock.querySelector('.group-buttons-wrapper');
                    dailySchedule[day].forEach(group => {
                        const button = document.createElement('button');
                        button.id = `tab-${group}`;
                        button.className = 'tab-button';
                        button.textContent = group;
                        button.onclick = () => switchCourse(group);
                        wrapper.appendChild(button);
                    });
                    ui.tabNavigation.appendChild(dayBlock);
                }
            };

            const switchCourse = (course) => {
                activeCourse = course;
                ensureCourseData(activePeriod, activeCourse);
                document.querySelectorAll('.tab-button.active').forEach(b => b.classList.remove('active'));
                const tab = document.getElementById(`tab-${activeCourse}`);
                if(tab) tab.classList.add('active');
                renderTable();
            };
            

            const setupEventListeners = () => {
                const addListener = (elementKey, event, handler) => {
                    const element = ui[elementKey];
                    if (element) {
                        element.addEventListener(event, handler);
                    } else {
                        console.error(`Error: UI element '${elementKey}' not found. Could not add '${event}' listener.`);
                    }
                };

                // Main controls
                addListener('searchBox', 'input', () => debounce(renderTable, 300));
                addListener('darkModeToggle', 'change', () => {
                    localStorage.setItem('darkMode', ui.darkModeToggle.checked);
                    applyTheme(ui.darkModeToggle.checked);
                });
                addListener('settingsBtn', 'click', () => {
                    document.getElementById('professorNameInput').value = appSettings.professor;
                    document.getElementById('subjectNameInput').value = appSettings.subject;
                    document.getElementById('cognitivePercentage').value = appSettings.percentages.cognitive;
                    document.getElementById('proceduralPercentage').value = appSettings.percentages.procedural;
                    document.getElementById('attitudinalPercentage').value = appSettings.percentages.attitudinal;
                    document.getElementById('cognitiveCount').value = appSettings.gradeStructure.cognitive;
                    document.getElementById('proceduralCount').value = appSettings.gradeStructure.procedural;
                    document.getElementById('attitudinalCount').value = appSettings.gradeStructure.attitudinal;
                    renderPeriodsList();
                    ui.settingsModal.classList.add('active');
                });
                addListener('todayBtn', 'click', () => {
                    const dayMap = ['Domingo', 'Lunes', 'Martes', 'Mi茅rcoles', 'Jueves', 'Viernes', 'S谩bado'];
                    const todayIndex = new Date().getDay();
                    const todayName = dayMap[todayIndex === 0 || todayIndex === 6 ? 1 : todayIndex];
                    const courseForToday = dailySchedule[todayName]?.[0];
                    if (courseForToday) {
                        switchCourse(courseForToday);
                        showMessage(`Cambiando al primer curso de hoy: ${courseForToday}`, 'success');
                    } else {
                        showMessage('No hay cursos programados para hoy.', 'error');
                    }
                });
                addListener('periodSelector', 'change', (e) => {
                    activePeriod = e.target.value;
                    appSettings.activePeriod = activePeriod;
                    saveSettings();
                    renderTable();
                });

                // Table interactions
                addListener('attendanceTableContainer', 'click', (event) => {
                    const gradeCell = event.target.closest('.grade-cell');
                    const attendanceBox = event.target.closest('.attendance-box');
                    const clickedRow = event.target.closest('tr');
                    if (clickedRow?.parentElement.tagName === 'TBODY') {
                        const previouslySelected = ui.attendanceTableContainer.querySelector('tr.row-selected');
                        if (previouslySelected) {
                            previouslySelected.classList.remove('row-selected');
                        }
                        clickedRow.classList.add('row-selected');
                    }
                    if (gradeCell) enableEdit(gradeCell);
                    if (attendanceBox) updateAttendance(attendanceBox);
                });

                // Modals: Close buttons
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                            if (modal.id === 'voiceGradeModal' && isRecognitionSessionActive) {
                                stopRecognitionSession();
                            }
                        }
                    });
                });
                addListener('closeObsModal', 'click', () => ui.obsModal.classList.remove('active'));
                addListener('closeEditObsModal', 'click', () => ui.editObsModal.classList.remove('active'));
                addListener('closeDateNoteModal', 'click', () => ui.dateNoteModal.classList.remove('active'));
                addListener('closeGradeNoteModal', 'click', () => ui.gradeNoteModal.classList.remove('active'));
                addListener('closePasswordConfirmModal', 'click', () => ui.passwordConfirmModal.classList.remove('active'));
                addListener('closeSettingsModal', 'click', () => ui.settingsModal.classList.remove('active'));
                addListener('closeCourseManagementModal', 'click', () => ui.courseManagementModal.classList.remove('active'));
                addListener('closeStudentReportModal', 'click', () => ui.studentReportModal.classList.remove('active'));
                addListener('closeBulletinModal', 'click', () => ui.bulletinModal.classList.remove('active'));
                addListener('closeExportModal', 'click', () => ui.exportModal.classList.remove('active'));
                addListener('closeGradesModal', 'click', () => ui.gradesModal.classList.remove('active'));
                addListener('closeBulletinSelectionModal', 'click', () => ui.bulletinSelectionModal.classList.remove('active'));
                addListener('closeDataManagementModal', 'click', () => ui.dataManagementModal.classList.remove('active'));
                addListener('closeRankingModal', 'click', () => ui.rankingModal.classList.remove('active'));
                addListener('closeVoiceGradeModal', 'click', () => {
                    if (isRecognitionSessionActive) stopRecognitionSession();
                    ui.voiceGradeModal.classList.remove('active');
                    if(activeCourse === ui.voiceCourseSelector.value) renderTable();
                });
                addListener('closeGroupGradeModal', 'click', () => document.getElementById('groupGradeModal').classList.remove('active'));
                addListener('closeAdvancedDeleteModal', 'click', () => ui.advancedDeleteModal.classList.remove('active'));
                addListener('closePromoteModal', 'click', () => ui.promoteModal.classList.remove('active'));


                // Modals: Action buttons
                addListener('saveObs', 'click', () => {
                    const student = ui.obsStudentName.textContent;
                    const text = ui.obsTextarea.value.trim();
                    if (text && student) {
                        ensureStudentData(activePeriod, activeCourse, student);
                        const newObservation = { text, timestamp: new Date().toISOString() };
                        gradesData[activePeriod][activeCourse][student].observations.push(newObservation);
                        saveAllData(true);
                        showMessage("Observaci贸n guardada.", "success");

                        const icon = document.querySelector(`i[data-student-obs="${student}"]`);
                        if (icon) icon.classList.add('has-obs');

                    showObservationsModal(student); // Refresh modal
                }
            });

            addListener('saveGrades', 'click', () => {
                const student = ui.gradesModal.dataset.student;
                if (student) {
                    const gradeInputs = ui.gradesGrid.querySelectorAll('input[data-field]');
                    let allGradesValid = true;
                    
                    gradeInputs.forEach(input => {
                        const field = input.dataset.field;
                        const value = input.value;
                        // updateGrade validates, saves, and returns false on failure
                        if (!updateGrade(student, field, value, null)) { 
                            allGradesValid = false;
                        }
                    });

                    if (allGradesValid) {
                        ui.gradesModal.classList.remove('active');
                        renderTable(); // Re-render to show all changes
                        showMessage('Notas guardadas con 茅xito.', 'success');
                    }
                }
            });

            addListener('confirmPasswordBtn', 'click', () => ui.passwordInput.dispatchEvent(new KeyboardEvent('keydown', {'key': 'Enter'})));
            addListener('passwordInput', 'keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                        // The actual confirm logic is now attached dynamically to the button's onclick
                        ui.confirmPasswordBtn.click();
                    }
                });

                 addListener('saveEditObs', 'click', () => {
                    const { student, timestamp } = ui.editObsModal.dataset;
                    const newText = ui.editObsTextarea.value.trim();
                    const studentData = gradesData[activePeriod]?.[activeCourse]?.[student];
                    if (studentData) {
                        const observation = studentData.observations.find(o => o.timestamp === timestamp);
                        if (observation) {
                            observation.text = newText;
                            saveAllData(true);
                            showMessage("Observaci贸n actualizada.", "success");
                            ui.editObsModal.classList.remove('active');
                            showObservationsModal(student); // Refresh the main obs modal
                        }
                    }
                });

                addListener('saveSettingsBtn', 'click', () => {
                    appSettings.professor = document.getElementById('professorNameInput').value;
                    appSettings.subject = document.getElementById('subjectNameInput').value;
                    const cog = parseInt(document.getElementById('cognitivePercentage').value);
                    const proc = parseInt(document.getElementById('proceduralPercentage').value);
                    const att = parseInt(document.getElementById('attitudinalPercentage').value);

                    if (cog + proc + att !== 100) {
                        showMessage('La suma de los porcentajes debe ser 100.', 'error');
                        return;
                    }

                    appSettings.percentages.cognitive = cog;
                    appSettings.percentages.procedural = proc;
                    appSettings.percentages.attitudinal = att;
                    
                    appSettings.gradeStructure.cognitive = parseInt(document.getElementById('cognitiveCount').value) || 3;
                    appSettings.gradeStructure.procedural = parseInt(document.getElementById('proceduralCount').value) || 3;
                    appSettings.gradeStructure.attitudinal = parseInt(document.getElementById('attitudinalCount').value) || 3;

                    const newPeriods = [];
                    const periodRows = document.querySelectorAll('#periodsList > div');
                    periodRows.forEach(row => {
                        const oldName = row.querySelector('.period-name-input').dataset.oldName;
                        const newName = row.querySelector('.period-name-input').value.trim();
                        const start = row.querySelector('.period-start-input').value;
                        const end = row.querySelector('.period-end-input').value;

                        if (newName && start && end) {
                            newPeriods.push({ name: newName, start: start, end: end });
                            if (oldName !== newName && gradesData[oldName]) {
                                gradesData[newName] = gradesData[oldName];
                                delete gradesData[oldName];
                            }
                        }
                    });
                    appSettings.periods = newPeriods;
                    
                    if (!appSettings.periods.find(p => p.name === activePeriod)) {
                        activePeriod = appSettings.periods[0]?.name;
                        appSettings.activePeriod = activePeriod;
                    }

                    saveSettings();
                    setupPeriodSelector();
                    ui.settingsModal.classList.remove('active');
                    renderTable();
                });


                addListener('saveDateNote', 'click', () => {
                    const dateString = ui.dateNoteModal.dataset.date;
                    const text = ui.dateNoteTextarea.value.trim();
                    if (dateString) {
                        ensureCourseData(activePeriod, activeCourse);
                        gradesData[activePeriod][activeCourse].dateNotes[dateString] = text;
                        saveAllData(); // Re-render table to show note icon change
                        ui.dateNoteModal.classList.remove('active');
                    }
                });
                
                addListener('saveGradeNote', 'click', () => {
                    const noteGroup = ui.gradeNoteModal.dataset.noteGroup; // e.g., 'C1', 'P2'
                    const text = ui.gradeNoteTextarea.value.trim();
                    if (noteGroup) {
                        ensureCourseData(activePeriod, activeCourse);
                        
                        const componentType = noteGroup.charAt(0).toUpperCase(); // C, P, or A
                        const componentNumber = noteGroup.substring(1);
                        
                        const notes = gradesData[activePeriod][activeCourse].columnNotes;

                        // Check if it's a valid component number
                        if (['C', 'P', 'A'].includes(componentType) && !isNaN(parseInt(componentNumber))) {
                             // Replicate across C, P, A for the same number
                             notes[`C${componentNumber}`] = text;
                             notes[`P${componentNumber}`] = text;
                             notes[`A${componentNumber}`] = text;
                        } else {
                            // Fallback for any other note group that doesn't fit the pattern
                            notes[noteGroup] = text;
                        }

                        saveAllData(); // This will re-render the table with updated icons
                        ui.gradeNoteModal.classList.remove('active');
                        showMessage("Comentario guardado y replicado.", "success");
                    }
                });
                
                addListener('rankingBtn', 'click', showRankingModal);
                addListener('bulletinBtn', 'click', () => {
                    const studentCheckboxes = document.getElementById('studentSelectionCheckboxes');
                    studentCheckboxes.innerHTML = '';
                    (allStudentsData[activeCourse] || []).forEach(student => {
                        studentCheckboxes.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" value="${student}" class="form-checkbox h-5 w-5 rounded"><span>${student}</span></label>`;
                    });
                    const courseCheckboxes = document.getElementById('bulletinCourseSelectionCheckboxes');
                    courseCheckboxes.innerHTML = '';
                    Object.keys(allStudentsData).sort().forEach(course => {
                        courseCheckboxes.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" value="${course}" class="form-checkbox h-5 w-5 rounded"><span>${course}</span></label>`;
                    });
                    ui.bulletinSelectionModal.classList.add('active');
                });

                addListener('exportCsvBtn', 'click', () => {
                    const courseSelectionCheckboxes = document.getElementById('courseSelectionCheckboxes');
                    courseSelectionCheckboxes.innerHTML = '';
                    Object.keys(allStudentsData).sort().forEach(course => {
                        courseSelectionCheckboxes.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" value="${course}" class="form-checkbox h-5 w-5 rounded"><span>${course}</span></label>`;
                    });
                    ui.exportModal.classList.add('active');
                });
                
                addListener('voiceInputBtn', 'click', showVoiceGradeModal);
                addListener('voiceListenBtn', 'click', () => {
                    isRecognitionSessionActive = !isRecognitionSessionActive;
                    if (isRecognitionSessionActive) {
                        try { recognition.start(); } catch(e){ console.error(e); }
                    } else {
                        recognition.stop();
                    }
                });
                addListener('voiceCourseSelector', 'change', populateVoiceModal);
                addListener('voiceModeSelector', 'click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        ui.voiceModeSelector.querySelector('.active').classList.remove('active');
                        e.target.classList.add('active');
                        voiceGradingMode = e.target.dataset.mode;
                    }
                });

                // Data Management
                addListener('dataManagementBtn', 'click', () => ui.dataManagementModal.classList.add('active'));
                addListener('exportJsonBtn', 'click', exportAllDataToJson);
                addListener('importJsonBtn', 'click', () => ui.importJsonFile.click());
                addListener('importJsonFile', 'change', importAllDataFromJson);
                addListener('printStudentReportBtn', 'click', () => window.print() );
                addListener('addStudentBtn', 'click', () => {
                    const newStudentName = ui.newStudentName.value.trim();
                    if (newStudentName) {
                        const course = activeCourse;
                        if (!allStudentsData[course]) {
                            allStudentsData[course] = [];
                        }
                        if (allStudentsData[course].includes(formatStudentName(newStudentName))) {
                            showMessage('El estudiante ya existe en este curso.', 'error');
                            return;
                        }
                        allStudentsData[course].push(formatStudentName(newStudentName));
                        allStudentsData[course].sort((a,b) => a.localeCompare(b));
                        saveAllData(true);
                        ui.newStudentName.value = '';
                        showCourseManagementModal();
                        renderTable();
                    }
                });
                addListener('saveGroupGrade', 'click', () => {
                    const field = document.getElementById('groupGradeModal').dataset.field;
                    const grade = document.getElementById('groupGradeInput').value;
                    const selectedStudents = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);

                    selectedStudents.forEach(studentName => {
                        updateGrade(studentName, field, grade, null); // cellToUpdate is null
                    });
                    
                    document.getElementById('groupGradeModal').classList.remove('active');
                    renderTable(); // Re-render the entire table to show all changes
                    showMessage(`Nota aplicada a ${selectedStudents.length} estudiantes.`, 'success');
                });
                
                // Advanced Delete Listeners
                addListener('advancedCleanBtn', 'click', () => {
                    ui.advDeleteCourseName.textContent = activeCourse || 'Ninguno';
                    ui.advancedDeleteModal.classList.add('active');
                });
                addListener('confirmAdvancedDeleteBtn', 'click', handleAdvancedDelete);

                // Promote Students Listeners
                addListener('promoteStudentsBtn', 'click', populatePromoteModal);
                addListener('confirmPromoteBtn', 'click', executePromotion);
                addListener('togglePromoteTarget', 'click', (e) => {
                    e.preventDefault();
                    ui.promoteTargetInput.classList.toggle('hidden');
                    ui.promoteTargetSelect.classList.toggle('hidden');
                    if (ui.promoteTargetSelect.classList.contains('hidden')) {
                         ui.promoteTargetInput.focus();
                         e.target.textContent = 'Seleccionar curso existente';
                    } else {
                         e.target.textContent = 'Crear nuevo curso';
                    }
                });
                addListener('promoteSelectAll', 'click', () => {
                     document.querySelectorAll('.promote-student-check').forEach(cb => cb.checked = true);
                });
                addListener('promoteDeselectAll', 'click', () => {
                     document.querySelectorAll('.promote-student-check').forEach(cb => cb.checked = false);
                });
                
                // Toggle Scope Listener (New)
                document.querySelectorAll('input[name="promote-scope"]').forEach(radio => {
                    radio.addEventListener('change', (e) => togglePromoteScope(e.target.value));
                });
                
                // Schedule Listeners (New)
                addListener('editScheduleBtn', 'click', openScheduleModal);
                addListener('closeScheduleModal', 'click', () => ui.scheduleModal.classList.remove('active'));
                addListener('saveScheduleBtn', 'click', saveSchedule);
            };
            
            const initializeApp = () => {
                getUIElements();
                applyTheme(localStorage.getItem('darkMode') === 'true');
                loadSettings();
                loadAllData();
                
                // Normalize all student names on load
                for (const course in allStudentsData) {
                    if (Array.isArray(allStudentsData[course])) {
                        allStudentsData[course] = allStudentsData[course]
                            .map(student => formatStudentName(student))
                            .sort((a, b) => a.localeCompare(b));
                    }
                }

                setupPeriodSelector();
                generateTabs();
                setupEventListeners(); // Attaches all event listeners
                setupSpeechRecognition();

                // Select initial course based on today's date
                const dayMap = ['Domingo', 'Lunes', 'Martes', 'Mi茅rcoles', 'Jueves', 'Viernes', 'S谩bado'];
                const todayIndex = new Date().getDay();
                const todayName = dayMap[todayIndex === 0 || todayIndex === 6 ? 1 : todayIndex]; // Default to Monday if weekend
                const initialCourse = dailySchedule[todayName]?.[0] || Object.values(dailySchedule).flat()[0] || Object.keys(allStudentsData)[0];
                
                if (initialCourse) {
                    switchCourse(initialCourse);
                }
            };
            
            // --- Init ---
            initializeApp();
        });
    </script>
</body>
                            </html>
