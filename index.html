<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Calificaciones - Grupos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- PDF & Image Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS Variables for theming */
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg-color: #ffffff;
            --header-bg-color: #4b5563;
            --sticky-col-bg: #f9fafb;
            --border-color: #e5e7eb;
            --input-border-color: #d1d5db;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --tab-block-bg: #f1f5f9;
            --tab-button-bg: #e2e8f0;
            --tab-button-text: #475569;
            --row-selected-bg: #dbeafe;
        }

        html.dark {
            --bg-color: #1f2937;
            --text-color: #f3f4f6;
            --card-bg-color: #374151;
            --header-bg-color: #111827;
            --sticky-col-bg: #4b5563;
            --border-color: #4b5563;
            --input-border-color: #6b7280;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --tab-block-bg: #4b5563;
            --tab-button-bg: #64748b;
            --tab-button-text: #e2e8f0;
            --row-selected-bg: #1e3a8a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            width: 100%;
            max-width: 95%;
            margin: auto;
            background-color: var(--card-bg-color);
            box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color);
        }
        .table-container {
            max-height: 75vh;
            overflow: auto;
            border-radius: 0.5rem;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            padding: 0.75rem;
            text-align: center;
            font-size: 0.875rem;
            white-space: nowrap;
            background-color: var(--card-bg-color);
        }
        td, thead tr:last-child th {
            border-bottom: 1px solid var(--border-color);
        }
        thead tr:first-child th {
            border-bottom: 1px solid var(--header-bg-color);
        }
        tr:last-child td { border-bottom: none; }

        /* --- STICKY & COLUMN STYLES --- */
        thead th {
            position: sticky; top: 0;
            background-color: var(--header-bg-color);
            color: #ffffff; z-index: 20;
            vertical-align: middle; height: 70px;
        }
        thead tr:nth-child(2) th { top: 70px; }
        .sticky-left { position: sticky; left: 0; box-shadow: 2px 0 5px -2px var(--shadow-color); }
        th.sticky-left { z-index: 22; background-color: var(--header-bg-color); }
        td.sticky-left { z-index: 21; background-color: var(--sticky-col-bg); }

        .sticky-col-no { left: 0; width: 50px; min-width: 50px; }
        .sticky-col-name { left: 50px; width: 220px; min-width: 220px; text-align: left; }
        .sticky-col-actions { left: 270px; width: 120px; min-width: 120px; }
        .sticky-col-summary { left: 390px; width: 120px; min-width: 120px; }
        
        /* Row Selection Highlight */
        tbody tr:hover > td, tbody tr:hover > .sticky-left {
            background-color: var(--sticky-col-bg);
        }
        tr.row-selected > td {
            background-color: var(--row-selected-bg);
        }
        tr.row-selected > td.sticky-left {
            background-color: var(--row-selected-bg);
        }


        /* --- Grade & Input Styles --- */
        .grade-cell { 
            width: 70px; 
            min-width: 70px; 
            cursor: pointer;
            position: relative;
        }
        .grade-input { width: 100%; padding: 0.25rem; border: 1px solid var(--input-border-color); border-radius: 0.25rem; text-align: center; background-color: var(--card-bg-color); color: var(--text-color); }
        .col-def, .col-nivel { width: 80px; min-width: 80px; font-weight: bold; }

        /* Performance Level Colors */
        .nivel-bajo { background-color: #fee2e2; color: #991b1b; }
        .nivel-basico { background-color: #fef9c3; color: #854d0e; }
        .nivel-alto { background-color: #dcfce7; color: #166534; }
        .nivel-superior { background-color: #dbeafe; color: #1e40af; }
        html.dark .nivel-bajo { background-color: #7f1d1d; color: #fecaca; }
        html.dark .nivel-basico { background-color: #713f12; color: #fef08a; }
        html.dark .nivel-alto { background-color: #14532d; color: #bbf7d0; }
        html.dark .nivel-superior { background-color: #1e3a8a; color: #bfdbfe; }
        tr.row-selected .nivel-bajo, tr.row-selected .nivel-basico, tr.row-selected .nivel-alto, tr.row-selected .nivel-superior {
            color: var(--text-color); /* Ensure text is readable when row is selected */
        }


        /* --- Attendance Styles --- */
        .attendance-box {
            cursor: pointer; width: 28px; height: 28px; border: 1px solid var(--input-border-color);
            border-radius: 0.375rem; display: flex; align-items: center; justify-content: center;
            margin: auto; font-size: 1.1rem; font-weight: bold; line-height: 1; transition: all 0.2s ease-in-out;
        }
        .attendance-box.attended { background-color: #dcfce7; color: #16a34a; border-color: #16a34a; }
        .attendance-box.absent { background-color: #fee2e2; color: #ef4444; border-color: #ef4444; }
        .attendance-box.excused { background-color: #e0e7ff; color: #4338ca; border-color: #4338ca; }
        .date-header { vertical-align: bottom; padding: 0.25rem; }
        .date-header div:first-child { transform: rotate(-90deg); white-space: nowrap; display: block; width: 30px; margin: 0 auto 25px auto; }
        td.attendance-cell { width: 60px; min-width: 60px; }
        .attendance-bulk-btn { font-size: 0.75rem; padding: 2px 4px; border-radius: 4px; margin: 1px 0; display: block; width: 100%; border: 1px solid #fff; }

        /* --- UI Elements --- */
        .controls-container { display: flex; flex-direction: column; align-items: stretch; sm:flex-row; sm:justify-between; sm:items-center; gap: 1rem; margin-bottom: 1.5rem; }
        .search-box { padding: 0.5rem; border: 1px solid var(--input-border-color); border-radius: 0.5rem; background-color: var(--card-bg-color); width: 100%; sm:w-auto; }
        .action-button { background-color: #4b5563; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; text-align: center; }
        .action-button:hover { background-color: #374151; }
        html.dark .action-button { background-color: #1f2937; }
        html.dark .action-button:hover { background-color: #111827; }
        .button-group { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }

        /* Dark Mode Toggle */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Tab Navigation Styles */
        .daily-schedule-container { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1.5rem; }
        .daily-group-block { background-color: var(--tab-block-bg); border-radius: 0.75rem; padding: 0.75rem; box-shadow: 0 1px 3px 0 var(--shadow-color); }
        .daily-group-title { font-weight: 600; text-align: center; margin-bottom: 0.5rem; color: var(--text-color); }
        .group-buttons-wrapper { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
        .tab-button { padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease; cursor: pointer; background-color: var(--tab-button-bg); color: var(--tab-button-text); }
        .tab-button.active { background-color: #3b82f6; color: #ffffff; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--card-bg-color); padding: 2rem; border-radius: 0.75rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-content textarea { width: 100%; min-height: 150px; border: 1px solid var(--input-border-color); border-radius: 0.5rem; padding: 0.5rem; background-color: var(--bg-color); color: var(--text-color); }
        .bulletin-content { border: 1px solid var(--border-color); padding: 1.5rem; }
        
        /* Stats Panel */
        .stats-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; background-color: var(--bg-color); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; align-items: center;}
        .stat-item { text-align: center; }
        #statsChartContainer { max-height: 120px; }

        /* Action Icons in Table */
        .action-icon { cursor: pointer; margin: 0 0.25rem; font-size: 1rem; transition: color 0.2s; }
        .action-icon:hover { color: #3b82f6; }
        .action-icon.has-obs { color: #f59e0b; } /* Amber color for observation icon */
        .action-icon.has-obs:hover { color: #d97706; }
        
        /* Custom Tooltip */
        #customTooltip {
            pointer-events: none; /* Make sure the tooltip doesn't interfere with mouse events */
            background-color: var(--header-bg-color);
            color: #ffffff;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px var(--shadow-color);
            max-width: 250px;
            word-wrap: break-word;
            z-index: 150;
        }

        /* --- Responsive Design for Mobile & Tablet --- */
        .action-grades-btn { display: none; } /* Oculto por defecto */
        
        @media (max-width: 1024px) { 
            .grade-column { display: none; } /* Oculta columnas de notas en pantallas pequeñas */
            .action-grades-btn { display: inline-block; } /* Muestra el botón de editar notas */
        }

        .bulletin-page {
             background-color: white;
             color: black;
        }

        .bulletin-page * {
             color: black !important;
        }
        
        /* Print styles */
        @media print {
            body * { visibility: hidden; }
            #studentReportContent, #studentReportContent * { visibility: visible; }
            #studentReportContent { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }

    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="container rounded-xl p-4 sm:p-8 mt-4">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6">Control de Calificaciones y Asistencia</h1>
        
        <div class="flex justify-center items-center mb-4">
            <label for="periodSelector" class="mr-2 font-semibold">Periodo:</label>
            <select id="periodSelector" class="search-box"></select>
        </div>

        <div id="tabNavigation" class="daily-schedule-container"></div>
        <h2 id="courseTitle" class="text-2xl font-bold text-center mb-2"></h2>
        <div id="courseInfo" class="text-center text-gray-500 dark:text-gray-400 mb-4"></div>

        <!-- Controls -->
        <div class="controls-container">
            <input type="text" id="searchBox" class="search-box" placeholder="Buscar estudiante...">
            <div class="flex items-center justify-center sm:justify-end w-full sm:w-auto gap-4">
                <div class="button-group">
                    <button id="bulletinBtn" class="action-button"><i class="fas fa-id-card mr-2"></i>Boletines</button>
                    <button id="exportBtn" class="action-button"><i class="fas fa-file-csv mr-2"></i>Exportar</button>
                    <button id="importBtn" class="action-button"><i class="fas fa-upload mr-2"></i>Importar</button>
                    <input type="file" id="importFile" class="hidden" accept=".txt">
                </div>
                <div class="flex items-center gap-2">
                    <i id="settingsBtn" class="fas fa-cog text-2xl cursor-pointer text-gray-500 hover:text-blue-500 transition-colors"></i>
                    <label class="toggle-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Stats Panel -->
        <div id="statsPanel" class="stats-panel"></div>
        
        <!-- Table -->
        <div id="attendanceTableContainer" class="table-container"></div>
        
        <!-- Modals -->
        <div id="obsModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Observaciones para <span id="obsStudentName"></span></h3>
                <div id="obsHistory" class="mb-4 p-2 border rounded max-h-48 overflow-y-auto" style="border-color: var(--input-border-color);">
                    <!-- History will be populated by JS -->
                </div>
                <textarea id="obsTextarea" placeholder="Añadir nueva observación..."></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeObsModal" class="action-button">Cerrar</button>
                    <button id="saveObs" class="action-button bg-blue-600">Añadir Observación</button>
                </div>
            </div>
        </div>

        <div id="dateNoteModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Anotación para la fecha: <span id="dateNoteDate"></span></h3>
                <textarea id="dateNoteTextarea" placeholder="Añadir un evento o nota para este día (ej. Examen, Salida pedagógica)..."></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeDateNoteModal" class="action-button">Cerrar</button>
                    <button id="saveDateNote" class="action-button bg-blue-600">Guardar</button>
                </div>
            </div>
        </div>

        <div id="gradeNoteModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Comentario para <span id="gradeNoteTitle"></span></h3>
                <textarea id="gradeNoteTextarea"></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeGradeNoteModal" class="action-button">Cerrar</button>
                    <button id="saveGradeNote" class="action-button bg-blue-600">Guardar</button>
                </div>
            </div>
        </div>

        <div id="deleteConfirmModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Confirmar Borrado</h3>
                <p class="mb-4">Para borrar esta observación, por favor ingresa la clave de seguridad.</p>
                <input type="password" id="deletePasswordInput" class="search-box w-full" placeholder="Clave de seguridad...">
                <div id="deleteErrorMsg" class="text-red-500 text-sm mt-2 hidden">Clave incorrecta.</div>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeDeleteConfirmModal" class="action-button">Cancelar</button>
                    <button id="confirmDeleteBtn" class="action-button bg-red-600">Confirmar Borrado</button>
                </div>
            </div>
        </div>

        <div id="genericConfirmModal" class="modal-overlay">
            <div class="modal-content">
                <h3 id="genericConfirmTitle" class="text-xl font-bold mb-4">Confirmar Acción</h3>
                <p id="genericConfirmText" class="mb-4 whitespace-normal">¿Estás seguro?</p>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeGenericConfirmModal" class="action-button">Cancelar</button>
                    <button id="confirmGenericBtn" class="action-button bg-red-600">Confirmar</button>
                </div>
            </div>
        </div>
        
        <div id="settingsModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Configuración General</h3>
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold mb-2">Información del Docente</h4>
                        <div class="grid grid-cols-1 gap-4">
                            <div><label for="professorNameInput">Nombre del Docente:</label><input type="text" id="professorNameInput" class="search-box w-full"></div>
                            <div><label for="subjectNameInput">Nombre de la Asignatura:</label><input type="text" id="subjectNameInput" class="search-box w-full"></div>
                        </div>
                    </div>
                     <div>
                        <h4 class="font-semibold mb-2">Porcentajes de Evaluación (%)</h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div><label for="cognitivePercentage">Cognitivo:</label><input type="number" id="cognitivePercentage" class="search-box w-full"></div>
                            <div><label for="proceduralPercentage">Procedimental:</label><input type="number" id="proceduralPercentage" class="search-box w-full"></div>
                            <div><label for="attitudinalPercentage">Actitudinal:</label><input type="number" id="attitudinalPercentage" class="search-box w-full"></div>
                        </div>
                    </div>
                     <div>
                        <h4 class="font-semibold mb-2">Gestión de Periodos</h4>
                        <div id="periodsList" class="space-y-2"></div>
                        <div class="flex gap-2 mt-2">
                           <input type="text" id="newPeriodName" class="search-box flex-grow" placeholder="Nombre del nuevo periodo">
                           <button id="addPeriodBtn" class="action-button bg-green-600">+</button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button id="closeSettingsModal" class="action-button">Cerrar</button>
                    <button id="saveSettingsBtn" class="action-button bg-blue-600">Guardar Cambios</button>
                </div>
            </div>
        </div>
        
         <div id="courseManagementModal" class="modal-overlay">
            <div class="modal-content">
                 <h3 class="text-xl font-bold mb-4">Gestión del Curso: <span id="courseManagementTitle"></span></h3>
                 <div>
                    <h4 class="font-semibold mb-2">Lista de Estudiantes</h4>
                    <div id="studentManagementList" class="space-y-2 max-h-60 overflow-y-auto border p-2 rounded" style="border-color: var(--input-border-color);"></div>
                    <div class="flex gap-2 mt-2">
                       <input type="text" id="newStudentName" class="search-box flex-grow" placeholder="Nombre del nuevo estudiante">
                       <button id="addStudentBtn" class="action-button bg-green-600">+</button>
                    </div>
                </div>
                 <div class="flex justify-end gap-2 mt-6">
                    <button id="closeCourseManagementModal" class="action-button">Cerrar</button>
                </div>
            </div>
        </div>

        <div id="studentReportModal" class="modal-overlay">
            <div class="modal-content max-w-2xl">
                <div id="studentReportContent">
                    <!-- Report content will be generated here -->
                </div>
                <div class="flex justify-end gap-2 mt-4 no-print">
                    <button id="closeStudentReportModal" class="action-button">Cerrar</button>
                    <button id="printStudentReportBtn" class="action-button bg-blue-600"><i class="fas fa-print mr-2"></i>Imprimir</button>
                </div>
            </div>
        </div>

        <div id="bulletinModal" class="modal-overlay">
            <div class="modal-content">
                <div id="bulletinContent">
                    <!-- Content will be generated by JS -->
                </div>
                 <div class="flex justify-end gap-2 mt-4 no-print">
                    <button id="closeBulletinModal" class="action-button">Cerrar</button>
                    <button id="downloadPngBtn" class="action-button bg-green-600"><i class="fas fa-file-image"></i> PNG</button>
                    <button id="downloadPdfBtn" class="action-button bg-red-600"><i class="fas fa-file-pdf"></i> PDF</button>
                </div>
            </div>
        </div>
        
        <div id="exportModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Opciones de Exportación</h3>
                <div class="flex flex-col gap-4">
                    <button id="exportCurrentBtn" class="action-button w-full">Exportar Curso Actual</button>
                    <button id="exportAllBtn" class="action-button w-full">Exportar Todos los Cursos</button>
                    <div>
                        <h4 class="font-semibold mb-2 text-left">Selección Personalizada:</h4>
                        <div id="courseSelectionCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-48 overflow-y-auto p-2 border rounded" style="border-color: var(--input-border-color);">
                            <!-- Checkboxes will be inserted here by JS -->
                        </div>
                        <button id="exportSelectedBtn" class="action-button w-full mt-4">Exportar Selección</button>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                     <button id="closeExportModal" class="action-button">Cerrar</button>
                </div>
            </div>
        </div>


        <div id="gradesModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Notas para <span id="gradesStudentName"></span></h3>
                <div id="gradesGrid" class="grid grid-cols-3 gap-x-4 gap-y-2"></div>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="closeGradesModal" class="action-button">Cerrar</button>
                    <button id="saveGrades" class="action-button bg-blue-600">Guardar</button>
                </div>
            </div>
        </div>
        
        <div id="bulletinSelectionModal" class="modal-overlay">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Generar Boletines en PDF</h3>
                <div class="flex flex-col gap-4">
                    <!-- Option 1: All Courses -->
                    <button id="generateAllCoursesBulletinBtn" class="action-button w-full">Generar PDF de Todos los Cursos</button>
                    
                    <!-- Option 2: Current Course -->
                    <button id="generateCurrentCourseBulletinBtn" class="action-button w-full">Generar PDF del Curso Actual</button>
                    
                    <!-- Option 3: Selected Courses -->
                    <div>
                        <h4 class="font-semibold mb-2 text-left">Selección por Cursos:</h4>
                        <div id="bulletinCourseSelectionCheckboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-48 overflow-y-auto p-2 border rounded" style="border-color: var(--input-border-color);">
                            <!-- Course checkboxes will be inserted here by JS -->
                        </div>
                        <button id="generateSelectedCoursesBtn" class="action-button w-full mt-4">Generar PDF de Cursos Seleccionados</button>
                    </div>

                    <!-- Option 4: Selected Students in Current Course -->
                    <div>
                        <h4 class="font-semibold mb-2 text-left">Selección por Estudiantes (Curso Actual):</h4>
                        <div class="flex justify-between items-center mb-2">
                             <button id="selectAllStudentsBtn" class="text-sm text-blue-500 hover:underline">Seleccionar Todos</button>
                             <button id="deselectAllStudentsBtn" class="text-sm text-blue-500 hover:underline">Deseleccionar Todos</button>
                        </div>
                        <div id="studentSelectionCheckboxes" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-48 overflow-y-auto p-2 border rounded" style="border-color: var(--input-border-color);">
                            <!-- Student checkboxes will be inserted here -->
                        </div>
                        <button id="generateSelectedStudentsBtn" class="action-button w-full mt-4">Generar PDF de Estudiantes Seleccionados</button>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                     <button id="closeBulletinSelectionModal" class="action-button">Cerrar</button>
                </div>
            </div>
        </div>

        <div class="w-full text-center mt-8 text-sm text-gray-500">Diseñado por Juan Miguel Ríos Redondo</div>
    </div>

    <div id="customTooltip" class="hidden absolute p-2 text-sm rounded-md shadow-lg max-w-xs whitespace-normal"></div>

    <script>
        // UI Elements
        const tableContainer = document.getElementById('attendanceTableContainer');
        const courseTitle = document.getElementById('courseTitle');
        const courseInfo = document.getElementById('courseInfo');
        const tabNavigation = document.getElementById('tabNavigation');
        const searchBox = document.getElementById('searchBox');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const statsPanel = document.getElementById('statsPanel');
        const obsModal = document.getElementById('obsModal');
        const dateNoteModal = document.getElementById('dateNoteModal');
        const gradeNoteModal = document.getElementById('gradeNoteModal');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const settingsModal = document.getElementById('settingsModal');
        const courseManagementModal = document.getElementById('courseManagementModal');
        const studentReportModal = document.getElementById('studentReportModal');
        const bulletinModal = document.getElementById('bulletinModal');
        const exportModal = document.getElementById('exportModal');
        const gradesModal = document.getElementById('gradesModal');
        const gradesStudentName = document.getElementById('gradesStudentName');
        const gradesGrid = document.getElementById('gradesGrid');
        const bulletinBtn = document.getElementById('bulletinBtn');
        const bulletinSelectionModal = document.getElementById('bulletinSelectionModal');
        const periodSelector = document.getElementById('periodSelector');
        const settingsBtn = document.getElementById('settingsBtn');


        // App State
        let dailySchedule = {'Lunes':['8C','9B'],'Martes':['8A','9C','11A','11B'],'Miércoles':['8B','9A'],'Jueves':['10C','11C','11D'],'Viernes':['8D','9D','7D']};
        const dayNameToNumber = { 'Lunes': 1, 'Martes': 2, 'Miércoles': 3, 'Jueves': 4, 'Viernes': 5 };
        let activeCourse;
        let activePeriod;
        let appSettings;
        let gradesData = {};
        let allStudentsData = {
            '7D':["AHUMADA SIERRA THAEL","AMARIS SIERRA JULEISY","BENITEZ BOSSIO MARIA","BOLIVAR GOMEZ MARIA","CABALLERO SILVERA JOHELIS","CARMONA SILVERA LEYNER","CARPINTERO SILVERA THALIA","CONSUEGRA ALVAREZ JHOINER","ESCORCIA RIVALDO CAMILO","GERONIMO BARRAZA HELLEN","GOEZ OTERO DANIEL","GONZALEZ BARRAZA DANNA","GUANIPA GUTIERREZ ARANZA","GUTIERREZ OJEDA EMMANUEL","HERNANDEZ DIAZ JESUS","LLANOS SEGURA YAILETH","MARIN PALMA SANTIAGO","MARMOL HERNANDEZ SEBASTIAN","NAVAS CEDEÑO ANGEL","NIETO ROLONG MARY","ORTEGA BENITEZ IVIAN","ORTEGA MANGA ANGELLYS","PATINO BORRERO HARRISON","PEREZ ALVAREZ MARIA","PEREZ NATERA VALENTINA","PIMIENTA OTERO LAURENS","POLO REDONDO MARIA","PRADA SARMIENTO BRAYAN","SANTIAGO DACONTE ANDRES","SIERRA CASTILLO MAURICIO","SIERRA GOMEZ LIZETH","SMITH SANTIAGO VALERIA","SUAREZ GALLARDO MATEO","TORRES FERNANDEZ SANTIAGO","ZARATE REDONDO YAJAIRA"],
            '8A':["ARIZA CONSUEGRA STEISY","BARRAZA HERNANDEZ RONALD","BARRIOS MOLINA LITZY","BECERRA CRESPO MANOLO","BELLIDO CASIANO LEIDER","BERRUEZO ORTEGA SAMANTHA","BLANCO REYES ANGEL","BOLIVAR ESCOBAR VALENTINA","CIRO ROMERO ANGELA","DE LA CRUZ SIERRA ALAN","DITA ESCALANTE GILMAR","ESCALANTE OSPINO ANDERSON","ESCOBAR ALGARIN LILIANA","GOMEZ VILLA ANA","GUTIERREZ PAEZ ANA","JIMÉNEZ QUINTANA FREDDY","JIMENEZ RUA NASLI","LLANOS REDONDO ADRIANA","LLANOS REYES ANDRES","MARQUEZ MARIN VALERIN","MARQUEZ VILORIA EMILY","MARTINEZ ORTEGA JESUS","MOLINA GUTIERREZ JULIE","ORDOÑEZ GARCIA LEONARDO","PACHECO AVILA MARIA","PEREZ ARAUJO ANDRÉS","REDONDO PATIÑO DELEVIS","RODRIGUEZ SANJUAN SALOME","SANTIAGO JULIO ASLY","SIERRA GOMEZ LUISA","SILVERA GOMEZ GABRIEL","SILVERA ORTEGA MAYLER","TEJERA ORTEGA LUIS","VANEGAS DE LA CRUZ DANIELA","VEGA ORTIZ EYEELIN","VELASQUEZ GARCIA MANUEL"],
            '8B':["AREVALO ARCON JOSE","BARRETO ROLONG MARIANA","BARRIOS PUENTES BLAYNER","BULA PEREZ MARIA","BUSTOS BARRIOS HONEY","CASTRO CASTRO DASHARY","CASTRO HARO JEAN","CONTRERAS SANJUAN IVANNA","CORREDOR BARBOSA SAMUEL","COTES ESCALANTE YESID","GARCIA VARELA SHADAY","GONZALEZ SILVERA LILIBETH","HEREDIA LOPEZ EYLIN","HERNANDEZ DE LA CRUZ MIGUEL","HERNANDEZ LLANOS GUADALUPE","HERNANDEZ LLANOS JESE","HERRERA POLO LINA","JAIME ROA ANYELO","LINARES ESTEVEZ MAYTE","LUQUE GONZALEZ YANKELIS","MONSALVO QUINTERO ADRIAN","MONTERROSA CABALLERO LAURA","NORIEGA REDONDO WENDY","POLO JIMENEZ NORELLA","RADA GUTIERREZ AISHA","REDONDO FRANCO LUIS","RINCON PEREZ ANGIELIN","SALAZAR ZAMBRANO RICHARD","SIERRA OROZCO ANGGY","SILVERA ESCOBAR DAYAR","SILVERA JIMENEZ NICOLL","SILVERA SANJUAN ADALYANA","SOSA BERRIO DEICY","SUAREZ DURAN JOSTIN","TOMASES RADA THIAGO","URANGO PACHECO DEILER","VILLAMIL HERNANDEZ XIMENA"],
            '8C':["ACOSTA CAICEDO DAIMAR","ACUÑA VALENCIA LUIS","ARAUJO MENDOZA SIRIANA","BANDERA LLANOS SHAILETH","BURGUILLOS CARBONELL JHOSNIEL","CARDENAS CHIQUILLO MICHAELL","CASTRO GOMEZ SHERIL","CERVANTES LARA MAURO","DE LA CRUZ PIÑERES SERGIO","DE LA CRUZ REDONDO ANTONY","DE LA HOZ CABAS YEFFER","ESCORCIA MIRANDA GUADALUPE","FERRER SANTANDER DAMIAN","GARCIA PEÑATE MARIA","GARCIA ROJAS TIFFANY","GOMEZ OTERO JANNIER","GONZALEZ SALCEDO MARIA","HURTADO ORTIZ ALAN","LLANOS TAGUER BRANDON","MADERA ORTEGA ANA","MEZA SIERRA JAMES","MORALES PERCY KEREN","OLANO PAZ YARIANGEL","ORTEGA SIERRA VALENTINA","PEREZ GONZALEZ SHAIRA","PEREZ NAVAS VALENTINA","POLO GUERRA XAVIER","RADA CORRO STEPHANIE","RANGEL SIERRA LAUREN","RICO ZAPATA DANNA","RIVALDO PALMA MILAGRO","RIVALDO PALMA TAΝΙΑ","ROSANIA MINDIOLA DIEGO","SARMIENTO MARTINEZ MARI","SILVA SILVERA SOFIA","SILVERA CERVANTES MILTON","TRIGOS OROZCO SHELSY"],
            '8D':["ACOSTA HERNANDEZ EMILY GISELL","ACUÑA MARTINEZ JOB DAVID","ANGULO DE LA CRUZ NAHIARA MICHEL","BALVIN ROMERO NORMA GABRIELA","CABALLERO ACEVEDO MARIA ALEJANDRA","CABELLO NATERA STEVE EMANUEL","CONTRERAS SARMIENTO ANGELLYS NICOLLE","COSSIO NARVAEZ ANGELA VICTORIA","ESTRADA LLANOS MOISES ALEXANDER","FRANCO RODRIGUEZ JUAN DAVID","GUZMAN PEÑATE LUIS ALBERTO","HERNANDEZ PALLARES FERNANDO JUNIOR","HERNANDEZ REDONDO SHAYRA NICOLL","JIMENEZ ACUÑA MARIANA ISABEL","JIMENEZ SIERRA KAROL SOFIA","LLERENA IMITOLA JADER JOSE","MADARIAGA LOPEZ LUISA FERNANDA","MAESTRE DE LA HOZ MARIELYS MILETH","MENDOZA GOEZ DANIELA ROSA","MOLINA PALLARES MATIAS","MONCADA SIERRA MARIA CAROLINA","MORALES ORTEGA JOSSUET","OROZCO GONZALEZ DULCE MARIA","ORTEGA HERNANDEZ SARAY DE JESUS","PACHECO SILVERA ANGILIS MILETH","PINO MARIANO MARIANA PATRICIA","POLO ORELLANO JUAN SEBASTIAN","POLO VERGARA SHARY SOFÍA","RANGEL MARTINEZ MELANI PAOLA","RINCON GOMEZ ALEJANDRO DAVID","ROA RADA DANIEL DE JESUS","ROA RADA EDGAR ANDRES","RODRIGUEZ BUSTILLO GABRIELA LUCIA","ROLONG GOEZ JUAN ANDRES","ROMERO PEÑA NEYMAR","RUDAS VARGAS YAIRIS MARIA","SANTIAGO REYES OMER DE JESUS","SIERRA CASTILLO LUIS JOSE","SIERRA VARELA ANDREA CAMILA"],
            '9A':["ACOSTA PADILLA OVER","ACOSTA PALMA CRISTHIAN","AMADOR PALMA ALVARO","ARCON ALVAREZ SEBASTIAN","ARTETA CONSUEGRA JANNY","AVILA MEZA MAUREN","BARRAZA SIERRA LUIS","BARRIOS LLANOS GERALDINE","BARRIOS SIERRA BRIANA","CAMARGO DE LA CRUZ LEINYS","CAMARGO MARTINEZ MARIA","CANOSA CERVANTES VIVIANA","CORTES PIÑA JHOVANNY","COSSIO NARVAEZ HEIDY","DE LA HOZ VIZCAINO BUENDI","ESCORCIA BLANCO MELANY","ESCORCIA MIRANDA JESUS","FERNANDEZ ANGULO SHARICK","GALINDO ESCALANTE SHARON","GALLARDO BRADFORD JHOYMAR","LOPEZ MITROBICH MARIMAR","MARRIAGA SANJUAN SOCHY","MURILLO SILVERA YEYCI","ORELLANO MOLINA CICLALIS","ORTIZ PEREZ CRISTIAN","OTERO CARDENAS ADAN","OTERO NIETO JAIR","PEÑA MEZA VICTOR","POLO CONTRERAS ANDERSON","POLO PALMA SAILLY","RADA JIMÉNEZ JESUS","RADA NIEVES DAMARIS","REDONDO SALGADO ALEJANDRA","RODRIGUEZ ANGULO DANNA","SALAZAR IGLESIAS TALIANA","SANTIAGO LOPEZ MARIA","SARMIENTO CERVANTES VALEREE","SARMIENTO DE LA RANS ALAN","TURBAY GOMEZ LAIONEL","ΖΑΡΑΤA ROA LUIS"],
            '9B':["ANGULO BARRAGAN CARLOS","ARAUJO ESCALANTE YELIANYS","ARTETA ZARATE JHAN","BARRAZA CAFIEL VALENTINA","BLANCO ESTRADA JENIFER","BLANCO SILVERA YAIKOVIC","BOLIVAR MARRIAGA YANDERSON","ESCOBAR ALGARIN JOSE","FERRER SANTANDER LOGAN","FONTALVO PUELLO CRISTIAN","GARCIA CAMARGO ANGELY","GERONIMO ROJAS EMMANUEL","GIL GUTIERREZ AΝΑ","GOENAGA LEJARDE JULIANNY","GUTIERREZ SIERRA SANTIAGO","HERNANDEZ LOPEZ MARIA","HERNANDEZ MONTAÑO MARIA","JIMENEZ CONSUEGRA TANIA","MARIN MORALES GENESIS","MARTINEZ DAZA EILYN","MEDINA RIQUETT KELLY","MOLINA VELASQUEZ LERVYS","MORALES OTERO JESUS","MOVILLA BOLIVAR EYMIS","NAVARRO GUTIERREZ ALEJANDRO","ORTEGA CUERVO KRISTEL","ORTIZ JIMENEZ ELIATH","PALMA SILVERA MARISOL","PATIÑO CONSUEGRA ANDRYS","PEREZ ALGARIN LUCIANA","PEREZ BOLIVAR JHONEFFER","REDONDO RODRIGUEZ KARLA","RODRIGUEZ VEGA YESID","RUIZ MARENCO JUAN","SILVERA JIMENO THALIANA","TEJERA ORTEGA VALENTINA","TESILLO PEREZ CARLOS","TORRADO NOREÑA CRISTIAN","ZAPATA SIERRA LUCYANA"],
            '9C':["BALLESTAS DE LA CRUZ OWEL","BARANDICA GUTIERREZ IKER","CAMARGO CABALLERO JHONNY","CONSUEGRA HERNANDEZ ANGIE","DIAZ DEL TORO SHARILYN","ESCORCIA BORNACELLY NATHALIA","ESCORCIA DE LA CRUZ LUISA","ESTRADA RUA JHON","GOENAGA DE AVILA CARLOS","GONZALEZ CONTRERAS YURLANYS","GONZALEZ FERRER MAIRELYS","GONZALEZ LLANOS ANA","GONZALEZ RICO JAVIER","HURTADO ORTIZ AMY","JIMENEZ BADILLO JUAN","JIMENEZ DE LA CRUZ JUSETH","LINARES TEJEDA MARCELA","LUBO JIMENEZ ALEJANDRO","MARTINEZ CASTILLO DANNA","MEDINA SILVERA DILAN","MIRANDA FERNANDEZ ANTONNY","MOLINA ARRIETA KAIRETH","OCHOA ORTEGA JOSE","ORTEGA LUNAR DIEGO","PEREZ GERONIMO EYMER","PRADA SARMIENTO SHARICK","REDONDO BERDUGO MARIANA","RICAURTE SANTANA MARIA","RIOS ARCON ARANZA","RIOS NAVAS VICTOR","ROA DE LA CRUZ PEDRO","ROMERO JIMENEZ STEVAN","SILVERA LINARES ANDRES","SILVERA VILORIA SNEYDER","VARGAS CASTRO SAMIR","VILORIA CABARCAS ESTEFANY"],
            '9D':["AMAYA PAZ JEIVER","ARDILA ORDUZ ALISSON","BLANCO SIERRA ANDY","BUSTOS BARRIOS ANGEL","CABRERA ORTEGA DAVID","CARBONELL BOSSA MAURICIO","CELIN VELASQUEZ MARLIN","ESCALANTE ACENDRA ANA","GAMARRA GONZALEZ GABRIEL","HERNANDEZ ARJONA JOSUE","JIMENEZ DE MOYA SARAY","LEJARDE PERTUZ ASLHEY","LOPEZ GARCIA ANGEL","LOPEZ RAMOS OSIEL","MARTINEZ GARCIA MELANIE","MENDOZA DE LA CRUZ LAURY","MERIDIANO CARDENAS DIEGO","NITROBICH RIAÑO YEISON","ORELLANO PALMA ELIANA","OROZCO GOMEZ JEISYS","ORTEGA GIL ALLISON","OTERO JIMENO SHADYA","OTERO MORALES DILAN","PADILLA BORRERO AYLIM","PALMA BARRAZA XAVI","PALMA SILVERA MARILUNA","RANGEL MARTINEZ GENESIS","REAL BARRIOS JUNIÑO","ROBLES MARIN JASSER","RODRIGUEZ DEL VILLAR JOAN","SALAS MALDONADO ALIANYS","SANJUAN PERTUZ JOSSED","SANTIAGO BARROS SHEILA","SILVERA ORTEGA ALEJANDRO","TORRES DE LA HOZ DUVAN"],
            '10C':["ACOSTA DE LA CRUZ ISACC","ACUÑA RADA SARESTH","BENEDETTI GARCIA GLEINER","BORGE FLOREZ MARIA","CANTILLO NORIEGA KEIVEN","CONSUEGRA GOYENECHE HANYDANIELS","CONSUEGRA JARAMILLO MARIA","CONSUEGRA POLO EDU","CORRO IBAÑEZ DAVID","DE LA HOZ ARTETA ANGELINE","GOMEZ MARTINEZ NADIA","GOMEZ OROZCO ANGIE","GUTIERREZ OJEDA ANTONE","LAFAURIE SILVERA JUAN","LEAL QUINTANILLA JESUS","MARIANO OROZCO NICOLL","MELENDEZ CAMBERO WILIANNIS","MENDOZA ESCALANTE DILAN","NAVAS BOLIVAR JAMER","OROZCO ARAUJO MARIA","ORTEGA GARCIA JULIANA","OSPINO DE LA CRUZ JOSE","OVIEDO MOLINA THAILY","PADILLA CONRADO JAIRO","PALLARES DE LA RANS JUAN","PALMA PEREZ DANNA","PEREZ DE LA CRUZ LIS","RADA TAMAYO JASIR","RANGEL MARTINEZ LIS","RODRIGUEZ BLANCO ZAMIRA","SALGADO VERDEZA MARIA","SARMIENTO ACUÑA DULCE","SARMIENTO PALMA MANUEL","SIERRA DE LA CRUZ LAUREEN","SILVERA SANTIAGO JUAN","SUAREZ SIERRA MARIA"],
            '11A':["ALBA BOLIVAR GABRIELA","ARDILA ORDUZ KAREN","BLANCO SILVERA YUGEIDIS","BOLIVAR SANTIAGO EDWIN","CERA SILVERA BRIANDA","CUETO REDONDO YULIFER","DE LA HOZ LOPEZ ROSA","DE MOYA PALLAREZ ADRIAN","FLOREZ SOLANO JUAN","FRANCO FRANCO VALERY","GONZALEZ DE LA CRUZ YICEL","HERNANDEZ JULIO ISABELA","HERNANDEZ MARRIAGA KARLA","HIGUITA ZAPATA VALENTINA","HOUSSET VALENCIA CRISTOBAL","HOUSSET VALENCIA TALIANA","IBAÑEZ NIETO MAYLAN","JIMENEZ ROA STALYN","LOPEZ MERCADO YULIMAR","MORALES OTERO ANA","ORTEGA BOLIVAR MARIETH","OSPINO NIETO WANDA","PALMA PACHECO JONATHAN","RADA POLO STIVE","REYES VILLALOBOS SHEILYN","ROLONG SIERRA ΑΝΑ","ROMERO RODRIGUEZ LUISA","SANTIAGO CUETO KERLYN","SANTIAGO DE LA ROSA RITA","VASQUEZ CHARRIS YELIS","VELASQUEZ ZAMBRANO DANIEL"],
            '11B':["ALBOR SILVERA ALEJANDRA","AMAYA QUINTERO DUVAN","BAZA ESCOBAR YORELIS","CERVANTES LARA DEREEK","CONSUEGRA DE LA CRUZ SERGIO","CORRO GONZALEZ ANDRES","CORRO HERRERA JULIAN","CUENTAS SIERRA LAUREN","ESCOBAR ALGARIN FELICIDAD","GONZALEZ GIL NATALIA","GONZALEZ HURTADO LAURA","GUZMAN NUÑEZ LAUREN","MARQUEZ MIRANDA JOHAN","MAURY SALGADO ALISSON","MEJIA GONZALEZ ISABELLA","MIRANDA DE MOYA EVANGELLY","MONTERROSA RODRIGUEZ ANDRES","OROZCO VASQUEZ ROSAURA","ORTEGA SIERRA YULIANA","PADILLA REDONDO YESSICA","PEREZ DE LA CRUZ JESUS","PEREZ FRANCO YORIANA","QUINTERO COBA EDIER","REDONDO TORRES YESICA","RODRIGUEZ CARPINTERO CAMILA","ROJO CARDONA MISHELL","SANTIAGO NATERA JOHN","SIERRA FIGUEROA LUCILA","VALLEJO CASTILLO ISABELLA","VARGAS MOLINA SEBASTIAN"],
            '11C':["ALTAMAR CABALLERO PAOLA","ARIZA PEREZ DILAN","ARROYO CORREDOR ANDRES","BARRETO GUTIERREZ SLAYNEΤΗ","BONILLA GUTIERREZ SHARON","CASTIBLANCO IBAÑEZ IAN","DE LA CRUZ ARRIETA ANGEL","DE LA CRUZ CAMARGO SERGIO","DE LA CRUZ SARMIENTO MARIA","DE LA HOZ MUÑOZ LUISA","DE LA HOZ SIERRA JOHAN","DE LOS REYES TAMAYO YOSETH","DELGADO HERNANDEZ SOFIA","ESCALANTE QUIROZ JESUS","ESCOBAR SALCEDO JUSEPH","ESCORCIA JIMENEZ ANDRES","GALLARDO PANCHA GABRIELA","GOEZ SERRANO EMMANUEL","HERNANDEZ CERVANTES PABLO","HERNANDEZ MUÑOZ DANA","HERRERA MENDOZA ESTEBAN","MARQUEZ MIRANDA JAZIR","ORELLANO BOLIVAR KEIDDER","PACHECO SIERRA ADRIANA","PARRA REDONDO JUAN","REDONDO MENDOZA MARIANGEL","RIVERO COBA GLEIDYS","SALAZAR LLANOS YAMITH","SANCHEZ CELIS DIEGO","SANTAMARIA BORJA ANDREA","SIERRA GARCIA OSCAR","VASQUEZ ARZUZA ALAM","VERGARA BARRIOS KLEIVER"],
            '11D':["ARIZA DE LA CRUZ SEBASTIAN","ARIZA SILVERA JORGE MARIO","BLANCO ESCALANTE SAIDER","BOLIVAR VIVANCO NICOL","BORGE GOENAGA SHADIA","CABALLERO BARRIOS BREIDER","CHICO MARTINEZ DAIRON","CONSUEGRA SILVERA SARAY","ESCALANTE GONZALEZ DANIELA","GALLARDO BRADFORD NAYALITH","GARZON GALINDO LENIN","GONZALEZ DE LA RANS SHARLET","GUTIERREZ MENDOZA JOSE","GUTIERREZ VASQUEZ PAULA","MELENDRES VILLALBA KEIMER","MEZA GARCIA CARLOS","MORA SILVERA DEYNER","ORTEGA GONZALEZ LEWIN","PADILLA PARRA MARY","PALMA DE LA HOZ LUIS","PEDRAZA OLIVEROS MATHIAS","PEDROZA GALLARDO SCARLETT","PEREZ VEGA NICOL","RODRIGUEZ SALAS YORYANIZ","SANTIAGO SOLANO AXEL","SERJE GARCIA MISSELL","VARGAS ALBIS YERSON","VARGAS MUÑOZ SHERIT","VELILLA ACOSTA CAMILO"]
        };
        let searchTimeout;
        let statsChart;
        
        const formatStudentName = (str) => !str ? '' : str.trim().toUpperCase();
        
        // --- Utility & Calculation Functions ---
        const getDayForCourse = (course) => { 
            for (const day in dailySchedule) { 
                if (dailySchedule[day].includes(course)) return day; 
            } 
            return null; 
        };
        const getAttendanceDates = (course) => {
            const dayName = getDayForCourse(course);
            if (!dayName) return [];
            const dayNumber = dayNameToNumber[dayName];
            const dates = [], start = new Date('2025-09-22T00:00:00'), end = new Date('2025-11-28T00:00:00');
            let current = new Date(start);
            while (current <= end) {
                if (current.getDay() === dayNumber) dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            return dates;
        };
        const showMessage = (text, type = 'success') => {
            const box = document.createElement('div');
            box.className = 'message-box fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white transition-opacity duration-300 z-50';
            box.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
            box.textContent = text;
            document.body.appendChild(box);
            setTimeout(() => {
                box.style.opacity = '0';
                setTimeout(() => box.remove(), 300);
            }, 3000);
        };
        const getGradeValue = (grades, field) => parseFloat(grades[field]) || 0;
        const calculateAverage = (gradesArray) => { const valid = gradesArray.filter(g => g > 0); return valid.length === 0 ? 0 : valid.reduce((a, b) => a + b, 0) / valid.length; };
        
        const calculateDef = (grades) => {
            const g = grades || {};
            const p = appSettings.percentages;
            const cAvg = calculateAverage([getGradeValue(g,'cognitivoC1'), getGradeValue(g,'cognitivoC2'), getGradeValue(g,'cognitivoC3')]);
            const pAvg = calculateAverage([getGradeValue(g,'procedimentalP1'), getGradeValue(g,'procedimentalP2'), getGradeValue(g,'procedimentalP3')]);
            const aAvg = calculateAverage([getGradeValue(g,'actitudinalA1'), getGradeValue(g,'actitudinalA2'), getGradeValue(g,'actitudinalA3')]);
            const def = ((cAvg * p.cognitive / 100) + (pAvg * p.procedural / 100) + (aAvg * p.attitudinal / 100));
            return isNaN(def) ? "0.00" : def.toFixed(2);
        };
        const determineNivel = (def) => { const s = parseFloat(def); if (s>=1&&s<=2.99)return"Bajo";if (s>=3&&s<=3.99)return"Básico";if (s>=4&&s<=4.59)return"Alto";if(s>=4.6&&s<=5)return"Superior";return""; };
        const calculateAttendanceSummary = (attendance) => {
            const att = attendance || {};
            let a=0,p=0,e=0; 
            for(const d in att) {
                if(att[d]===true) p++;
                else if(att[d]===false) a++;
                else if(att[d]==='excused') e++;
            } 
            return {attended: p, absent: a, excused: e}; 
        };
        
        const debounce = (func, delay) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(func, delay);
        };

        // --- Table Rendering ---
        const renderTable = () => {
            try {
                const config = allStudentsData[activeCourse];
                if (!config) {
                    tableContainer.innerHTML = `<div class="p-4 text-center">No hay estudiantes en este curso. Puede añadirlos en la configuración del curso.</div>`;
                    courseTitle.innerHTML = `Grupo: ${activeCourse} <i id="courseSettingsBtn" class="fas fa-edit text-lg text-gray-400 hover:text-blue-500 cursor-pointer ml-2"></i>`;
                    document.getElementById('courseSettingsBtn').onclick = () => showCourseManagementModal();
                    courseInfo.innerHTML = `<p>Docente: ${appSettings.professor}</p><p>Asignatura: ${appSettings.subject}</p>`;
                    calculateAndDisplayStats();
                    return;
                }

                const data = gradesData[activePeriod]?.[activeCourse] || {};
                const attendanceDates = getAttendanceDates(activeCourse);
                const searchTerm = searchBox.value.toLowerCase();
                const filteredStudents = config.filter(s => s && typeof s === 'string' && s.toLowerCase().includes(searchTerm));

                courseTitle.innerHTML = `Grupo: ${activeCourse} <i id="courseSettingsBtn" class="fas fa-edit text-lg text-gray-400 hover:text-blue-500 cursor-pointer ml-2"></i>`;
                document.getElementById('courseSettingsBtn').onclick = () => showCourseManagementModal();

                courseInfo.innerHTML = `<p>Docente: ${appSettings.professor}</p><p>Asignatura: ${appSettings.subject}</p>`;

                const tableEl = document.createElement('table');
                tableEl.style.minWidth = `${510 + (attendanceDates.length * 60) + 700}px`;

                let tableHTML = `
                    <thead>
                        <tr>
                            <th rowspan="2" class="sticky-left sticky-col-no">No</th>
                            <th rowspan="2" class="sticky-left sticky-col-name">NOMBRE</th>
                            <th rowspan="2" class="sticky-left sticky-col-actions">Acciones</th>
                            <th rowspan="2" class="sticky-left sticky-col-summary">ASIST.</th>
                            <th class="attendance-column" colspan="${attendanceDates.length}">ASISTENCIA POR FECHA</th>
                            <th class="grade-column" colspan="3">COGNITIVO (${appSettings.percentages.cognitive}%)</th>
                            <th class="grade-column" colspan="3">PROCEDIMENTAL (${appSettings.percentages.procedural}%)</th>
                            <th class="grade-column" colspan="3">ACTITUDINAL (${appSettings.percentages.attitudinal}%)</th>
                            <th rowspan="2" class="grade-column col-def">DEF</th>
                            <th rowspan="2" class="grade-column col-nivel">NIVEL</th>
                        </tr>
                        <tr>
                            ${attendanceDates.map(d => {
                                const dateString = d.toISOString().split('T')[0];
                                const note = data.dateNotes?.[dateString] || '';
                                const noteIconClass = note ? 'fas fa-comment-dots text-yellow-300' : 'fas fa-plus-circle text-gray-400';
                                return `<th class="date-header attendance-column">
                                    <div>
                                        ${d.getDate()}/${d.getMonth()+1} 
                                        <i class="${noteIconClass} cursor-pointer hover:text-yellow-500 text-xs ml-1" data-date-note="${dateString}" onclick="showDateNoteModal('${dateString}')"></i>
                                    </div>
                                    <div class="flex flex-col items-center">
                                      <button class="attendance-bulk-btn bg-green-500" onclick="markAllAttendance('${dateString}', true)">✓</button>
                                      <button class="attendance-bulk-btn bg-red-500" onclick="markAllAttendance('${dateString}', false)">✗</button>
                                      <button class="attendance-bulk-btn bg-indigo-500" onclick="markAllAttendance('${dateString}', 'excused')">E</button>
                                    </div>
                                </th>`;
                            }).join('')}
                            ${['C1', 'C2', 'C3', 'P1', 'P2', 'P3', 'A1', 'A2', 'A3'].map(h => {
                                const noteGroup = h.slice(-1);
                                const note = data.columnNotes?.[noteGroup] || '';
                                const hasNote = note.trim() !== '';
                                const icon = `<i class="fas fa-comment cursor-pointer text-xs ml-1 ${hasNote ? 'text-amber-400' : 'text-gray-400'} hover:text-amber-500" data-col-note="${noteGroup}" onclick="showGradeNoteModal('${noteGroup}')"></i>`;
                                return `<th class="grade-column">${h}${icon}</th>`;
                            }).join('')}
                        </tr>
                    </thead>
                    <tbody>`;
                
                filteredStudents.forEach((student, index) => {
                    const studentData = data[student] || { grades: {}, attendance: {}, observations: [] };
                    const hasObs = studentData.observations && studentData.observations.length > 0;
                    const studentDef = calculateDef(studentData.grades);
                    const nivel = determineNivel(studentDef);
                    const summary = calculateAttendanceSummary(studentData.attendance);
                    const formatGrade = (g) => !isNaN(parseFloat(g)) ? parseFloat(g).toFixed(1) : '';

                    tableHTML += `<tr>
                        <td class="sticky-left sticky-col-no">${index + 1}</td>
                        <td class="sticky-left sticky-col-name">${student}</td>
                        <td class="sticky-left sticky-col-actions">
                            <i class="fas fa-comment action-icon ${hasObs ? 'has-obs' : ''}" title="Observaciones" data-student-obs="${student}" onclick="showObservationsModal('${student}')"></i>
                            <i class="fas fa-id-card action-icon" title="Boletín" onclick="showBulletinModal('${student}')"></i>
                            <i class="fas fa-chart-line action-icon" title="Informe de Estudiante" onclick="showStudentReportModal('${student}')"></i>
                            <i class="fas fa-edit action-icon action-grades-btn" title="Editar Notas" onclick="showGradesModal('${student}')"></i>
                        </td>
                        <td class="sticky-left sticky-col-summary"><span>✓: ${summary.attended}</span><br><span>✗: ${summary.absent}</span><br><span>E: ${summary.excused}</span></td>`;
                    
                    attendanceDates.forEach(date => {
                        const dateString = date.toISOString().split('T')[0];
                        const status = studentData.attendance?.[dateString];
                        let a_class = 'attendance-box', a_content = '';
                        if (status === true) { a_class += ' attended'; a_content = '✓'; }
                        else if (status === false) { a_class += ' absent'; a_content = '✗'; }
                        else if (status === 'excused') { a_class += ' excused'; a_content = 'E'; }
                        tableHTML += `<td class="attendance-cell"><div class="${a_class}" data-student="${student}" data-date="${dateString}">${a_content}</div></td>`;
                    });
                    
                    ['cognitivoC1','cognitivoC2','cognitivoC3','procedimentalP1','procedimentalP2','procedimentalP3','actitudinalA1','actitudinalA2','actitudinalA3'].forEach(f => {
                        tableHTML += `<td class="grade-column grade-cell" data-student="${student}" data-field="${f}">${formatGrade(studentData.grades?.[f])}</td>`;
                    });
                    
                    const nivelClass = (nivel && typeof nivel === 'string') ? `nivel-${nivel.toLowerCase()}` : '';
                    tableHTML += `<td class="grade-column col-def ${nivelClass}">${studentDef}</td><td class="grade-column col-nivel ${nivelClass}">${nivel}</td></tr>`;
                });
                tableEl.innerHTML = tableHTML + `</tbody>`;
                tableContainer.innerHTML = '';
                tableContainer.appendChild(tableEl);
                calculateAndDisplayStats();
            } catch(e) {
                console.error(`An error occurred while rendering the table for course "${activeCourse}":`, e);
                tableContainer.innerHTML = `<div class="p-4 text-center text-red-500">Ocurrió un error al mostrar la lista de estudiantes. Por favor, intente limpiar la caché del navegador.</div>`;
            }
        };

        // --- Event Handlers & Data Management ---
        const ensureCourseData = (period, course) => {
            if (!gradesData[period]) gradesData[period] = {};
            if (!gradesData[period][course]) gradesData[period][course] = {};
            const courseData = gradesData[period][course];
            if (!courseData.dateNotes) courseData.dateNotes = {};
            if (!courseData.columnNotes) courseData.columnNotes = {};
        };

        const ensureStudentData = (period, course, student) => {
            ensureCourseData(period, course);
            if (!gradesData[period][course][student]) {
                gradesData[period][course][student] = { grades: {}, attendance: {}, observations: [] };
            } else if (!gradesData[period][course][student].observations) {
                gradesData[period][course][student].observations = [];
            }
        };
        
        const enableEdit = (cell) => {
            if (cell.querySelector('input')) return;
            const { student, field } = cell.dataset;
            ensureStudentData(activePeriod, activeCourse, student);
            const currentVal = gradesData[activePeriod][activeCourse][student].grades?.[field] || '';
            const input = document.createElement('input');
            input.type = 'number';
            input.min = '1';
            input.max = '5';
            input.step = '0.1';
            input.className = 'grade-input';
            input.value = !isNaN(parseFloat(currentVal)) ? parseFloat(currentVal).toFixed(1) : '';
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();

            const saveAndExit = () => {
                const currentInput = cell.querySelector('input');
                if (currentInput) {
                    updateGrade(student, field, currentInput.value, cell);
                }
            }
            
            input.addEventListener('blur', saveAndExit);
            input.addEventListener('keydown', (e) => {
                const navKeys = ['Enter', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Tab'];
                if (!navKeys.includes(e.key)) return;
                e.preventDefault();
                const allGradeCells = Array.from(tableContainer.querySelectorAll('.grade-cell'));
                const currentIndex = allGradeCells.indexOf(cell);
                const inputsPerRow = 9;
                let nextCell = null;
                if (e.key === 'Enter' || e.key === 'ArrowDown') nextCell = allGradeCells[currentIndex + inputsPerRow];
                else if (e.key === 'ArrowUp') nextCell = allGradeCells[currentIndex - inputsPerRow];
                else if (e.key === 'ArrowRight' || e.key === 'Tab') nextCell = allGradeCells[currentIndex + 1];
                else if (e.key === 'ArrowLeft') nextCell = allGradeCells[currentIndex - 1];
                input.blur();
                if (nextCell) setTimeout(() => enableEdit(nextCell), 0);
            });
        };
        
        const updateGrade = (student, field, value, cell) => {
            if(!cell.contains(document.activeElement)) {
                ensureStudentData(activePeriod, activeCourse, student);
                const studentData = gradesData[activePeriod][activeCourse][student];
                if (!studentData.grades) studentData.grades = {};
                let numVal = parseFloat(value);
                
                if (value !== '' && (isNaN(numVal) || numVal < 1 || numVal > 5)) {
                    showMessage('La nota debe estar entre 1 y 5.', 'error');
                    cell.textContent = studentData.grades[field] || '';
                    return;
                }
                studentData.grades[field] = value;
                cell.textContent = value !== '' ? numVal.toFixed(1) : '';
                
                const studentRow = cell.closest('tr');
                if(studentRow) {
                    const newDef = calculateDef(studentData.grades);
                    const newNivel = determineNivel(newDef);
                    const nivelClass = newNivel ? `nivel-${newNivel.toLowerCase()}` : '';
                    const defCell = studentRow.querySelector('.col-def');
                    const nivelCell = studentRow.querySelector('.col-nivel');
                    defCell.textContent = newDef;
                    nivelCell.textContent = newNivel;
                    defCell.className = `col-def ${nivelClass}`;
                    nivelCell.className = `col-nivel ${nivelClass}`;
                }
                saveAllData(true);
                calculateAndDisplayStats();
            }
        };

        const updateAttendance = (box) => {
            const { student, date } = box.dataset;
            ensureStudentData(activePeriod, activeCourse, student);
            const studentData = gradesData[activePeriod][activeCourse][student];
            if (!studentData.attendance) studentData.attendance = {};
            const currentStatus = studentData.attendance[date];

            const statusCycle = [true, false, 'excused', undefined]; // Attended, Absent, Excused, Not Marked
            const currentIndex = statusCycle.indexOf(currentStatus);
            const newStatus = statusCycle[(currentIndex + 1) % statusCycle.length];

            if (newStatus === undefined) delete studentData.attendance[date];
            else studentData.attendance[date] = newStatus;

            box.className = 'attendance-box'; box.textContent = '';
            if (newStatus === true) { box.classList.add('attended'); box.textContent = '✓'; }
            else if (newStatus === false) { box.classList.add('absent'); box.textContent = '✗'; }
            else if (newStatus === 'excused') { box.classList.add('excused'); box.textContent = 'E'; }

            const summary = calculateAttendanceSummary(studentData.attendance);
            const summaryCell = box.closest('tr').querySelector('.sticky-col-summary');
            if (summaryCell) summaryCell.innerHTML = `<span>✓: ${summary.attended}</span><br><span>✗: ${summary.absent}</span><br><span>E: ${summary.excused}</span>`;
            saveAllData(true);
            calculateAndDisplayStats();
        };

        function markAllAttendance(dateString, status) {
            const config = allStudentsData[activeCourse];
            if (!config) return;
            const students = config;
            const data = gradesData[activePeriod]?.[activeCourse] || {};
            const allCurrentlyMarked = students.every(student => (data[student]?.attendance?.[dateString] === status));
            const newStatus = allCurrentlyMarked ? undefined : status;
            students.forEach(student => {
                ensureStudentData(activePeriod, activeCourse, student);
                if (!gradesData[activePeriod][activeCourse][student].attendance) gradesData[activePeriod][activeCourse][student].attendance = {};
                if (newStatus === undefined) delete gradesData[activePeriod][activeCourse][student].attendance[dateString];
                else gradesData[activePeriod][activeCourse][student].attendance[dateString] = newStatus;
            });
            saveAllData();
        }

        const saveAllData = (isPartial = false) => { 
            try { 
                localStorage.setItem('gradesData_v2', JSON.stringify(gradesData)); 
                localStorage.setItem('allStudentsData_v2', JSON.stringify(allStudentsData)); 
                localStorage.setItem('dailySchedule_v2', JSON.stringify(dailySchedule)); 
                if(!isPartial) { renderTable(); }
                else { showMessage("Guardado", "success"); }
            } catch (e) { console.error("Error saving data: ", e); } 
        };
        
        const loadAllData = () => {
            const savedGrades = localStorage.getItem('gradesData_v2');
            const savedStudents = localStorage.getItem('allStudentsData_v2');
            const savedSchedule = localStorage.getItem('dailySchedule_v2');
            
            gradesData = savedGrades ? JSON.parse(savedGrades) : {};
            allStudentsData = savedStudents ? JSON.parse(savedStudents) : allStudentsData;
            dailySchedule = savedSchedule ? JSON.parse(savedSchedule) : dailySchedule;

            // Migration from old structure if necessary
            if (localStorage.getItem('gradesDataGroups') && Object.keys(gradesData).length === 0) {
                const oldData = JSON.parse(localStorage.getItem('gradesDataGroups'));
                gradesData['Periodo 1'] = oldData;
                localStorage.removeItem('gradesDataGroups');
                saveAllData();
            }
        };
        
        const saveSettings = () => {
            localStorage.setItem('appSettings_v2', JSON.stringify(appSettings));
            showMessage("Configuración guardada", "success");
        };

        const loadSettings = () => {
            const savedSettings = localStorage.getItem('appSettings_v2');
            const defaultSettings = {
                professor: "Puertas Lopez Patricia Isabel",
                subject: "Artística Plástica y Visual",
                percentages: { cognitive: 40, procedural: 30, attitudinal: 30 },
                periods: ["Periodo 1"],
                activePeriod: "Periodo 1"
            };
            appSettings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;
            activePeriod = appSettings.activePeriod;
        };
        
        function applyTheme(isDark) {
            if (isDark) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
            darkModeToggle.checked = isDark;
        }
       
        function showObservationsModal(student) {
            ensureStudentData(activePeriod, activeCourse, student);
            document.getElementById('obsStudentName').textContent = student;
            document.getElementById('obsTextarea').value = '';
            
            const historyContainer = document.getElementById('obsHistory');
            historyContainer.innerHTML = '';

            const observations = gradesData[activePeriod][activeCourse][student].observations || [];

            if (observations.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-500">No hay observaciones registradas.</p>';
            } else {
                observations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                observations.forEach(obs => {
                    const obsDate = new Date(obs.timestamp);
                    const formattedDate = obsDate.toLocaleString('es-CO', { dateStyle: 'short', timeStyle: 'short' });
                    const obsElement = document.createElement('div');
                    obsElement.className = 'p-2 border-b';
                    obsElement.style.borderColor = 'var(--border-color)';
                    obsElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <p class="whitespace-normal flex-grow">${obs.text.replace(/\n/g, '<br>')}</p>
                            <i class="fas fa-trash-alt text-red-500 hover:text-red-700 cursor-pointer ml-4 flex-shrink-0" onclick="requestDeleteObservation('${student}', '${obs.timestamp}')"></i>
                        </div>
                        <p class="text-xs text-gray-500 text-right mt-1">${formattedDate}</p>
                    `;
                    historyContainer.appendChild(obsElement);
                });
            }

            obsModal.classList.add('active');
            obsModal.dataset.student = student;
        }

        function requestDeleteObservation(student, timestamp) {
            const deleteErrorMsg = document.getElementById('deleteErrorMsg');
            const deletePasswordInput = document.getElementById('deletePasswordInput');
            
            deletePasswordInput.value = '';
            deleteErrorMsg.classList.add('hidden');
            
            deleteConfirmModal.dataset.student = student;
            deleteConfirmModal.dataset.timestamp = timestamp;
            deleteConfirmModal.classList.add('active');
            setTimeout(() => deletePasswordInput.focus(), 100);
        }

        function deleteObservation(student, timestamp) {
            ensureStudentData(activePeriod, activeCourse, student);
            const studentData = gradesData[activePeriod][activeCourse][student];
            
            if (studentData && studentData.observations) {
                studentData.observations = studentData.observations.filter(obs => obs.timestamp !== timestamp);
                saveAllData();
                showObservationsModal(student); // Refresh the modal to show the change
                showMessage("Observación borrada con éxito.", "success");
            }
        }
        
        function showDateNoteModal(dateString) {
            ensureCourseData(activePeriod, activeCourse);
            const date = new Date(dateString + 'T00:00:00');
            document.getElementById('dateNoteDate').textContent = date.toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('dateNoteTextarea').value = gradesData[activePeriod][activeCourse].dateNotes?.[dateString] || '';
            dateNoteModal.dataset.date = dateString;
            dateNoteModal.classList.add('active');
        }
        
        function showGradeNoteModal(noteGroup) {
            ensureCourseData(activePeriod, activeCourse);
            const titlePart = noteGroup === '1' ? 'Notas #1 (C1, P1, A1)' : noteGroup === '2' ? 'Notas #2 (C2, P2, A2)' : 'Notas #3 (C3, P3, A3)';
            document.getElementById('gradeNoteTitle').textContent = titlePart;
            document.getElementById('gradeNoteTextarea').value = gradesData[activePeriod][activeCourse].columnNotes?.[noteGroup] || '';
            gradeNoteModal.classList.add('active');
            gradeNoteModal.dataset.noteGroup = noteGroup;
        }

        function showGradesModal(student) {
            ensureStudentData(activePeriod, activeCourse, student);
            const studentData = gradesData[activePeriod][activeCourse][student];
            gradesStudentName.textContent = student;
            gradesGrid.innerHTML = '';
            const fields = ['cognitivoC1','cognitivoC2','cognitivoC3','procedimentalP1','procedimentalP2','procedimentalP3','actitudinalA1','actitudinalA2','actitudinalA3'];
            fields.forEach(field => {
                const value = studentData.grades?.[field] || '';
                const label = field.replace('cognitivo', 'C').replace('procedimental', 'P').replace('actitudinal', 'A').toUpperCase();
                gradesGrid.innerHTML += `<div class="col-span-1 flex items-center"><label class="font-semibold">${label}:</label></div><div class="col-span-2"><input type="number" min="1" max="5" step="0.1" data-field="${field}" value="${value}" class="grade-input"></div>`;
            });
            gradesModal.dataset.student = student;
            gradesModal.classList.add('active');
        }

        function showBulletinModal(student) {
            ensureStudentData(activePeriod, activeCourse, student);
            const studentData = gradesData[activePeriod][activeCourse][student];
            const def = calculateDef(studentData.grades);
            const nivel = determineNivel(def);
            const attendance = calculateAttendanceSummary(studentData.attendance);
            const timestamp = new Date().toLocaleString('es-CO', { dateStyle: 'long', timeStyle: 'short' });

            let obsHTML = 'Sin observaciones.';
            const observations = studentData.observations || [];
            if (observations.length > 0) {
                observations.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                obsHTML = observations.map(obs => {
                    const obsDate = new Date(obs.timestamp);
                    const formattedDate = obsDate.toLocaleString('es-CO', { dateStyle: 'short', timeStyle: 'short' });
                    return `<div class="mb-2"><p class="whitespace-normal">${obs.text.replace(/\n/g, '<br>')}</p><p class="text-xs text-gray-500 text-right mt-1">${formattedDate}</p></div>`;
                }).join('<hr class="my-1">');
            }

            document.getElementById('bulletinContent').innerHTML = `<div class="bulletin-page p-4 bg-white" style="color: black !important;"><h3 class="text-2xl font-bold text-center mb-4">Boletín Informativo - ${activePeriod}</h3><p><strong>Estudiante:</strong> <span id="bulletinStudentName">${student}</span></p><p><strong>Curso:</strong> ${activeCourse}</p><hr class="my-4"><h4 class="text-lg font-bold mt-4">Calificaciones</h4><div id="bulletinGrades" class="grid grid-cols-2 gap-2 mt-2"><p><strong>Cognitivo C1:</strong> ${studentData.grades?.cognitivoC1||'N/A'}</p><p><strong>Cognitivo C2:</strong> ${studentData.grades?.cognitivoC2||'N/A'}</p><p><strong>Cognitivo C3:</strong> ${studentData.grades?.cognitivoC3||'N/A'}</p><p><strong>Procedimental P1:</strong> ${studentData.grades?.procedimentalP1||'N/A'}</p><p><strong>Procedimental P2:</strong> ${studentData.grades?.procedimentalP2||'N/A'}</p><p><strong>Procedimental P3:</strong> ${studentData.grades?.procedimentalP3||'N/A'}</p><p><strong>Actitudinal A1:</strong> ${studentData.grades?.actitudinalA1||'N/A'}</p><p><strong>Actitudinal A2:</strong> ${studentData.grades?.actitudinalA2||'N/A'}</p><p><strong>Actitudinal A3:</strong> ${studentData.grades?.actitudinalA3||'N/A'}</p><p class="mt-2 font-bold"><strong>DEF: ${def} (${nivel})</strong></p></div><h4 class="text-lg font-bold mt-4">Asistencia</h4><div id="bulletinAttendance" class="mt-2"><p><strong>Asistencias:</strong> ${attendance.attended}</p><p><strong>Ausencias:</strong> ${attendance.absent}</p><p><strong>Excusas:</strong> ${attendance.excused}</p></div><h4 class="text-lg font-bold mt-4">Observaciones</h4><div id="bulletinObs" class="mt-2">${obsHTML}</div><div class="text-xs text-gray-500 text-center mt-6" style="color: #555 !important;">Generado el: ${timestamp}</div></div>`;
            bulletinModal.classList.add('active');
        }
        
        function exportData(scope, selectedCourses = []) {
            let csvContent = "data:text/csv;charset=utf-8,";
            const coursesToExport = scope === 'all' ? Object.keys(allStudentsData).sort() : scope === 'selected' ? selectedCourses : [activeCourse];
            coursesToExport.forEach(course => {
                 const data = gradesData[activePeriod]?.[course] || {};
                 if (scope !== 'current') csvContent += `"${course}" (${activePeriod})\r\n`;
                 const attendanceDates = getAttendanceDates(course).map(d => d.toLocaleDateString('es-CO'));
                 const headers = ["No", "Estudiante", ...attendanceDates, "Obs.", "C1", "C2", "C3", "P1", "P2", "P3", "A1", "A2", "A3", "DEF", "NIVEL"];
                 csvContent += headers.join(",") + "\r\n";
                 allStudentsData[course].forEach((student, index) => {
                     const studentData = data[student] || {};
                     const obsText = (studentData.observations || [])
                        .map(obs => {
                            const d = new Date(obs.timestamp).toLocaleString('es-CO');
                            return `[${d}]: ${obs.text}`;
                        })
                        .join('; ');

                     const def = calculateDef(studentData.grades);
                     const nivel = determineNivel(def);
                     let row = [index + 1, `"${student}"`, ...getAttendanceDates(course).map(d => { const s=studentData.attendance?.[d.toISOString().split('T')[0]]; return s===true?"P":s===false?"A":s==='excused'?'E':""; }), `"${obsText.replace(/"/g, '""')}"`, studentData.grades?.cognitivoC1||"", studentData.grades?.cognitivoC2||"", studentData.grades?.cognitivoC3||"", studentData.grades?.procedimentalP1||"", studentData.grades?.procedimentalP2||"", studentData.grades?.procedimentalP3||"", studentData.grades?.actitudinalA1||"", studentData.grades?.actitudinalA2||"", studentData.grades?.actitudinalA3||"", def, nivel];
                     csvContent += row.join(",") + "\r\n";
                 });
                 if (scope !== 'current') csvContent += "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `calificaciones_${scope}_${activePeriod}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            exportModal.classList.remove('active');
        }

        async function downloadBulletinAsFile(format) {
            const studentName = document.getElementById('bulletinStudentName').textContent;
            const bulletinContent = document.getElementById('bulletinContent').querySelector('.bulletin-page');
            const canvas = await html2canvas(bulletinContent, { scale: 2, backgroundColor: 'white' });
            const imgData = canvas.toDataURL('image/png');
            const fileName = `boletin_${studentName.replace(/ /g, '_')}.${format}`;
            if (format === 'png') {
                const link = document.createElement('a');
                link.download = fileName;
                link.href = imgData;
                link.click();
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, pdfHeight - 20);
                pdf.save(fileName);
            }
        }

        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const newStudents = e.target.result.split('\n').map(name => formatStudentName(name)).filter(Boolean);
                if (newStudents.length > 0) {
                    allStudentsData[activeCourse] = newStudents;
                    allStudentsData[activeCourse].sort((a, b) => a.localeCompare(b));
                    if(gradesData[activePeriod]) {
                       gradesData[activePeriod][activeCourse] = {};
                    }
                    saveAllData();
                }
            };
            reader.readAsText(file);
            importFile.value = '';
        });

        function calculateAndDisplayStats() {
            const data = gradesData[activePeriod]?.[activeCourse] || {};
            const students = allStudentsData[activeCourse] || [];

            const statsContainer = document.getElementById('statsPanel');
            statsContainer.innerHTML = ''; // Clear previous stats

            if (students.length === 0) return;
            
            let totalDef = 0, studentCountWithGrades = 0;
            const nivelCounts = { "Bajo": 0, "Básico": 0, "Alto": 0, "Superior": 0, "N/A": 0 };
            let totalAttended = 0, totalPossibleSessions = 0;

            const attendanceDatesCount = getAttendanceDates(activeCourse).length;
            totalPossibleSessions = students.length * attendanceDatesCount;

            students.forEach(student => {
                const studentData = data[student] || {};
                const def = parseFloat(calculateDef(studentData.grades));
                if (!isNaN(def) && def > 0) {
                    totalDef += def;
                    studentCountWithGrades++;
                }
                const nivel = determineNivel(def) || "N/A";
                nivelCounts[nivel]++;
                totalAttended += calculateAttendanceSummary(studentData.attendance).attended;
            });
            
            const avgDef = studentCountWithGrades > 0 ? (totalDef / studentCountWithGrades).toFixed(2) : "0.00";
            const attendancePercent = totalPossibleSessions > 0 ? ((totalAttended / totalPossibleSessions) * 100).toFixed(1) : 0;
            
            statsContainer.innerHTML = `
                <div class="stat-item"><p class="font-bold text-lg">${avgDef}</p><p class="text-sm">Promedio Gral.</p></div>
                <div class="stat-item"><p class="font-bold text-lg">${attendancePercent}%</p><p class="text-sm">Asistencia</p></div>
                <div id="statsChartContainer" class="stat-item" style="grid-column: 1 / -1; min-height: 120px;">
                    <canvas id="nivelChart"></canvas>
                </div>
            `;
            
            const ctx = document.getElementById('nivelChart').getContext('2d');
            if(statsChart) statsChart.destroy();
            statsChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Superior', 'Alto', 'Básico', 'Bajo', 'N/A'],
                    datasets: [{
                        label: 'Niveles de Desempeño',
                        data: [nivelCounts.Superior, nivelCounts.Alto, nivelCounts.Básico, nivelCounts.Bajo, nivelCounts['N/A']],
                        backgroundColor: ['#dbeafe', '#dcfce7', '#fef9c3', '#fee2e2', '#e5e7eb'],
                        borderColor: ['#1e40af', '#166534', '#854d0e', '#991b1b', '#6b7280'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 20 } }
                    }
                }
            });
        }
        
        async function generateAndExportPdf(courses, studentList = null) {
            showMessage('Generando PDF, por favor espera...', 'success');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const studentsToPrint = [];
            if(studentList) { 
                studentsToPrint.push({ courseName: activeCourse, students: studentList });
            } else { 
                courses.forEach(courseName => studentsToPrint.push({ courseName: courseName, students: allStudentsData[courseName] || [] }));
            }
            const timestamp = new Date().toLocaleString('es-CO', { dateStyle: 'long', timeStyle: 'short' });
            let firstPage = true;
            for (const { courseName, students } of studentsToPrint) {
                for (const studentName of students) {
                    if (!firstPage) pdf.addPage();
                    const studentData = gradesData[activePeriod]?.[courseName]?.[studentName] || {};
                    const def = calculateDef(studentData.grades);
                    const nivel = determineNivel(def);
                    const attendance = calculateAttendanceSummary(studentData.attendance);
                    const bulletinHTML = `<div class="bulletin-page p-4 bg-white" style="width:210mm;color:black!important"><h3 class="text-2xl font-bold text-center mb-4">Boletín Informativo</h3><p><strong>Estudiante:</strong> ${studentName}</p><p><strong>Curso:</strong> ${courseName}</p><hr class="my-4"><h4 class="text-lg font-bold mt-4">Calificaciones</h4><div class="grid grid-cols-2 gap-2 mt-2"><p><strong>Cognitivo C1:</strong> ${studentData.grades?.cognitivoC1||'N/A'}</p><p><strong>Cognitivo C2:</strong> ${studentData.grades?.cognitivoC2||'N/A'}</p><p><strong>Cognitivo C3:</strong> ${studentData.grades?.cognitivoC3||'N/A'}</p><p><strong>Procedimental P1:</strong> ${studentData.grades?.procedimentalP1||'N/A'}</p><p><strong>Procedimental P2:</strong> ${studentData.grades?.procedimentalP2||'N/A'}</p><p><strong>Procedimental P3:</strong> ${studentData.grades?.procedimentalP3||'N/A'}</p><p><strong>Actitudinal A1:</strong> ${studentData.grades?.actitudinalA1||'N/A'}</p><p><strong>Actitudinal A2:</strong> ${studentData.grades?.actitudinalA2||'N/A'}</p><p><strong>Actitudinal A3:</strong> ${studentData.grades?.actitudinalA3||'N/A'}</p><p class="mt-2 font-bold"><strong>DEF: ${def} (${nivel})</strong></p></div><h4 class="text-lg font-bold mt-4">Asistencia</h4><div class="mt-2"><p><strong>Asistencias:</strong> ${attendance.attended}</p><p><strong>Ausencias:</strong> ${attendance.absent}</p><p><strong>Excusas:</strong> ${attendance.excused}</p></div><h4 class="text-lg font-bold mt-4">Observaciones</h4><p class="mt-2">${(studentData.observations || []).map(o => `[${new Date(o.timestamp).toLocaleString()}] ${o.text}`).join('<br>')||'Sin observaciones.'}</p><div class="text-xs text-gray-500 text-center mt-6" style="color:#555!important">Generado el: ${timestamp}</div></div>`;
                    const tempDiv = document.createElement('div');
                    tempDiv.style.position='absolute'; tempDiv.style.left='-9999px';
                    tempDiv.innerHTML = bulletinHTML;
                    document.body.appendChild(tempDiv);
                    const canvas = await html2canvas(tempDiv.firstChild, { scale: 2, backgroundColor: 'white' });
                    const imgData = canvas.toDataURL('image/png');
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, (imgProps.height * (pdfWidth-20)) / imgProps.width);
                    document.body.removeChild(tempDiv);
                    firstPage = false;
                }
            }
            let fileName = studentList ? `boletines_${activeCourse}_seleccionados.pdf` : courses.length === 1 ? `boletines_${courses[0]}.pdf` : courses.length === Object.keys(allStudentsData).length ? `boletines_todos_los_cursos.pdf` : `boletines_cursos_seleccionados.pdf`;
            pdf.save(fileName);
            bulletinSelectionModal.classList.remove('active');
        }

        // --- App Initialization & Event Listeners ---
        const customTooltip = document.getElementById('customTooltip');
        document.body.addEventListener('mouseover', (event) => {
            const target = event.target;
            let tooltipText = '';

            if (target.matches('[data-student-obs]')) {
                const student = target.dataset.studentObs;
                const studentData = gradesData[activePeriod]?.[activeCourse]?.[student];
                const observations = studentData?.observations || [];
                if (observations.length > 0) {
                    observations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    const latestObs = observations[0];
                    const obsDate = new Date(latestObs.timestamp);
                    const formattedDate = obsDate.toLocaleString('es-CO', { dateStyle: 'short', timeStyle: 'short' });
                    tooltipText = `<strong>Última Obs. (${formattedDate}):</strong><br>${latestObs.text.replace(/\n/g, '<br>')}`;
                } else {
                    tooltipText = 'Añadir observación';
                }
            } else if (target.matches('[data-col-note]')) {
                const noteGroup = target.dataset.colNote;
                tooltipText = gradesData[activePeriod]?.[activeCourse]?.columnNotes?.[noteGroup] || 'Añadir comentario de actividad';
            } else if (target.matches('[data-date-note]')) {
                const dateString = target.dataset.dateNote;
                tooltipText = gradesData[activePeriod]?.[activeCourse]?.dateNotes?.[dateString] || 'Añadir nota para esta fecha';
            }

            if (tooltipText.trim()) {
                customTooltip.innerHTML = tooltipText.replace(/\n/g, '<br>');
                customTooltip.classList.remove('hidden');
            } else {
                customTooltip.classList.add('hidden');
            }
        });
        document.body.addEventListener('mouseout', (event) => {
            if (event.target.matches('[data-student-obs], [data-col-note], [data-date-note]')) {
                customTooltip.classList.add('hidden');
            }
        });
        document.body.addEventListener('mousemove', (event) => {
            if (!customTooltip.classList.contains('hidden')) {
                let x = event.pageX + 15;
                let y = event.pageY + 15;
                if (x + customTooltip.offsetWidth > window.innerWidth) {
                    x = event.pageX - customTooltip.offsetWidth - 15;
                }
                if (y + customTooltip.offsetHeight > window.innerHeight) {
                    y = event.pageY - customTooltip.offsetHeight - 15;
                }
                customTooltip.style.left = `${x}px`;
                customTooltip.style.top = `${y}px`;
            }
        });

        searchBox.addEventListener('input', () => debounce(renderTable, 300));

        tableContainer.addEventListener('click', (event) => {
            const gradeCell = event.target.closest('.grade-cell');
            const attendanceBox = event.target.closest('.attendance-box');
            const clickedRow = event.target.closest('tr');
            if (clickedRow?.parentElement.tagName === 'TBODY') {
                tableContainer.querySelector('tr.row-selected')?.classList.remove('row-selected');
                clickedRow.classList.add('row-selected');
            }
            if (gradeCell) enableEdit(gradeCell);
            if (attendanceBox) updateAttendance(attendanceBox);
        });

        const generateTabs = () => {
            tabNavigation.innerHTML = '';
            for (const day in dailySchedule) {
                const dayBlock = document.createElement('div');
                dayBlock.className = 'daily-group-block';
                dayBlock.innerHTML = `<div class="daily-group-title">${day}</div><div class="group-buttons-wrapper"></div>`;
                const wrapper = dayBlock.querySelector('.group-buttons-wrapper');
                dailySchedule[day].forEach(group => {
                    const button = document.createElement('button');
                    button.id = `tab-${group}`;
                    button.className = 'tab-button';
                    button.textContent = group;
                    button.onclick = () => switchCourse(group);
                    wrapper.appendChild(button);
                });
                tabNavigation.appendChild(dayBlock);
            }
        };

        const switchCourse = (course) => {
            activeCourse = course;
            ensureCourseData(activePeriod, activeCourse);
            document.querySelectorAll('.tab-button.active').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${activeCourse}`)?.classList.add('active');
            renderTable();
        };
        
        darkModeToggle.addEventListener('change', () => {
            localStorage.setItem('darkMode', darkModeToggle.checked);
            applyTheme(darkModeToggle.checked);
        });
        
        exportBtn.addEventListener('click', () => {
            const courseSelectionCheckboxes = document.getElementById('courseSelectionCheckboxes');
            courseSelectionCheckboxes.innerHTML = '';
            Object.keys(allStudentsData).sort().forEach(course => {
                courseSelectionCheckboxes.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" value="${course}" class="form-checkbox h-5 w-5 rounded"><span>${course}</span></label>`;
            });
            exportModal.classList.add('active');
        });
        document.getElementById('exportCurrentBtn').addEventListener('click', () => exportData('current'));
        document.getElementById('exportAllBtn').addEventListener('click', () => exportData('all'));
        document.getElementById('exportSelectedBtn').addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('#courseSelectionCheckboxes input:checked')).map(cb => cb.value);
            if (selected.length > 0) exportData('selected', selected);
            else showMessage('Por favor, selecciona al menos un curso.', 'error');
        });

        bulletinBtn.addEventListener('click', () => {
            const studentCheckboxes = document.getElementById('studentSelectionCheckboxes');
            studentCheckboxes.innerHTML = '';
            (allStudentsData[activeCourse] || []).forEach(student => {
                studentCheckboxes.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" value="${student}" class="form-checkbox h-5 w-5 rounded"><span>${student}</span></label>`;
            });
            const courseCheckboxes = document.getElementById('bulletinCourseSelectionCheckboxes');
            courseCheckboxes.innerHTML = '';
            Object.keys(allStudentsData).sort().forEach(course => {
                courseCheckboxes.innerHTML += `<label class="flex items-center gap-2"><input type="checkbox" value="${course}" class="form-checkbox h-5 w-5 rounded"><span>${course}</span></label>`;
            });
            bulletinSelectionModal.classList.add('active');
        });

        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });
        });
        document.getElementById('closeObsModal').addEventListener('click', () => obsModal.classList.remove('active'));
        document.getElementById('closeDateNoteModal').addEventListener('click', () => dateNoteModal.classList.remove('active'));
        document.getElementById('closeGradeNoteModal').addEventListener('click', () => gradeNoteModal.classList.remove('active'));
        document.getElementById('closeDeleteConfirmModal').addEventListener('click', () => deleteConfirmModal.classList.remove('active'));
        document.getElementById('closeGenericConfirmModal').addEventListener('click', () => genericConfirmModal.classList.remove('active'));
        document.getElementById('closeSettingsModal').addEventListener('click', () => settingsModal.classList.remove('active'));
        document.getElementById('closeCourseManagementModal').addEventListener('click', () => courseManagementModal.classList.remove('active'));
        document.getElementById('closeStudentReportModal').addEventListener('click', () => studentReportModal.classList.remove('active'));
        document.getElementById('closeBulletinModal').addEventListener('click', () => bulletinModal.classList.remove('active'));
        document.getElementById('closeExportModal').addEventListener('click', () => exportModal.classList.remove('active'));
        document.getElementById('closeGradesModal').addEventListener('click', () => gradesModal.classList.remove('active'));
        document.getElementById('closeBulletinSelectionModal').addEventListener('click', () => bulletinSelectionModal.classList.remove('active'));
        
        document.getElementById('saveObs').addEventListener('click', () => {
            const student = obsModal.dataset.student;
            const newText = document.getElementById('obsTextarea').value.trim();

            if (newText) {
                ensureStudentData(activePeriod, activeCourse, student);
                const newObs = {
                    text: newText,
                    timestamp: new Date().toISOString()
                };
                gradesData[activePeriod][activeCourse][student].observations.push(newObs);
                saveAllData();
                showObservationsModal(student); 
            }
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            const passwordInput = document.getElementById('deletePasswordInput');
            const deleteErrorMsg = document.getElementById('deleteErrorMsg');
            const { student, timestamp } = deleteConfirmModal.dataset;

            if (passwordInput.value === '55232122') {
                deleteObservation(student, timestamp);
                deleteConfirmModal.classList.remove('active');
            } else {
                deleteErrorMsg.classList.remove('hidden');
                passwordInput.focus();
            }
        });

        document.getElementById('deletePasswordInput').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                document.getElementById('confirmDeleteBtn').click();
            }
        });

        document.getElementById('saveDateNote').addEventListener('click', () => {
            const noteText = document.getElementById('dateNoteTextarea').value.trim();
            ensureCourseData(activePeriod, activeCourse);
            if (noteText) gradesData[activePeriod][activeCourse].dateNotes[dateNoteModal.dataset.date] = noteText;
            else delete gradesData[activePeriod][activeCourse].dateNotes[dateNoteModal.dataset.date];
            saveAllData();
            dateNoteModal.classList.remove('active');
        });
        document.getElementById('saveGradeNote').addEventListener('click', () => {
            const { noteGroup } = gradeNoteModal.dataset;
            const noteText = document.getElementById('gradeNoteTextarea').value;
            ensureCourseData(activePeriod, activeCourse);
            gradesData[activePeriod][activeCourse].columnNotes[noteGroup] = noteText;
            saveAllData();
            gradeNoteModal.classList.remove('active');
        });
        document.getElementById('saveGrades').addEventListener('click', () => {
            const student = gradesModal.dataset.student;
            ensureStudentData(activePeriod, activeCourse, student);
            gradesGrid.querySelectorAll('input').forEach(input => {
                const { field } = input.dataset;
                const { value } = input;
                let numVal = parseFloat(value);
                 if (value !== '' && (isNaN(numVal) || numVal < 1 || numVal > 5)) {} 
                 else {
                    if (!gradesData[activePeriod][activeCourse][student].grades) gradesData[activePeriod][activeCourse][student].grades = {};
                    gradesData[activePeriod][activeCourse][student].grades[field] = value;
                 }
            });
            saveAllData();
            gradesModal.classList.remove('active');
            showMessage('Notas guardadas con éxito.', 'success');
        });
        
        document.getElementById('generateAllCoursesBulletinBtn').addEventListener('click', () => generateAndExportPdf(Object.keys(allStudentsData)));
        document.getElementById('generateCurrentCourseBulletinBtn').addEventListener('click', () => generateAndExportPdf([activeCourse]));
        document.getElementById('generateSelectedCoursesBtn').addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('#bulletinCourseSelectionCheckboxes input:checked')).map(cb => cb.value);
            if (selected.length > 0) generateAndExportPdf(selected);
            else showMessage('Por favor, selecciona al menos un curso.', 'error');
        });
        document.getElementById('generateSelectedStudentsBtn').addEventListener('click', () => {
            const selected = Array.from(document.querySelectorAll('#studentSelectionCheckboxes input:checked')).map(cb => cb.value);
            if (selected.length > 0) generateAndExportPdf(null, selected);
            else showMessage('Por favor, selecciona al menos un estudiante.', 'error');
        });
        document.getElementById('selectAllStudentsBtn').addEventListener('click', () => document.querySelectorAll('#studentSelectionCheckboxes input').forEach(cb => cb.checked = true));
        document.getElementById('deselectAllStudentsBtn').addEventListener('click', () => document.querySelectorAll('#studentSelectionCheckboxes input').forEach(cb => cb.checked = false));
        document.getElementById('downloadPngBtn').addEventListener('click', () => downloadBulletinAsFile('png'));
        document.getElementById('downloadPdfBtn').addEventListener('click', () => downloadBulletinAsFile('pdf'));
        settingsBtn.addEventListener('click', () => {
            document.getElementById('professorNameInput').value = appSettings.professor;
            document.getElementById('subjectNameInput').value = appSettings.subject;
            document.getElementById('cognitivePercentage').value = appSettings.percentages.cognitive;
            document.getElementById('proceduralPercentage').value = appSettings.percentages.procedural;
            document.getElementById('attitudinalPercentage').value = appSettings.percentages.attitudinal;
            renderPeriodsList();
            settingsModal.classList.add('active');
        });

        function setupPeriodSelector() {
            periodSelector.innerHTML = '';
            appSettings.periods.forEach(period => {
                const option = document.createElement('option');
                option.value = period;
                option.textContent = period;
                if (period === activePeriod) {
                    option.selected = true;
                }
                periodSelector.appendChild(option);
            });
        }

        periodSelector.addEventListener('change', (e) => {
            activePeriod = e.target.value;
            appSettings.activePeriod = activePeriod;
            saveSettings();
            renderTable();
        });

        function renderPeriodsList() {
            const periodsList = document.getElementById('periodsList');
            periodsList.innerHTML = '';
            appSettings.periods.forEach(period => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between';
                div.innerHTML = `
                    <input type="text" value="${period}" class="search-box w-full" onchange="updatePeriodName('${period}', this.value)">
                    <button class="text-red-500 hover:text-red-700 text-xl ml-2 ${appSettings.periods.length <= 1 ? 'hidden' : ''}" onclick="deletePeriod('${period}')">&times;</button>
                `;
                periodsList.appendChild(div);
            });
        }
        
        document.getElementById('addPeriodBtn').addEventListener('click', () => {
            const newPeriodNameInput = document.getElementById('newPeriodName');
            const newPeriodName = newPeriodNameInput.value.trim();
            if (newPeriodName && !appSettings.periods.includes(newPeriodName)) {
                appSettings.periods.push(newPeriodName);
                newPeriodNameInput.value = '';
                renderPeriodsList();
            }
        });

        function updatePeriodName(oldName, newName) {
            const trimmedNewName = newName.trim();
            if (!trimmedNewName || oldName === trimmedNewName) {
                renderPeriodsList();
                return;
            }
            if (appSettings.periods.includes(trimmedNewName)) {
                showMessage(`El periodo "${trimmedNewName}" ya existe.`, 'error');
                renderPeriodsList();
                return;
            }

            const periodIndex = appSettings.periods.indexOf(oldName);
            if (periodIndex > -1) {
                appSettings.periods[periodIndex] = trimmedNewName;
            }

            if (gradesData[oldName]) {
                gradesData[trimmedNewName] = gradesData[oldName];
                delete gradesData[oldName];
            }

            if (activePeriod === oldName) {
                activePeriod = trimmedNewName;
                appSettings.activePeriod = trimmedNewName;
            }

            saveSettings();
            saveAllData(true);
            setupPeriodSelector();
            renderPeriodsList();
            showMessage('Periodo renombrado con éxito.', 'success');
        }
        
        let genericConfirmCallback = null;
        const genericConfirmModal = document.getElementById('genericConfirmModal');

        function showGenericConfirmModal(title, text, onConfirm) {
            document.getElementById('genericConfirmTitle').textContent = title;
            document.getElementById('genericConfirmText').textContent = text;
            genericConfirmCallback = onConfirm;
            genericConfirmModal.classList.add('active');
        }

        document.getElementById('confirmGenericBtn').addEventListener('click', () => {
            if (typeof genericConfirmCallback === 'function') {
                genericConfirmCallback();
            }
            genericConfirmModal.classList.remove('active');
        });

        function deletePeriod(periodName) {
            if (appSettings.periods.length <= 1) {
                showMessage('Debe haber al menos un periodo.', 'error');
                return;
            }
            
            showGenericConfirmModal(
                'Confirmar Borrado de Periodo',
                `¿Estás seguro de que quieres borrar el periodo "${periodName}"? Todos los datos asociados se perderán de forma permanente.`,
                () => {
                    appSettings.periods = appSettings.periods.filter(p => p !== periodName);
                    delete gradesData[periodName];
                    if (activePeriod === periodName) {
                        appSettings.activePeriod = appSettings.periods[0];
                        activePeriod = appSettings.periods[0];
                    }
                    saveSettings();
                    saveAllData(); // Full save and rerender
                    setupPeriodSelector();
                    renderPeriodsList();
                }
            );
        }

        document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            appSettings.professor = document.getElementById('professorNameInput').value;
            appSettings.subject = document.getElementById('subjectNameInput').value;
            const cog = parseInt(document.getElementById('cognitivePercentage').value);
            const proc = parseInt(document.getElementById('proceduralPercentage').value);
            const att = parseInt(document.getElementById('attitudinalPercentage').value);

            if (cog + proc + att !== 100) {
                showMessage('La suma de los porcentajes debe ser 100.', 'error');
                return;
            }

            appSettings.percentages.cognitive = cog;
            appSettings.percentages.procedural = proc;
            appSettings.percentages.attitudinal = att;
            
            saveSettings();
            setupPeriodSelector();
            settingsModal.classList.remove('active');
            renderTable();
        });
        
        function showCourseManagementModal() {
            document.getElementById('courseManagementTitle').textContent = activeCourse;
            renderStudentManagementList();
            courseManagementModal.classList.add('active');
        }

        function renderStudentManagementList() {
            const studentListDiv = document.getElementById('studentManagementList');
            studentListDiv.innerHTML = '';
            const students = allStudentsData[activeCourse] || [];
            students.forEach((student, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-1';
                div.innerHTML = `
                    <input type="text" value="${student}" class="search-box w-full" onchange="updateStudentName(${index}, this.value)">
                    <button class="text-red-500 hover:text-red-700 text-xl ml-2" onclick="deleteStudent(${index})">&times;</button>
                `;
                studentListDiv.appendChild(div);
            });
        }
        
        document.getElementById('addStudentBtn').addEventListener('click', () => {
            const newStudentNameInput = document.getElementById('newStudentName');
            const newStudentName = formatStudentName(newStudentNameInput.value);
            if (newStudentName) {
                if (!allStudentsData[activeCourse]) {
                    allStudentsData[activeCourse] = [];
                }
                allStudentsData[activeCourse].push(newStudentName);
                allStudentsData[activeCourse].sort((a, b) => a.localeCompare(b));
                newStudentNameInput.value = '';
                renderStudentManagementList();
                saveAllData();
            }
        });

        function updateStudentName(index, newName) {
            const oldName = allStudentsData[activeCourse][index];
            const formattedNewName = formatStudentName(newName);
            if (formattedNewName && oldName !== formattedNewName) {
                allStudentsData[activeCourse][index] = formattedNewName;
                allStudentsData[activeCourse].sort((a, b) => a.localeCompare(b));
                
                Object.keys(gradesData).forEach(period => {
                    if (gradesData[period][activeCourse] && gradesData[period][activeCourse][oldName]) {
                        gradesData[period][activeCourse][formattedNewName] = gradesData[period][activeCourse][oldName];
                        delete gradesData[period][activeCourse][oldName];
                    }
                });
                
                saveAllData();
                renderStudentManagementList();
            } else {
                 renderStudentManagementList();
            }
        }
        
        function deleteStudent(index) {
            const studentNameToDelete = allStudentsData[activeCourse][index];
            allStudentsData[activeCourse].splice(index, 1);

            Object.keys(gradesData).forEach(period => {
                if (gradesData[period][activeCourse] && gradesData[period][activeCourse][studentNameToDelete]) {
                    delete gradesData[period][activeCourse][studentNameToDelete];
                }
            });

            saveAllData();
            renderStudentManagementList();
        }

        function showStudentReportModal(student) {
            ensureStudentData(activePeriod, activeCourse, student);
            const studentData = gradesData[activePeriod][activeCourse][student];
            const def = calculateDef(studentData.grades);
            const nivel = determineNivel(def);
            const attendance = calculateAttendanceSummary(studentData.attendance);

            let obsHTML = 'Sin observaciones registradas.';
            const observations = studentData.observations || [];
            if (observations.length > 0) {
                observations.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                obsHTML = '<ul>' + observations.map(obs => {
                    const obsDate = new Date(obs.timestamp);
                    const formattedDate = obsDate.toLocaleString('es-CO', { dateStyle: 'full', timeStyle: 'short' });
                    return `<li class="mb-2"><strong class="font-semibold">${formattedDate}:</strong><p class="pl-4 whitespace-normal">${obs.text.replace(/\n/g, '<br>')}</p></li>`;
                }).join('') + '</ul>';
            }
            
            const reportContent = document.getElementById('studentReportContent');
            reportContent.innerHTML = `
                <div class="p-4">
                    <h3 class="text-2xl font-bold text-center mb-4">Informe Individual del Estudiante</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm mb-4">
                        <p><strong>Estudiante:</strong> ${student}</p>
                        <p><strong>Curso:</strong> ${activeCourse}</p>
                        <p><strong>Periodo:</strong> ${activePeriod}</p>
                        <p><strong>Docente:</strong> ${appSettings.professor}</p>
                        <p><strong>Asignatura:</strong> ${appSettings.subject}</p>
                        <p><strong>Fecha del Informe:</strong> ${new Date().toLocaleDateString('es-CO')}</p>
                    </div>
                    
                    <hr class="my-4">
                    <h4 class="text-lg font-bold">Resumen de Calificaciones</h4>
                    <table class="w-full text-left my-2 border-collapse">
                      <thead>
                        <tr class="border-b">
                          <th class="p-2">Componente</th><th class="p-2">N1</th><th class="p-2">N2</th><th class="p-2">N3</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr class="border-b">
                           <td class="p-2 font-semibold">Cognitivo (${appSettings.percentages.cognitive}%)</td>
                           <td class="p-2">${studentData.grades?.cognitivoC1 || 'N/A'}</td>
                           <td class="p-2">${studentData.grades?.cognitivoC2 || 'N/A'}</td>
                           <td class="p-2">${studentData.grades?.cognitivoC3 || 'N/A'}</td>
                        </tr>
                        <tr class="border-b">
                           <td class="p-2 font-semibold">Procedimental (${appSettings.percentages.procedural}%)</td>
                           <td class="p-2">${studentData.grades?.procedimentalP1 || 'N/A'}</td>
                           <td class="p-2">${studentData.grades?.procedimentalP2 || 'N/A'}</td>
                           <td class="p-2">${studentData.grades?.procedimentalP3 || 'N/A'}</td>
                        </tr>
                        <tr>
                           <td class="p-2 font-semibold">Actitudinal (${appSettings.percentages.attitudinal}%)</td>
                           <td class="p-2">${studentData.grades?.actitudinalA1 || 'N/A'}</td>
                           <td class="p-2">${studentData.grades?.actitudinalA2 || 'N/A'}</td>
                           <td class="p-2">${studentData.grades?.actitudinalA3 || 'N/A'}</td>
                        </tr>
                      </tbody>
                    </table>
                    <div class="text-right font-bold text-lg my-4">Definitiva: ${def} (Nivel ${nivel})</div>
                    
                    <hr class="my-4">
                    <h4 class="text-lg font-bold">Resumen de Asistencia</h4>
                    <p>Asistencias: ${attendance.attended} | Ausencias: ${attendance.absent} | Excusas: ${attendance.excused}</p>
                    
                    <hr class="my-4">
                    <h4 class="text-lg font-bold">Historial de Observaciones</h4>
                    <div class="mt-2 text-sm">${obsHTML}</div>
                </div>
            `;
            studentReportModal.classList.add('active');
        }

        document.getElementById('printStudentReportBtn').addEventListener('click', () => {
            window.print();
        });


        window.onload = () => {
            try {
                applyTheme(localStorage.getItem('darkMode') === 'true');
                loadSettings();
                loadAllData();
                for (const course in allStudentsData) {
                    if (Array.isArray(allStudentsData[course])) {
                        allStudentsData[course] = allStudentsData[course]
                            .map(student => formatStudentName(student))
                            .sort((a, b) => a.localeCompare(b));
                    }
                }
                setupPeriodSelector();
                generateTabs();
                const dayMap = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                const todayIndex = new Date().getDay();
                const todayName = dayMap[todayIndex === 0 || todayIndex === 6 ? 1 : todayIndex];
                const initialCourse = dailySchedule[todayName]?.[0] || Object.values(dailySchedule)[0]?.[0] || Object.keys(allStudentsData)[0];
                switchCourse(initialCourse);
            } catch (error) {
                console.error("Error during page initialization:", error);
                document.body.innerHTML = `<div style="background:#fff;color:#b71c1c;padding:20px;text-align:center;font-family:sans-serif;height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;"><h1>Ocurrió un error al cargar la aplicación</h1><p>Intenta limpiar la caché y los datos del sitio antes de volver a cargar la página.</p></div>`;
            }
        };
    </script>
</body>
</html>

